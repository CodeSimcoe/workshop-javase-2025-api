<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Par Clément de Tastes et J.M. Doudoux">
<link rel="icon" type="image/x-icon" href="favicon.ico">
<title>Workshop Java SE en 2025 : les nouvelles API</title>
<link rel="stylesheet" href="./styles/styles.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="./styles/rouge-github.css">
<script src="script/clipboard.min.js"></script>
<style>
    .listingblock:hover .clipboard {
        display: block;
    }

    .clipboard {
        display: none;
        border: 0;
        font-size: .75em;
        text-transform: uppercase;
        font-weight: 500;
        padding: 6px;
        color: #999;
        position: absolute;
        top: .425rem;
        right: .5rem;
        background: transparent;
    }

    code + .clipboard {
        top: 2rem !important;
    }

    .clipboard:hover, .clipboard:focus, .clipboard:active {
        outline: 0;
        background-color: #eee9e6;
    }
</style>
<script >
    window.onload = function() {
        // var pre = document.getElementsByTagName('pre');
        var pre = document.querySelectorAll("pre.rouge");
        for (var i = 0; i < pre.length; i++) {
            var b = document.createElement('button');
            b.className = 'clipboard';
            b.textContent = 'Copier';
            if (pre[i].childNodes.length === 1 && pre[i].childNodes[0].nodeType === 3) {
                var div = document.createElement('div');
                div.textContent = pre[i].textContent;
                pre[i].textContent = '';
                pre[i].appendChild(div);
            }
            pre[i].appendChild(b);
        }
        var clipboard = new ClipboardJS('.clipboard', {
           target: function(b) {
                var p = b.parentNode;
                if (p.className.includes("rouge highlight")) {
                    var elems = p.getElementsByTagName("code");
                    if (elems.length > 0)
                        return elems[0];
                }
                return p.childNodes[0];
            }
        });
        clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.textContent = 'Copié';
            setTimeout(function() {
                e.trigger.textContent = 'Copier';
            }, 2000);
        });
        clipboard.on('error', function(e) {
            console.error('Action:', e.action, e);
            console.error('Trigger:', e.trigger);
        });
    };
</script>
</head>
<body id="_les_évolutions_dans_les_api" class="book toc2 toc-left">
<div id="header">
<h1>Workshop Java SE en 2025 : les nouvelles API</h1>
<div class="details">
<span id="author" class="author">Par Clément de Tastes et J.M. Doudoux</span><br>
<span id="revnumber">version 2025.1-SNAPSHOT,</span>
<span id="revdate">2025-04-07</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table des matières</div>
<p><span class="toc-root"><a href="index.html">Workshop Java SE en 2025 : les nouvelles API</a></span></p><ul class="sectlevel1">
<li><a href="introduction.html">1. Introduction</a>
</li>
<li><a href="requis.html">2. Les requis</a>
</li>
<li><a href="deroulement.html">3. Le déroulement du workshop</a>
</li>
<li><a href="_les_évolutions_dans_les_api.html"><span class="toc-current">4. Les évolutions dans les API</span></a>
<ul class="sectlevel2">
<li><a href="_les_évolutions_dans_les_api.html#_les_évolutions_dans_lapi_stream">4.1. Les évolutions dans l&#8217;API Stream</a>
<ul class="sectlevel3">
<li><a href="_les_évolutions_dans_les_api.html#_lab_lopération_streamtolist">4.1.1. Lab : l&#8217;opération Stream::toList()</a>
</li>
<li><a href="_les_évolutions_dans_les_api.html#_lab_lopération_streammapmulti">4.1.2. Lab : l&#8217;opération Stream::mapMulti</a>
</li>
<li><a href="_les_évolutions_dans_les_api.html#_lab_les_stream_gatherers">4.1.3. Lab : les Stream Gatherers</a>
</li>
</ul>
</li>
<li><a href="_les_évolutions_dans_les_api.html#_les_nouvelles_api">4.2. Les nouvelles API</a>
<ul class="sectlevel3">
<li><a href="_les_évolutions_dans_les_api.html#_lab_lapi_sequenced_collections">4.2.1. Lab : l&#8217;API Sequenced Collections</a>
</li>
<li><a href="_les_évolutions_dans_les_api.html#_lab_lapi_foreign_function_memory">4.2.2. Lab : l&#8217;API Foreign Function &amp; Memory</a>
</li>
<li><a href="_les_évolutions_dans_les_api.html#class-file-api">4.2.3. Lab : l&#8217;API Class-File</a>
</li>
</ul>
</li>
<li><a href="_les_évolutions_dans_les_api.html#_le_formatage_et_le_parsing_de_données">4.3. Le formatage et le parsing de données</a>
<ul class="sectlevel3">
<li><a href="_les_évolutions_dans_les_api.html#_lab_le_formatage_des_nombres_compacts">4.3.1. Lab : le formatage des nombres compacts</a>
</li>
<li><a href="_les_évolutions_dans_les_api.html#_lab_le_formatage_des_listes_de_chaînes">4.3.2. Lab : le formatage des listes de chaînes</a>
</li>
</ul>
</li>
<li><a href="_les_évolutions_dans_les_api.html#_la_programmation_parallèle_et_concurrente">4.4. La programmation parallèle et concurrente</a>
<ul class="sectlevel3">
<li><a href="_les_évolutions_dans_les_api.html#threads-virtuels">4.4.1. Lab : les threads virtuels</a>
</li>
<li><a href="_les_évolutions_dans_les_api.html#structured-concurrency">4.4.2. Lab : la Structured Concurrency</a>
</li>
<li><a href="_les_évolutions_dans_les_api.html#_lab_les_scoped_values">4.4.3. Lab : les Scoped Values</a>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="conclusion.html">5. Conclusion</a>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_les_évolutions_dans_les_api"><a class="anchor" href="#_les_évolutions_dans_les_api"></a>4. Les évolutions dans les API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Les API du JDK connaissent régulièrement, au fur et à mesure des versions de Java, des ajouts et des évolutions.</p>
</div>
<div class="sect2">
<h3 id="_les_évolutions_dans_lapi_stream"><a class="anchor" href="#_les_évolutions_dans_lapi_stream"></a>4.1. Les évolutions dans l&#8217;API Stream</h3>
<div class="paragraph">
<p>Depuis son introduction dans le JDK 8, l&#8217;API Stream a connu plusieurs améliorations.</p>
</div>
<div class="sect3">
<h4 id="_lab_lopération_streamtolist"><a class="anchor" href="#_lab_lopération_streamtolist"></a>4.1.1. Lab : l&#8217;opération Stream::toList()</h4>
<div class="paragraph">
<p>L&#8217;obtention d&#8217;une List contenant des éléments issus des traitements d&#8217;un Stream est courant.</p>
</div>
<div class="paragraph">
<p>Avant Java 16, il faut utiliser l&#8217;API Collector en invoquant la méthode <code>collect()</code> en lui passant en paramètre une instance de type <code>Collector</code>. Le JDK en propose deux dans les fabriques de la classe <code>Collectors</code> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Collectors.toList()</code> : depuis Java 8, rassemble les éléments du <code>Stream</code> dans une <code>List</code></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">couleurs</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"rouge"</span><span class="o">,</span><span class="s">"vert"</span><span class="o">,</span><span class="s">"bleu"</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comme le précice la documentation, <code>toList()</code> renvoie un <code>Collector</code> qui accumule les éléments en entrée dans une nouvelle <code>List</code>. Il n&#8217;y a aucune
garantie sur le type, la mutabilité, la sérialisation ou le thread safety de la <code>List</code> renvoyée. Si un contrôle plus poussé sur la liste renvoyée est nécessaire, il faut utiliser <code>toCollection(Supplier)</code>, par exemple <code>toCollection(ArrayList::new)</code>.</p>
</div>
</li>
<li>
<p><code>Collectors.toUnmodifiableList()</code> : rassemble les éléments du <code>Stream</code> dans une <code>List</code> immuable, dans le JDK 22 l&#8217;implémentation est de type <code>java.util.ImmutableCollections.ListN</code></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">couleurs</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"rouge"</span><span class="o">,</span><span class="s">"vert"</span><span class="o">,</span><span class="s">"bleu"</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toUnmodifiableList</span><span class="o">());</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le JDK 16 propose l&#8217;opération terminale <code>toList()</code> qui rassemble les éléments du <code>Stream</code> dans une <code>List</code> immuable de type <code>java.util.ImmutableCollections.ListN</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JDK</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard en Java 16</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>L&#8217;opération <code>Stream.toList()</code> présente deux avantages :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>réduction de la verbosité</p>
</li>
<li>
<p>requière moins de ressources car son implémentation est indépendante de l&#8217;interface <code>Collector</code>. Elle accumule les éléments du flux directement dans la liste.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>obtenirListe()</code> de la classe <code>fr.sciam.workshop.javase.streamtolist.MainStreamToList</code> pour obtenir une <code>List</code> des éléments d&#8217;un <code>Stream</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">obtenirListe</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">couleurs</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"rouge"</span><span class="o">,</span><span class="s">"vert"</span><span class="o">,</span><span class="s">"bleu"</span><span class="o">).</span><span class="na">toList</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">couleurs</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainStreamToList</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Obtenir liste
[rouge, vert, bleu]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>Stream.toList()</code> renvoie une <code>List</code> immuable : il n&#8217;est donc pas possible d&#8217;ajouter ou de supprimer des éléments de la <code>List</code> obtenue ni d&#8217;appliquer des opérations mutables sur la collection. Toute opération de type <code>add()</code>, <code>sort()</code>, … sur cette <code>List</code> lève une exception de type <code>java.lang.UnsupportedOperationException</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>modifierListe()</code> de la classe <code>MainStreamToList</code> pour tenter d&#8217;ajouter un nouvel élément dans la <code>List</code> retournée par <code>Stream::toList</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">modifierListe</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">couleurs</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"rouge"</span><span class="o">,</span><span class="s">"vert"</span><span class="o">,</span><span class="s">"bleu"</span><span class="o">).</span><span class="na">toList</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">couleurs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"jaune"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">UnsupportedOperationException</span> <span class="n">uoe</span> <span class="o">)</span> <span class="o">{</span>
      <span class="n">uoe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainStreamToList</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Modifier liste
java.lang.UnsupportedOperationException
	at java.base/java.util.ImmutableCollections.uoe(ImmutableCollections.java:142)
	at java.base/java.util.ImmutableCollections$AbstractImmutableCollection.add(ImmutableCollections.java:147)
	at fr.sciam.workshop.javase.streamtolist.MainStreamToList.modifierListe(MainStreamToList.java:24)
	at fr.sciam.workshop.javase.streamtolist.MainStreamToList.main(MainStreamToList.java:12)</pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_le_support_des_éléments_null"><a class="anchor" href="#_le_support_des_éléments_null"></a>4.1.1.1. Le support des éléments <code>null</code></h5>
<div class="paragraph">
<p>Bien que <code>Stream.toList()</code> et <code>Collectors.toUnmodifiableList()</code> produisent une <code>List</code> non modifiable, leur support des éléments <code>null</code> est différent.</p>
</div>
<div class="paragraph">
<p><code>Collectors.toList()</code> et <code>Stream.toList()</code> autorisent les éléments <code>null</code>, alors que <code>Collectors.toUnmodifiableList()</code> n&#8217;autorise pas les éléments null et lève une exception de type <code>NullPointerException</code> si des éléments du Stream sont <code>null</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>gererNull()</code> de la classe <code>MainStreamToList</code> pour tenter d&#8217;obtenir des <code>List</code> des éléments d&#8217;un <code>Stream</code>, contenant des éléments <code>null</code>, obtenues en invoquant <code>Collectors.toList()</code>, <code>Collectors.toUnmodifiableList()</code> et <code>Stream.toList()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">gererNull</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">liste1</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"liste1 : "</span> <span class="o">+</span> <span class="n">liste1</span><span class="o">);</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">liste2</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toUnmodifiableList</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"liste2 : "</span> <span class="o">+</span> <span class="n">liste2</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NullPointerException</span> <span class="n">npe</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">npe</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">liste3</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span><span class="kc">null</span><span class="o">).</span><span class="na">toList</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"liste3 : "</span> <span class="o">+</span> <span class="n">liste3</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainStreamToList</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Gestion des null
liste1 : [null, null]
java.lang.NullPointerException
	at java.base/java.util.Objects.requireNonNull(Objects.java:220)
	at java.base/java.util.ImmutableCollections.listFromTrustedArray(ImmutableCollections.java:215)
	at java.base/java.util.ImmutableCollections$Access$1.listFromTrustedArray(ImmutableCollections.java:124)
	at java.base/java.util.stream.Collectors.lambda$toUnmodifiableList$6(Collectors.java:266)
	at java.base/java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:706)
	at fr.sciam.workshop.javase.streamtolist.MainStreamToList.gererNull(MainStreamToList.java:39)
	at fr.sciam.workshop.javase.streamtolist.MainStreamToList.main(MainStreamToList.java:15)
liste3 : [null, null]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_le_support_du_polymorphisme"><a class="anchor" href="#_le_support_du_polymorphisme"></a>4.1.1.2. Le support du polymorphisme</h5>
<div class="paragraph">
<p>Une autre différence concerne le polymorphisme des éléments de la List retournée : <code>collect(Collectors.toList())</code> et <code>toList()</code> se comportent différemment en ce qui concerne la compatibilité des sous-types des éléments des <code>List</code> retournées.</p>
</div>
<div class="paragraph">
<p>La signature de la méthode <code>Stream::collect</code> est : <code>&lt;R, A&gt; R collect(Collector&lt;? super T, A, R&gt; collector)</code>.
Comme le type générique des éléments traités est <code>? super T</code>, il est possible d&#8217;utiliser un super type de <code>T</code> qui sera le type générique de la <code>List</code> retournée.</p>
</div>
<div class="paragraph">
<p>La signature de la méthode <code>Stream::toList</code> est : <code>default List&lt;T&gt; toList()</code>. Le type générique de la <code>List</code> retournée doit obligatoirement être celui du <code>Stream</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>gererPolymorphisme()</code> de la classe <code>MainStreamToList</code> pour obtenir des <code>List</code> des éléments d&#8217;un <code>Stream</code> en invoquant <code>Collectors.toList()</code> et <code>Stream.toList()</code>, dont le type générique est un super-type des éléments.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">gererPolymorphisme</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// Compile sans erreur</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">CharSequence</span><span class="o">&gt;</span> <span class="n">couleursOk</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"rouge"</span><span class="o">,</span> <span class="s">"vert"</span><span class="o">,</span> <span class="s">"bleu"</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Number</span><span class="o">&gt;</span> <span class="n">nombresOk</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

    <span class="c1">// Erreur de compilation</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">CharSequence</span><span class="o">&gt;</span> <span class="n">couleurs</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"rouge"</span><span class="o">,</span> <span class="s">"vert"</span><span class="o">,</span> <span class="s">"bleu"</span><span class="o">).</span><span class="na">toList</span><span class="o">();</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Number</span><span class="o">&gt;</span> <span class="n">nombres</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">).</span><span class="na">toList</span><span class="o">();</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">couleurs</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">nombres</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Le code de la classe ne se compile pas avec deux erreurs.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>fr\sciam\workshop\javase\streamtolist\MainStreamToList.java:55: error: incompatible types: List&lt;String&gt; cannot be converted to List&lt;CharSequence&gt;
    List&lt;CharSequence&gt; couleurs = Stream.of("rouge", "vert", "bleu").toList();
                                                                           ^
fr\sciam\workshop\javase\streamtolist\MainStreamToList.java:56: error: incompatible types: List&lt;Integer&gt; cannot be converted to List&lt;Number&gt;
    List&lt;Number&gt; nombres = Stream.of(1, 2, 3).toList();
                                                     ^
2 errors</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Il existe au moins 2 solutions pour corriger l&#8217;erreur de compilation :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>convertir explicitement vers le type cible dans le pipeline d&#8217;opération du Stream</p>
</li>
<li>
<p>autoriser les sous-types dans la collection retournée</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>gererPolymorphisme()</code> de la classe <code>MainStreamToList</code> pour mettre en œuvre ces deux solutions afin de corriger les erreurs de compilation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">gererPolymorphisme</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// Compile sans erreur</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">CharSequence</span><span class="o">&gt;</span> <span class="n">couleursOk</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"rouge"</span><span class="o">,</span> <span class="s">"vert"</span><span class="o">,</span> <span class="s">"bleu"</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Number</span><span class="o">&gt;</span> <span class="n">nombresOk</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

    <span class="c1">// Erreur de compilation</span>
    <span class="c1">// List&lt;CharSequence&gt; couleurs = Stream.of("rouge", "vert", "bleu").toList();</span>
    <span class="c1">// List&lt;Number&gt; nombres = Stream.of(1, 2, 3).toList();</span>
    <span class="nc">List</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">CharSequence</span><span class="o">&gt;</span> <span class="n">couleurs</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"rouge"</span><span class="o">,</span> <span class="s">"vert"</span><span class="o">,</span> <span class="s">"bleu"</span><span class="o">).</span><span class="na">toList</span><span class="o">();</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Number</span><span class="o">&gt;</span> <span class="n">nombres</span> <span class="o">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="nc">Number</span><span class="o">.</span><span class="na">class</span><span class="o">::</span><span class="n">cast</span><span class="o">).</span><span class="na">toList</span><span class="o">();</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">couleurs</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">nombres</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainStreamToList</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Gestion du polymorphisme
[rouge, vert, bleu]
[1, 2, 3]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Il est donc important d&#8217;être attentif lors de la migration de code de Java 8 vers Java 10 ou Java 16. L&#8217;utilisation de <code>Stream.toList()</code> à la place de <code>Collectors.toList()</code> ou <code>Collectors.toUnmodifiableList()</code> n&#8217;est pas sans conséquence potentielle.</p>
</div>
<div class="paragraph">
<p>Le tableau ci-dessous résume les différences entre <code>Stream.collect(Collectors.toList())</code>, <code>Stream.collect(Collectors.toUnmodifiableList())</code> et <code>Stream.toList()</code> :</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Methode</th>
<th class="tableblock halign-center valign-top">Garantie d&#8217;immutabilité</th>
<th class="tableblock halign-center valign-top">Autorise les <code>null</code></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>collect(toList())</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Non</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Oui</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>collect(toUnmodifiableList())</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Oui</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Non</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>toList()</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Oui</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Oui</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>&nbsp;</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lab_lopération_streammapmulti"><a class="anchor" href="#_lab_lopération_streammapmulti"></a>4.1.2. Lab : l&#8217;opération Stream::mapMulti</h4>
<div class="paragraph">
<p>Initialement, l&#8217;API <code>Stream</code> propose l&#8217;opération intermédiaire <code>flatMap()</code> pour permettre de transformer un élément du <code>Stream</code> vers zéro, un ou plusieurs éléments en lui appliquant une <code>Function</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JDK</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard en Java 16</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Le JDK 16 propose l&#8217;opération intermédiaire <code>mapMulti()</code> de l&#8217;interface <code>Stream</code> dont l&#8217;objectif est similaire à la méthode <code>flatMap()</code> : elle applique une transformation aux éléments du <code>Stream</code> générant pour chacun 0 à N éléments et les aplatit dans un nouveau <code>Stream</code> en résultat.</p>
</div>
<div class="paragraph">
<p>La méthode <code>mapMulti()</code> propose une autre façon de le faire, où l&#8217;élément est fourni à un <code>Consumer</code>. La signature de la méthode est :</p>
</div>
<div class="paragraph">
<p><code>default &lt;R&gt; Stream&lt;R&gt; mapMulti(BiConsumer&lt;? super T,? super Consumer&lt;R&gt;&gt; mapper)</code></p>
</div>
<div class="paragraph">
<p>Le type <code>R</code> permet de préciser le type des éléments résultant de la transformation.</p>
</div>
<div class="paragraph">
<p>La méthode <code>mapMulti()</code> attend en paramètre un <code>BiConsumer</code> dont l&#8217;implémentation va appliquer une transformation sur l&#8217;élément en cours de traitement pour générer zéro à N éléments en résultats. Ces éléments sont consommés par le <code>Consumer</code> fourni en paramètre pour stocker les éléments dans un buffer.</p>
</div>
<div class="paragraph">
<p>Elle retourne, pour chaque élément du <code>Stream</code>, un nouveau <code>Stream</code> qui contient zéro ou plusieurs éléments de type <code>R</code>.</p>
</div>
<div class="sect4">
<h5 id="_lutilisation_de_mapmulti_pour_une_transformation_1_1"><a class="anchor" href="#_lutilisation_de_mapmulti_pour_une_transformation_1_1"></a>4.1.2.1. L&#8217;utilisation de <code>mapMulti()</code> pour une transformation 1-1</h5>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier la méthode <code>transformer1a1()</code> de la classe fr.sciam.workshop.javase.mapmulti.MainMapMulti` pour utiliser <code>mapMulti()</code> sur un <code>Stream</code> à partir des <code>fruits</code> pour les convertir en majuscules.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="plain">  private static void transformer1a1() {
    System.out.println("Fruits en maj : ");
    fruits.stream()
          .mapMulti((fruit, mapper) -&gt; {
            mapper.accept(fruit.toUpperCase());
          })
          .forEach(System.out::println);
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainMapMulti</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mapMulti 1 a 1
Fruits en maj :
ABRICOT
CITRON
KIWI
LITCHI</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lutilisation_de_mapmulti_pour_une_transformation_0_1"><a class="anchor" href="#_lutilisation_de_mapmulti_pour_une_transformation_0_1"></a>4.1.2.2. L&#8217;utilisation de <code>mapMulti()</code> pour une transformation 0-1</h5>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier la méthode <code>transformer0a1()</code> pour utiliser <code>mapMulti()</code> sur un <code>Stream</code> à partir des <code>fruits</code> afin de ne conserver que ceux ayant 6 lettres et convertis en majuscules.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="plain">  private static void transformer0a1() {
    System.out.println("Fruits à 6 lettres en maj : ");
    fruits.stream()
          .mapMulti((fruit, mapper) -&gt; {
            if (fruit.length() == 6)
              mapper.accept(fruit.toUpperCase());
          })
          .forEach(System.out::println);
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MapMulti</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mapMulti 0 a 1
Fruits à 6 lettres en maj :
CITRON
LITCHI</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
cette opération aurait pu être réalisée en utilisant les opérations <code>filter()</code> et <code>map()</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_lutilisation_de_mapmulti_pour_une_transformation_1_n"><a class="anchor" href="#_lutilisation_de_mapmulti_pour_une_transformation_1_n"></a>4.1.2.3. L&#8217;utilisation de <code>mapMulti()</code> pour une transformation 1-N</h5>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier la méthode <code>transformer1aN()</code> pour utiliser <code>mapMulti()</code> sur un <code>Stream</code> à partir des <code>fruits</code> afin de produire en résultat le fruit et le fruit concaténé à " bien mûr".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="plain">  private static void transformer1aN() {
    System.out.println("Fruits avec bien mûr : ");
    fruits.stream()
          .mapMulti((fruit, mapper) -&gt; {
            mapper.accept(fruit);
            mapper.accept(fruit + " bien mûr");
          })
          .forEach(System.out::println);
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainMapMulti</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mapMulti 1 a N
Fruits avec bien mûr :
Abricot
Abricot bien mûr
Citron
Citron bien mûr
Kiwi
Kiwi bien mûr
Litchi
Litchi bien mûr</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lutilisation_de_mapmulti_pour_une_transformation_vers_un_autre_type"><a class="anchor" href="#_lutilisation_de_mapmulti_pour_une_transformation_vers_un_autre_type"></a>4.1.2.4. L&#8217;utilisation de <code>mapMulti()</code> pour une transformation vers un autre type</h5>
<div class="paragraph">
<p>Dans les transformations précédentes, le type des instances retournées est <code>Object</code> car le compilateur n&#8217;est pas mesure d&#8217;inférer le type à cause de la signature de la méthode <code>mapMulti()</code>. Si le type n&#8217;est pas <code>Object</code>, il faut préciser le type générique à l&#8217;invocation de la méthode.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier la méthode <code>transformerVersAutreType()</code> pour utiliser <code>mapMulti()</code> sur un <code>Stream</code> à partir des <code>fruits</code> afin de produire une <code>Liste&lt;Tarte&gt;</code> avec chacun des fruits.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="plain">  private static void transformerVersAutreType() {
    record Tarte(String fruit) {
    }

    System.out.println("Tartes aux fruits : ");
    List&lt;Tarte&gt; tartes = fruits.stream()
        .mapMulti((fruit, mapper) -&gt; {
          mapper.accept(new Tarte(fruit));
        })
        .collect(Collectors.toList());
    System.out.println(tartes);
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le code ne compile pas avec l&#8217;erreur « <code>Type mismatch: cannot convert from List&lt;Object&gt; to List&lt;Tarte&gt;</code> »</p>
</div>
<div class="paragraph">
<p>Modifier la méthode <code>transformerVersAutreType()</code> pour ajouter le type générique avant l&#8217;invocation de la méthode <code>mapMulti()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="plain">  private static void transformerVersAutreType() {
    record Tarte(String fruit) {
    }

    System.out.println("Tartes aux fruits : ");
    List&lt;Tarte&gt; tartes = fruits.stream()
        .&lt;Tarte&gt;mapMulti((fruit, mapper) -&gt; {
          mapper.accept(new Tarte(fruit));
        })
        .collect(Collectors.toList());
    System.out.println(tartes);
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainMapMulti</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mapMulti vers autre type
Tartes aux fruits :
[Tarte[fruit=Abricot], Tarte[fruit=Citron], Tarte[fruit=Kiwi], Tarte[fruit=Litchi]]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>L&#8217;opération <code>mapMulti()</code> peut offrir de meilleures performances dans certaines circonstances. Les traitements internes de <code>mapMulti()</code> permettent d&#8217;éviter la création d&#8217;un nouveau <code>Stream</code> pour chaque élément traité.</p>
</div>
<div class="paragraph">
<p>L&#8217;opération <code>flatMap()</code> peut être utilisée comme une opération à usage général alors que <code>mapMulti()</code> est une opération à utiliser dans des cas d&#8217;usage spécifiques.</p>
</div>
<div class="paragraph">
<p>Trois méthodes de l&#8217;interface <code>Stream</code> sont dédiées aux types primitifs <code>int</code>, <code>long</code> et <code>double</code> sont proposées : <code>mapMultiToInt()</code>, <code>mapMultiToLong()</code> et <code>mapMultiToDouble()</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lab_les_stream_gatherers"><a class="anchor" href="#_lab_les_stream_gatherers"></a>4.1.3. Lab : les Stream Gatherers</h4>
<div class="paragraph">
<p>L&#8217;API <code>Stream</code> fournit de nombreuses opérations intermédiaires, telles que <code>map()</code>, <code>filter()</code>, <code>sorted()</code>, <code>distinct()</code>, &#8230;&#8203; permettant de répondre à bon nombre de cas d&#8217;usages.</p>
</div>
<div class="paragraph">
<p>Malgré cette richesse, cela ne couvre pas tous les besoins. Le concept de "gatherer" a pour but de définir ses propres opérations intermédiaires par le biais de l&#8217;opération intermédiaire <code>Stream::gather</code> qui accepte une instance de l&#8217;interface <code>java.util.stream.Gatherer</code>. Ceci de manière analogue à l&#8217;opération terminale <code>Stream::collect</code> qui accepte une instance de l&#8217;interface <code>java.util.stream.Collector</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JDK</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Première preview en Java 22 (<a href="https://openjdk.org/jeps/461">JEP 461</a>)<br>
Seconde preview en Java 23 (<a href="https://openjdk.org/jeps/473">JEP 473</a>)</p>
<p class="tableblock">Standard en Java 24</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JEP</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://openjdk.org/jeps/485">485: Stream Gatherers</a></p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_linterface_java_util_stream_gatherer"><a class="anchor" href="#_linterface_java_util_stream_gatherer"></a>4.1.3.1. L&#8217;interface <code>java.util.stream.Gatherer</code></h5>
<div class="paragraph">
<p>Un <code>Gatherer</code> a pour but de représenter quasiment tout type d&#8217;opération intermédiaire, et il peut être :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>exécuté en séquentiel ou en parallèle</p>
</li>
<li>
<p>stateless ou stateful</p>
</li>
<li>
<p>court-circuit (peut s&#8217;arrêter avant la fin) ou greedy (traite forcément tous les éléments)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;interface <code>Gatherer</code> définit 4 opérations qui fonctionnent de concert, selon les besoins :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>default Supplier&lt;A&gt; initializer()</code> : optionnelle, permet de fournir un objet pour stocker un état privé qui pourra être utilisé lors de la consommation des éléments du flux.</p>
</li>
<li>
<p><code>Integrator&lt;A, T, R&gt; integrator()</code> : fournit une instance d'<code>Integrator</code>, interface fonctionnelle qui définit la façon dont sont intégrés les éléments du flux entrant vers le flux de sortie, en tenant éventuellement compte de l&#8217;état privé.</p>
</li>
<li>
<p><code>default BinaryOperator&lt;A&gt; combiner()</code> : optionnelle, combine deux états dans le cas d&#8217;un <code>Stream</code> parallèle.</p>
</li>
<li>
<p><code>default BiConsumer&lt;A, Downstream&lt;? super R&gt;&gt; finisher()</code> : optionnelle, invoquée lorsqu&#8217;il n&#8217;y a plus d&#8217;éléments à traiter. Elle peut utiliser l&#8217;état privé pour éventuellement, émettre des éléments supplémentaires vers le flux de sortie.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_les_fabriques_de_gatherer"><a class="anchor" href="#_les_fabriques_de_gatherer"></a>4.1.3.2. Les fabriques de <code>Gatherer</code></h5>
<div class="paragraph">
<p>L&#8217;interface <code>Gatherer</code> fournit plusieurs fabriques permettant d&#8217;obtenir une instance de <code>Gatherer</code> à partir d&#8217;une implémentation de tout ou partie des quatre opérations. La fourniture d&#8217;une implémentation d&#8217;un <code>integrator</code> est le minimum requis, les autres opérations étant quant à elles optionnelles.</p>
</div>
<div class="paragraph">
<p>Cette instance de <code>Gatherer</code> peut être :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>parallélisable via les surcharges de <code>Gatherer::of</code></p>
</li>
<li>
<p>séquentielle via les surcharges de <code>Gatherer::ofSequential</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>ofSequential()</code> ne propose pas de surcharge faisant intervenir de <code>combiner</code> car cela est réservé aux <code>Gatherer</code> parallélisables.</p>
</div>
</div>
<div class="sect4">
<h5 id="_la_définition_dun_integrator"><a class="anchor" href="#_la_définition_dun_integrator"></a>4.1.3.3. La définition d&#8217;un <code>Integrator</code></h5>
<div class="paragraph">
<p>Il est possible d&#8217;émettre ou non un ou plusieurs éléments vers le flux de sortie, tout comme d&#8217;interrompre prématurément le traitement avant d&#8217;avoir atteint la fin des éléments. La signature de la méthode est la suivante :</p>
</div>
<div class="paragraph">
<p><code>boolean integrate(A state, T element, Downstream&lt;? super R&gt; downstream)</code></p>
</div>
<div class="paragraph">
<p>Le retour de type booléen indique s&#8217;il faut continuer à traiter de nouveaux éléments ou court-circuiter.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Il est possible de définir avec un <code>Gatherer</code> une des opérations intermédiaires déjà existante de <code>Stream</code>, par exemple <code>Stream::map</code>.
Compléter la méthode <code>definirGathererMapDouble()</code> de la classe <code>fr.sciam.workshop.javase.gatherers.MainGatherers</code> afin qu&#8217;elle retourne une implémentation de <code>Gatherer</code> qui renvoie le double d&#8217;un nombre entier, en utilisant la fabrique <code>Gatherer.of(Integrator&lt;Void, T, R&gt; integrator)</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Gatherer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Void</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">definirGathererMapDouble</span><span class="o">()</span> <span class="o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="k">return</span> <span class="nc">Gatherer</span><span class="o">.</span><span class="na">of</span><span class="o">((</span><span class="n">state</span><span class="o">,</span> <span class="n">element</span><span class="o">,</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="n">downstream</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">element</span> <span class="o">*</span> <span class="mi">2</span><span class="o">);</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">});</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Le type générique <code>Void</code> est utilisé car on ne gère pas d&#8217;état privé</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainGatherers</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Map double
[0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0] -&gt; [0, 2, 2, 4, 6, 10, 16, 26, 42, 2, 0]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Il est possible de ne pas émettre tous les éléments du flux d&#8217;entrée.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>definirGathererMapGrandsDoubles()</code> afin qu&#8217;elle retourne une implémentation de <code>Gatherer</code> qui renvoie le double d&#8217;un nombre entier, mais ce uniquement pour les nombres plus grands que 10.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Gatherer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Void</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">definirGathererMapGrandsDoubles</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Gatherer</span><span class="o">.</span><span class="na">of</span><span class="o">((</span><span class="n">state</span><span class="o">,</span> <span class="n">element</span><span class="o">,</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">element</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">downstream</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">element</span> <span class="o">*</span> <span class="mi">2</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">});</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainGatherers</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Map grands doubles
[0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0] -&gt; [26, 42]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Il est également possible de terminer prématurément, via un "court-circuit" en renvoyant <code>false</code> lorsque l&#8217;on souhaite s&#8217;arrêter.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>definirGathererCourtCircuit()</code> afin qu&#8217;elle retourne une implémentation de <code>Gatherer</code> qui transmet les éléments du flux d&#8217;entrée sans modification, mais qui s&#8217;arrête de traiter les éléments dès lors qu&#8217;une valeur supérieure à 10 est rencontrée.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Gatherer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Void</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">definirGathererCourtCircuit</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Gatherer</span><span class="o">.</span><span class="na">of</span><span class="o">((</span><span class="n">state</span><span class="o">,</span> <span class="n">element</span><span class="o">,</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">element</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">downstream</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">});</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainGatherers</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Court-circuit
[0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0] -&gt; [0, 1, 1, 2, 3, 5, 8]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_la_gestion_dun_état_privé_avec_un_initializer"><a class="anchor" href="#_la_gestion_dun_état_privé_avec_un_initializer"></a>4.1.3.4. La gestion d&#8217;un état privé avec un <code>initializer</code></h5>
<div class="paragraph">
<p>La méthode <code>Gatherer::initializer</code> permet de fournir un objet pour gérer un état privé durant certains traitements du <code>Gatherer</code>, selon les besoins.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>definirGathererSequentielAvecEtat()</code> afin qu&#8217;elle retourne une implémentation de <code>Gatherer</code> séquentiel qui transmet les éléments du flux d&#8217;entrée sans modification, mais qui s&#8217;arrête après avoir traité 5 éléments.
Utiliser la fabrique <code>&lt;T, A, R&gt; Gatherer&lt;T, A, R&gt; ofSequential(Supplier&lt;A&gt; initializer, Integrator&lt;A, T, R&gt; integrator)</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Gatherer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="o">?,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">definirGathererSequentielAvecEtat</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Gatherer</span><span class="o">.</span><span class="na">ofSequential</span><span class="o">(</span>
      <span class="nl">AtomicInteger:</span><span class="o">:</span><span class="k">new</span><span class="o">,</span>
      <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">element</span><span class="o">,</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">downstream</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainGatherers</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Séquentiel avec état
[0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0] -&gt; [0, 1, 1, 2, 3]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lutilisation_dun_finisher"><a class="anchor" href="#_lutilisation_dun_finisher"></a>4.1.3.5. L&#8217;utilisation d&#8217;un <code>finisher</code></h5>
<div class="paragraph">
<p>Le <code>finisher</code> permet de réaliser des traitements une fois tous les éléments du flux d&#8217;entrée consommés, pouvant impliquer l&#8217;état privé ainsi que le <code>Downstream</code> fournis en paramètres.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Un cas d&#8217;usage d&#8217;un <code>Gatherer</code> peut être de regrouper les éléments du flux d&#8217;entrée vers le flux de sortie en lots, par exemple deux par deux.
La définition d&#8217;un <code>finisher</code> est nécessaire, car on voudra émettre le dernier élément seul quand le nombre d&#8217;éléments du flux d&#8217;entrée est impair.</p>
</div>
<div class="paragraph">
<p>Compléter la méthode <code>definirGathererGroupeDeuxParDeux()</code> pour définir un <code>Gatherer</code> séquentiel qui groupe les éléments deux par deux. Utiliser la fabrique <code>Gatherer.ofSequential()</code> qui accepte un <code>initializer</code>, un <code>integrator</code> et un <code>finisher</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Gatherer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="o">?,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">definirGathererGroupeDeuxParDeux</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Gatherer</span><span class="o">.</span><span class="na">ofSequential</span><span class="o">(</span>
      <span class="o">()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;(),</span>
      <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">element</span><span class="o">,</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">state</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">downstream</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">state</span><span class="o">));</span>
          <span class="n">state</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">},</span>
      <span class="o">(</span><span class="n">integers</span><span class="o">,</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">downstream</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">integers</span><span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainGatherers</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Groupe deux par deux
[0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0] -&gt; [[0, 1], [1, 2], [3, 5], [8, 13], [21, 1], [0]]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lutilisation_dun_combiner"><a class="anchor" href="#_lutilisation_dun_combiner"></a>4.1.3.6. L&#8217;utilisation d&#8217;un <code>combiner</code></h5>
<div class="paragraph">
<p>Le <code>Gatherer</code> peut être défini comme étant parallélisable, auquel cas, il faut fournir un <code>combiner</code> qui définit la façon dont sont combinés les états des lots parallèles entre eux.</p>
</div>
<div class="paragraph">
<p>Pour cela, la fabrique <code>Gatherer.of()</code> qui accepte les quatre opérations : <code>initializer</code>, <code>integrator</code>, <code>combiner</code> et <code>finisher</code> est adaptée pour des traitements parallélisés.
Comme c&#8217;est la seule qui accepte un <code>combiner</code>, il est possible de fournir des opérations par défaut pour les opérations qui ne nécessitent pas de comportement spécifique :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Gatherer.defaultInitializer()</code> pour un gatherer sans état (stateless)</p>
</li>
<li>
<p><code>Gatherer.defaultCombiner()</code> pour un gatherer qui ne peut être évalué que séquentiellement (autrement une <code>UnsupportedOperationException</code> est levée)</p>
</li>
<li>
<p><code>Gatherer.defaultFinisher()</code> pour un gatherer qui ne réalise pas de traitement final</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>definirGathererParallelePlusGrandElement()</code> pour définir un <code>Gatherer</code> parallélisable qui permette de trouver le plus grand élément d&#8217;un flux d&#8217;entiers, mais en s&#8217;arrêtant dès lors qu&#8217;on a rencontré un élément supérieur à 10.</p>
</div>
<div class="paragraph">
<p>Utiliser la fabrique <code>Gatherer.of()</code> qui accepte les quatre opérations : <code>initializer</code>, <code>integrator</code>, <code>combiner</code> et <code>finisher</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Gatherer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="o">?,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">definirGathererParallelePlusGrandElement</span><span class="o">()</span> <span class="o">{</span>

    <span class="kd">class</span> <span class="nc">Etat</span> <span class="o">{</span>
      <span class="nc">Integer</span> <span class="n">max</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="nc">Gatherer</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>

      <span class="c1">// Initializer</span>
      <span class="nl">Etat:</span><span class="o">:</span><span class="k">new</span><span class="o">,</span>

      <span class="c1">// Integrator</span>
      <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">element</span><span class="o">,</span> <span class="n">downstream</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>

        <span class="c1">// On sauvegarde l'élément s'il est le plus grand connu</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">max</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">element</span> <span class="o">&gt;</span> <span class="n">state</span><span class="o">.</span><span class="na">max</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">state</span><span class="o">.</span><span class="na">max</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// On court-circuite si l'élément est supérieur à 10</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">max</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">downstream</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">max</span><span class="o">);</span>
          <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">},</span>

      <span class="c1">// Combiner : on renvoie le plus grand des deux éléments</span>
      <span class="o">(</span><span class="n">e1</span><span class="o">,</span> <span class="n">e2</span><span class="o">)</span> <span class="o">-&gt;</span>  <span class="o">(</span><span class="n">e1</span><span class="o">.</span><span class="na">max</span> <span class="o">&gt;</span> <span class="n">e2</span><span class="o">.</span><span class="na">max</span><span class="o">)</span> <span class="o">?</span> <span class="n">e1</span> <span class="o">:</span> <span class="n">e2</span><span class="o">,</span>

      <span class="c1">// Finisher</span>
      <span class="nc">Gatherer</span><span class="o">.</span><span class="na">defaultFinisher</span><span class="o">()</span>
    <span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainGatherers</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Parallèle plus grand élément
[0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0] -&gt; [13]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_la_classe_gatherers"><a class="anchor" href="#_la_classe_gatherers"></a>4.1.3.7. La classe <code>Gatherers</code></h5>
<div class="paragraph">
<p>Un certain nombre de fabriques pour des implémentations de <code>Gatherer</code> répondant à des usages courants sont disponibles dans la classe <code>java.util.stream.Gatherers</code>.</p>
</div>
<div class="sect5">
<h6 id="_la_fabrique_gatherersfold"><a class="anchor" href="#_la_fabrique_gatherersfold"></a>4.1.3.7.1. La fabrique <code>Gatherers::fold</code></h6>
<div class="paragraph">
<p><code>fold(Supplier&lt;R&gt; initial, BiFunction&lt;? super R, ? super T, ? extends R&gt; folder)</code> renvoie un <code>Gatherer</code> séquentiel de type "many-to-one" qui agrège les données du flux de manière incrémentale et renvoie le résultat une fois tous les éléments du flux entrant consommés. Le type de l&#8217;état initial et du flux de sortie sont identiques (<code>&lt;R&gt;</code>).</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>definirGathererFold()</code> afin qu&#8217;elle renvoie un <code>Gatherer</code> qui concatène tous les éléments du flux d&#8217;entrée dans une chaîne de caractères.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Gatherer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="o">?,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">definirGathererFold</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Gatherers</span><span class="o">.</span><span class="na">fold</span><span class="o">(</span>
      <span class="c1">// Etat initial</span>
      <span class="o">()</span> <span class="o">-&gt;</span> <span class="s">""</span><span class="o">,</span>

      <span class="c1">// Fonction d'agrégation</span>
      <span class="o">(</span><span class="n">etat</span><span class="o">,</span> <span class="n">nombre</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">etat</span> <span class="o">+</span> <span class="n">nombre</span>
    <span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainGatherers</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Gatherers::fold
[0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0] -&gt; [0112358132110]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_la_fabrique_gatherersscan"><a class="anchor" href="#_la_fabrique_gatherersscan"></a>4.1.3.7.2. La fabrique <code>Gatherers::scan</code></h6>
<div class="paragraph">
<p><code>scan(Supplier&lt;R&gt; initial, BiFunction&lt;? super R, ? super T, ? extends R&gt; scanner</code> renvoie un <code>Gatherer</code> séquentiel de type "one-to-one" qui applique la fonction fournie à l&#8217;état actuel et à l&#8217;élément courant pour produire l&#8217;élément suivant, qu&#8217;il transmet en sortie.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>definirGathererScan()</code> afin qu&#8217;elle renvoie un <code>Gatherer</code> qui concatène l&#8217;état avec l&#8217;élément courant.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Gatherer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="o">?,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">definirGathererScan</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Gatherers</span><span class="o">.</span><span class="na">scan</span><span class="o">(</span>
      <span class="o">()</span> <span class="o">-&gt;</span> <span class="s">""</span><span class="o">,</span>
      <span class="o">(</span><span class="n">etat</span><span class="o">,</span> <span class="n">nombre</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">etat</span> <span class="o">+</span> <span class="n">nombre</span>
    <span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainGatherers</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Gatherers::scan
[0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0] -&gt; [0, 01, 011, 0112, 01123, 011235, 0112358, 011235813, 01123581321, 011235813211, 0112358132110]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_les_fabriques_gathererswindowfixed_et_gathererswindowsliding"><a class="anchor" href="#_les_fabriques_gathererswindowfixed_et_gathererswindowsliding"></a>4.1.3.7.3. Les fabriques <code>Gatherers::windowFixed</code> et <code>Gatherers::windowSliding</code></h6>
<div class="paragraph">
<p><code>windowFixed(int windowSize)</code> renvoie un <code>Gatherer</code> séquentiel de type "many-to-many" qui regroupe les éléments d&#8217;entrée dans des listes de la taille fournie et transmet les listes en sortie lorsqu&#8217;elles sont pleines ou qu&#8217;il n&#8217;y a plus d&#8217;éléments. Cette fabrique aurait pu être utilisée pour définir notre <code>Gatherer</code> qui rassemble les éléments deux par deux.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>definirGathererWindowFixed()</code> afin qu&#8217;elle renvoie un <code>Gatherer</code> qui regroupe les éléments trois par trois.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Gatherer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="o">?,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">definirGathererWindowFixed</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Gatherers</span><span class="o">.</span><span class="na">windowFixed</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainGatherers</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Gatherers::windowFixed
[0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0] -&gt; [[0, 1, 1], [2, 3, 5], [8, 13, 21], [1, 0]]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>windowSliding(int windowSize)</code> renvoie un <code>Gatherer</code> du même type qui regroupe les éléments d&#8217;entrée dans des listes de la taille fournie. Après la première fenêtre, chaque liste suivante est créée à partir d&#8217;une copie de la précédente en supprimant le premier élément et en ajoutant l&#8217;élément suivant à partir du flux d&#8217;entrée.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>definirGathererWindowSliding()</code> afin qu&#8217;elle renvoie un <code>Gatherer</code> qui regroupe les éléments dans une fenêtre glissante de trois éléments.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Gatherer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="o">?,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">definirGathererWindowSliding</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Gatherers</span><span class="o">.</span><span class="na">windowSliding</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainGatherers</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Gatherers::windowSliding
[0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0] -&gt; [[0, 1, 1], [1, 1, 2], [1, 2, 3], [2, 3, 5], [3, 5, 8], [5, 8, 13], [8, 13, 21], [13, 21, 1], [21, 1, 0]]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_la_fabrique_gatherersmapconcurrent"><a class="anchor" href="#_la_fabrique_gatherersmapconcurrent"></a>4.1.3.7.4. La fabrique <code>Gatherers::mapConcurrent</code></h6>
<div class="paragraph">
<p><code>mapConcurrent(final int maxConcurrency, final Function&lt;? super T, ? extends R&gt; mapper)</code> renvoie un <code>Gatherer</code> "one-to-one" qui invoque la fonction fournie sur chaque élément du flux en parallèle avec des threads virtuels, dont le nombre maximal est défini par <code>maxConcurrency</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Consulter la classe <code>fr.sciam.workshop.javase.gatherers.Guichet</code> pour information puis compléter la méthode <code>definirGathererMapConcurrent()</code> afin de réaliser des accès concurrents à la méthode <code>Guichet::acceder</code>, avec une limite de deux opérations simultanées.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Gatherer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="o">?,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="nf">definirGathererMapConcurrent</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Gatherers</span><span class="o">.</span><span class="na">mapConcurrent</span><span class="o">(</span>
      <span class="mi">2</span><span class="o">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="nl">Guichet:</span><span class="o">:</span><span class="n">acceder</span>
    <span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nombre maximal d&#8217;accès simultanés</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainGatherers</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Gatherers::mapConcurrent
Accès au guichet de #1 / (2 accès simultané(s))
Accès au guichet de #0 / (1 accès simultané(s))
Accès au guichet de #1 / (2 accès simultané(s))
Accès au guichet de #2 / (2 accès simultané(s))
Accès au guichet de #3 / (1 accès simultané(s))
Accès au guichet de #5 / (2 accès simultané(s))
Accès au guichet de #8 / (1 accès simultané(s))
Accès au guichet de #13 / (2 accès simultané(s))
Accès au guichet de #21 / (1 accès simultané(s))
Accès au guichet de #1 / (2 accès simultané(s))
Accès au guichet de #0 / (1 accès simultané(s))
[0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0] -&gt; [0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0]</pre>
</div>
</div>
<div class="paragraph">
<p>Constater qu&#8217;il n&#8217;y a jamais eu plus de deux accès concurrents.</p>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_la_composition_de_gatherer"><a class="anchor" href="#_la_composition_de_gatherer"></a>4.1.3.7.5. La composition de <code>Gatherer</code></h6>
<div class="paragraph">
<p>Les gatherers supportent la composition via la méthode <code>andThen(Gatherer)</code> qui joint deux gatherers où le premier produit des éléments que le second peut consommer.</p>
</div>
<div class="paragraph">
<p>Ainsi sémantiquement :</p>
</div>
<div class="paragraph">
<p><code>source.gather(a).gather(b).gather(c).collect(&#8230;&#8203;)</code></p>
</div>
<div class="paragraph">
<p>Est équivalent à :</p>
</div>
<div class="paragraph">
<p><code>source.gather(a.andThen(b).andThen(c)).collect(&#8230;&#8203;)</code></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>composerGatherers()</code> afin qu&#8217;elle renvoie un <code>Gatherer</code> qui est la composition des deux gatherers renvoyés par <code>definirGathererMapDouble()</code> et <code>definirGathererWindowSliding()</code>;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Gatherer</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="o">?,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="nf">composerGatherers</span><span class="o">()</span> <span class="o">{</span>

    <span class="kt">var</span> <span class="n">g1</span> <span class="o">=</span> <span class="n">definirGathererMapDouble</span><span class="o">();</span>
    <span class="kt">var</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">definirGathererWindowSliding</span><span class="o">();</span>

    <span class="k">return</span> <span class="n">g1</span><span class="o">.</span><span class="na">andThen</span><span class="o">(</span><span class="n">g2</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainGatherers</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Composition
[0, 1, 1, 2, 3, 5, 8, 13, 21, 1, 0] -&gt; [[0, 2, 2], [2, 2, 4], [2, 4, 6], [4, 6, 10], [6, 10, 16], [10, 16, 26], [16, 26, 42], [26, 42, 2], [42, 2, 0]]</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_les_nouvelles_api"><a class="anchor" href="#_les_nouvelles_api"></a>4.2. Les nouvelles API</h3>
<div class="paragraph">
<p>De nouvelles API ou compléments dans des API existantes ont été ajoutées.</p>
</div>
<div class="sect3">
<h4 id="_lab_lapi_sequenced_collections"><a class="anchor" href="#_lab_lapi_sequenced_collections"></a>4.2.1. Lab : l&#8217;API Sequenced Collections</h4>
<div class="paragraph">
<p>L&#8217;API Collection souffre de quelques manques concernant les collections qui ont un ordre de parcours :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>il n&#8217;existe pas de super-type commun,</p>
</li>
<li>
<p>il n&#8217;existe pas de méthode uniforme pour accéder au premier et au dernier élément d&#8217;une collection, ou pour parcourir ses éléments dans l&#8217;ordre inverse.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Trois nouvelles interfaces (<code>SequencedCollection</code>, <code>SequencedSet</code> et <code>SequencedMap</code>) sont intégrées dans la hiérarchie des types existants de l&#8217;API Collections afin de résoudre ces problèmes. Leur implémentation est un compromis qui privilégie la rétrocompatibilité.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JDK</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard en Java 21</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JEP</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://openjdk.org/jeps/431">431: Sequenced collections</a></p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_linterface_sequencedcollection"><a class="anchor" href="#_linterface_sequencedcollection"></a>4.2.1.1. L&#8217;interface <code>SequencedCollection</code></h5>
<div class="paragraph">
<p>L&#8217;interface <code>SequencedCollection</code> hérite de l&#8217;interface <code>Collection</code>.</p>
</div>
<div class="paragraph">
<p>Elle concerne un type de collection qui représente une séquence d&#8217;éléments possédant un ordre de parcours défini et simplifie la gestion des données ordonnées d&#8217;une collection, en offrant un accès facile et uniforme pour manipuler les éléments aux deux extrémités et en fournissant une méthode pour obtenir une vue de la collection dans l&#8217;ordre inverse.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>sequencedCollection()</code> de la classe <code>MainSequencedCollections</code> pour utiliser les méthodes de l&#8217;interface <code>SequencedCollection</code> pour ajouter, obtenir et retirer des éléments dans une <code>List</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sequencedCollection</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">nombres</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="n">nombres</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
    <span class="n">nombres</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">nombres</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">nombres</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">nombres</span><span class="o">.</span><span class="na">getFirst</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">nombres</span><span class="o">.</span><span class="na">getLast</span><span class="o">());</span>
    <span class="n">nombres</span><span class="o">.</span><span class="na">removeLast</span><span class="o">();</span>
    <span class="n">nombres</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">nombres</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainSequencedCollections</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Sequenced collection
[1, 2, 3]
1
3
[2]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>L&#8217;interface <code>SequencedCollection</code> propose la méthode <code>reversed()</code> qui renvoie une <code>SequencedCollection</code> pour obtenir une vue inversée des éléments de la collection d&#8217;origine. L&#8217;ordre de parcours des éléments dans la vue renvoyée est l&#8217;inverse de l&#8217;ordre de parcours des éléments dans cette collection.</p>
</div>
<div class="paragraph">
<p>Les modifications apportées à la collection sous-jacente peuvent ou non être visibles dans la vue inversée, en fonction de l&#8217;implémentation. Si elles sont autorisées, les modifications apportées à la vue modifient la collection d&#8217;origine.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>reversedSequencedCollection()</code> de la classe <code>MainSequencedCollections</code> pour manipuler une collection et sa collection inverse.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">reversedSequencedCollection</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">elements</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"1"</span><span class="o">,</span> <span class="s">"2"</span><span class="o">,</span> <span class="s">"3"</span><span class="o">,</span> <span class="s">"4"</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"elements : "</span> <span class="o">+</span> <span class="n">elements</span><span class="o">);</span>
    <span class="kt">var</span> <span class="n">inverse</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="na">reversed</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"inverse  : "</span> <span class="o">+</span> <span class="n">inverse</span><span class="o">);</span>

    <span class="n">elements</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">"5"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\nelements : "</span> <span class="o">+</span> <span class="n">elements</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"inverse  : "</span> <span class="o">+</span> <span class="n">inverse</span><span class="o">);</span>

    <span class="n">inverse</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"6"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\ninverse  : "</span> <span class="o">+</span> <span class="n">inverse</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"elements : "</span> <span class="o">+</span> <span class="n">elements</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainSequencedCollections</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Reversed sequenced collection
elements : [1, 2, 3, 4]
inverse  : [4, 3, 2, 1]

elements : [1, 2, 5, 3, 4]
inverse  : [4, 3, 5, 2, 1]

inverse  : [4, 6, 3, 5, 2, 1]
elements : [1, 2, 5, 3, 6, 4]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_linterface_sequencedset"><a class="anchor" href="#_linterface_sequencedset"></a>4.2.1.2. L&#8217;interface <code>SequencedSet</code></h5>
<div class="paragraph">
<p>Un <code>SequencedSet</code> peut être considéré soit comme un <code>Set</code> qui possède également un ordre de parcours bien défini, soit comme une <code>SequencedCollection</code> qui possède des éléments uniques.</p>
</div>
<div class="paragraph">
<p>L&#8217;interface <code>SequencedSet&lt;E&gt;</code> hérite des interfaces <code>Set&lt;E&gt;</code> et <code>SequencedCollection&lt;E&gt;</code>. Elle n&#8217;offre aucune méthode supplémentaire, mais contient une redéfinition covariante de la méthode <code>reversed()</code> qui renvoie une instance de type <code>SequenceSet&lt;E&gt;</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>sequencedSet()</code> de la classe <code>MainSequencedCollections</code> pour utiliser les méthodes de l&#8217;interface <code>SequencedSet</code> pour ajouter et obtenir des éléments dans une <code>LinkedHashSet</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sequencedSet</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">nombres</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">nombres</span><span class="o">);</span>

    <span class="nc">Integer</span> <span class="n">premier</span> <span class="o">=</span> <span class="n">nombres</span><span class="o">.</span><span class="na">getFirst</span><span class="o">();</span>
    <span class="nc">Integer</span> <span class="n">dernier</span> <span class="o">=</span> <span class="n">nombres</span><span class="o">.</span><span class="na">getLast</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">premier</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dernier</span><span class="o">);</span>

    <span class="n">nombres</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">nombres</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">nombres</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">nombres</span><span class="o">.</span><span class="na">reversed</span><span class="o">());</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainSequencedCollections</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SequencedSet
[2, 3, 4]
2
4
[1, 2, 3, 4, 5]
[5, 4, 3, 2, 1]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_linterface_sequencedmap"><a class="anchor" href="#_linterface_sequencedmap"></a>4.2.1.3. L&#8217;interface <code>SequencedMap</code></h5>
<div class="paragraph">
<p>L&#8217;interface <code>SequencedMap</code> est une interface spécialisée conçue pour les <code>Map</code> dont les clés, les valeurs et les entrées ont un ordre de parcours défini tout comme <code>LinkedHashMap</code>, qui introduit une nouvelle approche de la gestion des données ordonnées dans les Maps.</p>
</div>
<div class="paragraph">
<p>L&#8217;interface <code>SequencedMap&lt;K, V&gt;</code> hérite de l&#8217;interface <code>Map&lt;K, V&gt;</code> et fournit des méthodes pour accéder à ses entrées et les manipuler en tenant compte de leur ordre de parcours :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Map.Entry&lt;K, V&gt;</code> <code>firstEntry()</code> / <code>lastEntry()</code> : renvoyer la première / dernière entrée de la Map</p>
</li>
<li>
<p><code>Map.Entry&lt;K, V&gt;</code> <code>pollFirstEntry()</code> / <code>pollLastEntry()</code> : supprimer et renvoyer la première / dernière entrée de la Map</p>
</li>
<li>
<p><code>Map.Entry&lt;K, V&gt;</code> <code>putFirst(K k, V v)</code> / <code>putLast(K k, V v)</code> : insérer une entrée au début / à la fin de la <code>Map</code></p>
</li>
<li>
<p><code>SequencedMap&lt;K, V&gt;</code> <code>reversed()</code> : obtenir une vue inversée de la <code>Map</code></p>
</li>
<li>
<p><code>SequencedSet&lt;Map.Entry&lt;K,V&gt;&gt;</code> <code>sequencedEntrySet()</code> : renvoyer un <code>SequencedSet</code> des entrées de la <code>Map</code>, en conservant l&#8217;ordre de parcours</p>
</li>
<li>
<p><code>SequencedSet&lt;K&gt;</code> <code>sequencedKeySet()</code> : renvoyer un <code>SequencedSet</code> des clés de la <code>Map</code>, en conservant l&#8217;ordre de parcours</p>
</li>
<li>
<p><code>SequencedCollection&lt;V&gt;</code> <code>sequencedValues()</code> : renvoyer une <code>SequencedCollection</code> des valeurs <code>Map</code>, en conservant l&#8217;ordre de parcours</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>sequencedMap()</code> de la classe <code>MainSequencedCollections</code> pour utiliser les méthodes de l&#8217;interface <code>SequencedMap</code> pour ajouter et obtenir des éléments dans une <code>LinkedHashMap</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sequencedMap</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">SequencedMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"Valeur1"</span><span class="o">);</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">"Valeur2"</span><span class="o">);</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">"Valeur3"</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">firstEntry</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">lastEntry</span><span class="o">());</span>

    <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">premier</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">pollFirstEntry</span><span class="o">();</span>
    <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">dernier</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">pollLastEntry</span><span class="o">();</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n"</span><span class="o">+</span><span class="n">premier</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dernier</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>

    <span class="n">map</span><span class="o">.</span><span class="na">putFirst</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"Valeur1"</span><span class="o">);</span>
    <span class="n">map</span><span class="o">.</span><span class="na">putLast</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">"Valeur3"</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n"</span><span class="o">+</span><span class="n">map</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n"</span><span class="o">+</span><span class="n">map</span><span class="o">.</span><span class="na">reversed</span><span class="o">());</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainSequencedCollections</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SequencedMap
{1=Valeur1, 2=Valeur2, 3=Valeur3}
1=Valeur1
3=Valeur3

1=Valeur1
3=Valeur3
{2=Valeur2}

{1=Valeur1, 2=Valeur2, 3=Valeur3}

{3=Valeur3, 2=Valeur2, 1=Valeur1}</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Les objets retournés par les méthodes <code>firstEntry()</code>, <code>lastEntry()</code>, <code>pollFirstEntry()</code> et <code>pollLastEntry()</code> de l&#8217;interface <code>SequencedMap</code> ne prennent pas en charge la mutation de la <code>Map</code> sous-jacente en utilisant leur méthode optionnelle <code>setValue()</code>. L&#8217;invocation de la méthode setValue() dans ce contexte lève une exception de type <code>UnsupportedOperationException</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>majSequencedMap()</code> de la classe <code>MainSequencedCollections</code> pour tenter de modifier le premier élément d&#8217;une <code>LinkedHashMap</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">majSequencedMap</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">SequencedMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"Valeur1"</span><span class="o">);</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">"Valeur2"</span><span class="o">);</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">"Valeur3"</span><span class="o">);</span>

    <span class="k">try</span>  <span class="o">{</span>
    <span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">firstEntry</span><span class="o">();</span>
    <span class="n">entry</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="s">"Valeur1 modifiee"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainSequencedCollections</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Maj SequencedMap
java.lang.UnsupportedOperationException: not supported
	at java.base/jdk.internal.util.NullableKeyValueHolder.setValue(NullableKeyValueHolder.java:126)
	at fr.sciam.workshop.javase.sequencedcollections.MainSequencedCollections.majSequencedMap(MainSequencedCollections.java:118)
	at fr.sciam.workshop.javase.sequencedcollections.MainSequencedCollections.main(MainSequencedCollections.java:19)</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_les_exceptions_levées_par_certaines_méthodes"><a class="anchor" href="#_les_exceptions_levées_par_certaines_méthodes"></a>4.2.1.4. Les exceptions levées par certaines méthodes</h5>
<div class="paragraph">
<p>L&#8217;invocation des nouvelles méthodes <code>addXxx()</code> ou <code>removeXxx()</code> sur une collection non modifiable lève une exception de type <code>UnsupportedOperationException</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>collectionNonModifiable()</code> de la classe <code>MainSequencedCollections</code> pour tenter d&#8217;ajouter un élément dans une liste non modifiable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">collectionNonModifiable</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">nombres</span> <span class="o">=</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
      <span class="n">nombres</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainSequencedCollections</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Collection non modifiable
java.lang.UnsupportedOperationException
	at java.base/java.util.ImmutableCollections.uoe(ImmutableCollections.java:142)
	at java.base/java.util.ImmutableCollections$AbstractImmutableList.add(ImmutableCollections.java:258)
	at java.base/java.util.List.addFirst(List.java:794)
	at fr.sciam.workshop.javase.sequencedcollections.MainSequencedCollections.collectionNonModifiable(MainSequencedCollections.java:129)
	at fr.sciam.workshop.javase.sequencedcollections.MainSequencedCollections.main(MainSequencedCollections.java:20)</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Dans les collections qui ont déjà un ordre de tri défini, l&#8217;invocation des méthodes forçant l&#8217;ordre, par exemple <code>addFirst()</code>, <code>addLast()</code>, …​, n&#8217;a pas de sens et lève une exception de type <code>UnsupportedOperationException</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>collectionTriee()</code> de la classe <code>MainSequencedCollections</code> pour ajouter un nouvel élément en première position dans un collection de type <code>TreeSet</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">collectionTriee</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">nombres</span> <span class="o">=</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
      <span class="n">nombres</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainSequencedCollections</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Collection triee
java.lang.UnsupportedOperationException
	at java.base/java.util.ImmutableCollections.uoe(ImmutableCollections.java:142)
	at java.base/java.util.ImmutableCollections$AbstractImmutableList.add(ImmutableCollections.java:258)
	at java.base/java.util.List.addFirst(List.java:794)
	at fr.sciam.workshop.javase.sequencedcollections.MainSequencedCollections.collectionTriee(MainSequencedCollections.java:145)</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Toute tentative d&#8217;utiliser une méthode des interfaces séquencées sur une collection vide lève une exception de type NoSuchElementException.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>collectionVide()</code> de la classe <code>MainSequencedCollections</code> pour obtenir le premier élément d&#8217;une collection vide.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">collectionVide</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">SequencedCollection</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">elements</span> <span class="o">=</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">();</span>
      <span class="n">elements</span><span class="o">.</span><span class="na">getFirst</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainSequencedCollections</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Collection vide
java.util.NoSuchElementException
	at java.base/java.util.List.getFirst(List.java:823)
	at fr.sciam.workshop.javase.sequencedcollections.MainSequencedCollections.collectionVide(MainSequencedCollections.java:154)
	at fr.sciam.workshop.javase.sequencedcollections.MainSequencedCollections.main(MainSequencedCollections.java:23)</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_les_collections_séquencées_immutables"><a class="anchor" href="#_les_collections_séquencées_immutables"></a>4.2.1.5. Les collections séquencées immutables</h5>
<div class="paragraph">
<p>Trois nouvelles fabriques ont été ajoutées dans la classe <code>java.util.Collections</code> pour obtenir des collections non modifiables sur les collections séquencées passées en paramètre :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SequencedCollection&lt;T&gt;</code> <code>unmodifiableSequencedCollection(SequencedCollection&lt;? extends T&gt;)</code></p>
</li>
<li>
<p><code>SequencedSet&lt;T&gt;</code> <code>unmodifiableSequencedSet(SequencedSet&lt;? extends T&gt;)</code></p>
</li>
<li>
<p><code>&lt;K, V&gt; SequencedMap&lt;K, V&gt;</code> <code>unmodifiableSequencedMap(SequencedMap&lt;? extends K, ? extends V&gt;)</code></p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>unmodifiableSequenced()</code> de la classe <code>MainSequencedCollections</code> pour tenter d&#8217;obtenir et retirer le premier élément d&#8217;une collection de type <code>LinkedHashMap</code> non modifiable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">unmodifiableSequenced</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">SequencedMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"Valeur1"</span><span class="o">);</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">"Valeur2"</span><span class="o">);</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">"Valeur3"</span><span class="o">);</span>

    <span class="nc">SequencedMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">unmodifiableSequencedMap</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableSequencedMap</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="n">unmodifiableSequencedMap</span><span class="o">.</span><span class="na">pollFirstEntry</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">UnsupportedOperationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainSequencedCollections</code> pour vérifier le résultat de l&#8217;exécution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>UnmodifiableSequenced
java.lang.UnsupportedOperationException
	at java.base/java.util.Collections$UnmodifiableSequencedMap.pollFirstEntry(Collections.java:2019)
	at fr.sciam.workshop.javase.sequencedcollections.MainSequencedCollections.unmodifiableSequenced(MainSequencedCollections.java:175)
	at fr.sciam.workshop.javase.sequencedcollections.MainSequencedCollections.main(MainSequencedCollections.java:26)</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&nbsp;</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lab_lapi_foreign_function_memory"><a class="anchor" href="#_lab_lapi_foreign_function_memory"></a>4.2.2. Lab : l&#8217;API Foreign Function &amp; Memory</h4>
<div class="paragraph">
<p>Depuis le JDK 1.1, il est possible de manipuler des données "off-heap" et d&#8217;interagir avec du code natif via l&#8217;API JNI : "Java Native Interface" :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>L&#8217;appel à des fonctions natives se fait via l&#8217;utilisation du modificateur <code>native</code> et d&#8217;une "glue" en langage natif permettant de faire le lien entre code C et Java dans laquelle il faudra effectuer les conversions des types de données</p>
</li>
<li>
<p>La gestion de la mémoire "off-heap" peut être réalisée via <code>ByteBuffer::allocateDirect</code> et <code>sun.misc.Unsafe</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces fonctionnalités présentent un certain nombre d&#8217;inconvénients :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lourdeur de mise en œuvre, nécessité d&#8217;écrire du code natif</p>
</li>
<li>
<p>Gestion manuelle de la mémoire</p>
</li>
<li>
<p>Performance</p>
</li>
<li>
<p><code>Unsafe</code> est non standard et devant à terme être remplacée</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>L&#8217;API Foreign Function &amp; Memory "FFM" a pour ambition de fournir un moyen sûr et performant de répondre à ces problématiques.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JDK</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Première incubation en Java 14 <a href="https://openjdk.org/jeps/412">JEP 412</a>. Standard en Java 22</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JEP</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://openjdk.org/jeps/454">JEP 454: Foreign Function &amp; Memory API</a></p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_la_gestion_de_la_mémoire_off_heap"><a class="anchor" href="#_la_gestion_de_la_mémoire_off_heap"></a>4.2.2.1. La gestion de la mémoire "off-heap"</h5>
<div class="paragraph">
<p>La mémoire "off-heap" fait référence à la mémoire allouée en dehors du tas (heap).
Cette zone mémoire n&#8217;est donc pas gérée par la JVM ni soumise à la collecte par le Garbage Collector.</p>
</div>
<div class="paragraph">
<p>L&#8217;API FFM nous propose une représentation de la mémoire "off-heap" sous la forme de l&#8217;interface <code>MemorySegment</code>.
Un tel objet peut être obtenu par l&#8217;intermédiaire d&#8217;une <code>Arena</code> qui implémente l&#8217;interface <code>AutoCloseable</code> et va en contrôler la portée en nous permettant de déterminer à quel moment la mémoire allouée à ce segment sera libérée.</p>
</div>
<div class="paragraph">
<p>Une instance de l&#8217;interface <code>Arena</code> peut être obtenue via l&#8217;une de ses 4 fabriques : <code>global()</code>, <code>ofAuto()</code>, <code>ofConfined()</code> et <code>ofShared()</code>.
Ces <code>Arena</code> diffèrent par les propriétés suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>L&#8217;accessibilité aux segments depuis le thread qui a créé l'<code>Arena</code> ou depuis n&#8217;importe quel thread</p>
</li>
<li>
<p>La durée de vie des segments alloués</p>
</li>
<li>
<p>La possibilité ou non de libérer explicitement les segments alloués</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces différences sont synthétisées dans ce tableau :</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 30%;">
<col style="width: 30%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-center valign-top">Durée de vie limitée</th>
<th class="tableblock halign-center valign-top">Arrêt explicite possible</th>
<th class="tableblock halign-center valign-top">Accessible depuis plusieurs threads</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Global</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✗</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✗</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Automatic</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✗</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Confined</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✗</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shared</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✓</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>Arena</code> possède des surcharges des méthodes <code>allocate()</code> et <code>allocateFrom()</code> permettant d&#8217;allouer un <code>MemorySegment</code>.</p>
</div>
<div class="paragraph">
<p>Il est ensuite possible de lire dans un <code>MemorySegment</code> via les méthodes <code>get()</code>, <code>getAtIndex()</code> ou <code>getString()</code>, et d&#8217;écrire via les méthodes <code>set()</code>, <code>setAtIndex()</code> ou <code>setString()</code>.</p>
</div>
<div class="paragraph">
<p>Une fois alloué, la dimension d&#8217;un <code>MemorySegment</code> ne peut plus être modifiée.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Tout accès en lecture ou écriture en dehors des bornes du segment lève une exception de type <code>IndexOutOfBoundsException</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_lécriture_et_la_lecture_de_chaînes_de_caractères"><a class="anchor" href="#_lécriture_et_la_lecture_de_chaînes_de_caractères"></a>4.2.2.2. L&#8217;écriture et la lecture de chaînes de caractères</h5>
<div class="paragraph">
<p>Écrire et lire des chaînes de caractères via un <code>MemorySegment</code> se fait de manière simple.
L&#8217;API se charge des considérations techniques d&#8217;encodage et de décodage, notamment du caractère de terminaison de chaînes de caractères en C <code>\0</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>allocateFrom()</code> permet d&#8217;initialiser un <code>MemorySegment</code> à partir d&#8217;une chaîne de caractères</p>
</li>
<li>
<p><code>setString()</code> et <code>getString()</code> permettent respectivement d&#8217;écrire et lire une chaîne de caractères avec un offset donné</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Chacune de ces méthodes possède une surcharge permettant de spécifier le <code>Charset</code> à utiliser, <code>UTF-8</code> étant utilisé par défaut.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>manipulerChaineDeCaracteres()</code> de <code>fr.sciam.workshop.javase.ffm.MainFFM</code> afin d&#8217;utiliser une <code>Arena</code> de type "confined" pour allouer un <code>MemorySegment</code> à partir de la chaîne de caractères "Hello FFM".</p>
</div>
<div class="paragraph">
<p>Ensuite, lire et afficher le contenu de cette chaîne de caractères depuis le <code>MemorySegment</code>.</p>
</div>
<div class="paragraph">
<p>Afficher également la taille en octet de ce <code>MemorySegment</code> grâce à la méthode <code>byteSize()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerChaineDeCaracteres</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocateFrom</span><span class="o">(</span><span class="s">"Hello FFM"</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">memorySegment</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">.</span><span class="na">byteSize</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'une chaîne de caractères :
Hello FFM
10</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
On constate une taille de 10 octets, un octet supplémentaire ayant été nécessaire pour stocker le caractère de terminaison de chaîne de caractères <code>\0</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lécriture_et_la_lecture_de_types_primitifs"><a class="anchor" href="#_lécriture_et_la_lecture_de_types_primitifs"></a>4.2.2.3. L&#8217;écriture et la lecture de types primitifs</h5>
<div class="paragraph">
<p>Chacune des méthodes <code>get()</code>/<code>getAtIndex()</code> et <code>set()</code>/<code>setAtIndex()</code> nécessite en paramètre une instance de type <code>ValueLayout</code> qui explicite la structure de la donnée à lire ou écrire.
Il s&#8217;agit d&#8217;une interface scellée dont les implémentations correspondent aux différents types primitifs du langage Java (<code>boolean</code>, <code>byte</code>, <code>int</code>, <code>double</code>, &#8230;&#8203;) et contient les informations nécessaires :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la taille de la donnée,</p>
</li>
<li>
<p>son boutisme (little ou big endian),</p>
</li>
<li>
<p>l&#8217;alignement,</p>
</li>
<li>
<p>le type de la donnée Java correspondante.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
L&#8217;alignement contraint les données à ce qu&#8217;elles soient stockées à des adresses mémoire particulières, par exemple des multiples de 4 octets pour les entiers, pour des raisons de performances d&#8217;accès. Des octets de "padding" peuvent être ajoutés pour respecter cet alignement.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Dans la méthode <code>manipulerEntiers()</code>, allouer un <code>MemorySegment</code> d&#8217;une taille de 32 octets.</p>
</div>
<div class="paragraph">
<p>Ensuite, réaliser l&#8217;écriture puis la lecture de chacune des valeurs contenues dans le tableau <code>ENTIERS</code> à l&#8217;aide des méthodes <code>set()</code> et <code>get()</code>. Celles-ci se basent sur la position (en octets) à laquelle on souhaite accéder : il faut donc incrémenter cette position après chaque itération pour accéder à la donnée suivante.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerEntiers</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">32</span><span class="o">);</span>

      <span class="c1">// Ecriture</span>
      <span class="kt">long</span> <span class="n">increment</span> <span class="o">=</span> <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">.</span><span class="na">byteSize</span><span class="o">();</span> <span class="c1">// 4 octets</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">memorySegment</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">increment</span><span class="o">,</span> <span class="no">ENTIERS</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
      <span class="o">}</span>

      <span class="c1">// Lecture</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">entier</span> <span class="o">=</span> <span class="n">memorySegment</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">increment</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">entier</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'entiers
0 123 456 789 -1 -2 -3 -4</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Les méthodes <code>getAtIndex()</code> et <code>setAtIndex()</code> sont plus adaptées à notre cas de figure, car elles prennent comme paramètre l&#8217;index de la donnée, et effectuent en interne le calcul de la position en multipliant par la taille.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier la méthode <code>manipulerEntiers()</code> afin d&#8217;utiliser <code>getAtIndex()</code> et <code>setAtIndex()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerEntiers</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">32</span><span class="o">);</span>

      <span class="c1">// Ecriture</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">memorySegment</span><span class="o">.</span><span class="na">setAtIndex</span><span class="o">(</span><span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="no">ENTIERS</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
      <span class="o">}</span>

      <span class="c1">// Lecture</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">entier</span> <span class="o">=</span> <span class="n">memorySegment</span><span class="o">.</span><span class="na">getAtIndex</span><span class="o">(</span><span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">entier</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient le même résultat :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'entiers
0 123 456 789 -1 -2 -3 -4</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_les_memory_layouts_et_les_accès_structurés"><a class="anchor" href="#_les_memory_layouts_et_les_accès_structurés"></a>4.2.2.4. Les Memory layouts et les accès structurés</h5>
<div class="paragraph">
<p>Accéder à des données structurées en mémoire en ne se limitant qu&#8217;à des opérations basiques s&#8217;avérerait limitant.
L&#8217;API FFM fournit l&#8217;interface <code>MemoryLayout</code> qui permet de définir une structuration de la donnée et d&#8217;y accéder de manière simplifiée. Plusieurs possibilités sont offertes au travers de certaines de ses interfaces filles :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>StructLayout</code> pour une structure agrégeant plusieurs données,</p>
</li>
<li>
<p><code>SequenceLayout</code> pour une répétition d&#8217;une donnée ou structure de données,</p>
</li>
<li>
<p><code>PaddingLayout</code> pour une plage non utilisée (typiquement pour de l&#8217;alignement),</p>
</li>
<li>
<p><code>UnionLayout</code> pour définir des unions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Une fois le layout défini, la méthode <code>varHandle()</code> renvoie un <code>VarHandle</code> permettant d&#8217;accéder à un élément de la structure. Cette méthode accepte des paramètres de type <code>MemoryLayout.PathElement</code>, dont le choix définira l&#8217;élément auquel on accède.</p>
</div>
<div class="paragraph">
<p>Les paramètres de type <code>MemoryLayout.PathElement</code> peuvent s&#8217;obtenir via les fabriques :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>groupElement()</code> pour obtenir un élément à partir de son index ou son nom au sein d&#8217;un groupe,</p>
</li>
<li>
<p><code>sequenceElement()</code> pour obtenir un élément au sein d&#8217;un <code>SequenceLayout</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>Arena</code> possède une surcharge de la méthode <code>allocate()</code> qui accepte un <code>MemoryLayout</code> afin d&#8217;allouer un <code>MemorySegment</code> de la taille correspondante.
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="_le_layout_structlayout"><a class="anchor" href="#_le_layout_structlayout"></a>4.2.2.4.1. Le layout <code>StructLayout</code></h6>
<div class="paragraph">
<p><code>MemoryLayout::structLayout</code> permet de définir une structure de données à partir des <code>MemoryLayout</code> qui la constituent.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Consulter le <code>record</code> <code>CoordonneesGps</code>, puis dans la méthode <code>manipulerStructLayout()</code>, créer un layout représentant cette structure de données en mémoire.</p>
</div>
<div class="paragraph">
<p>Puis, allouer un <code>MemorySegment</code> pour y écrire la première coordonnée GPS du tableau <code>COORDONNEES_GPS</code> avec le layout créé.
On utilisera <code>MemoryLayout.PathElement::groupElement(index)</code> pour accéder aux éléments : index <code>0</code> pour la latitude, index <code>1</code> pour la longitude.</p>
</div>
<div class="paragraph">
<p>Enfin, lire les valeurs dans le <code>MemorySegment</code> via le <code>VarHandle</code> pour vérifier que les données ont correctement été écrites, aux bons emplacements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerStructLayout</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">StructLayout</span> <span class="n">structLayout</span> <span class="o">=</span> <span class="nc">MemoryLayout</span><span class="o">.</span><span class="na">structLayout</span><span class="o">(</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_FLOAT</span><span class="o">,</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_FLOAT</span>
      <span class="o">);</span>

      <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">structLayout</span><span class="o">);</span>

      <span class="nc">VarHandle</span> <span class="n">latitudeHandle</span> <span class="o">=</span> <span class="n">structLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="nc">PathElement</span><span class="o">.</span><span class="na">groupElement</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
      <span class="nc">VarHandle</span> <span class="n">longitudeHandle</span> <span class="o">=</span> <span class="n">structLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="nc">PathElement</span><span class="o">.</span><span class="na">groupElement</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>

      <span class="nc">CoordonneesGps</span> <span class="n">coordonnees</span> <span class="o">=</span> <span class="no">COORDONNEES_GPS</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
      <span class="n">latitudeHandle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">latitude</span><span class="o">());</span>
      <span class="n">longitudeHandle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">longitude</span><span class="o">());</span>

      <span class="kt">float</span> <span class="n">latitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">latitudeHandle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
      <span class="kt">float</span> <span class="n">longitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">longitudeHandle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Ecrit : "</span> <span class="o">+</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">latitude</span><span class="o">()</span> <span class="o">+</span> <span class="s">", lu : "</span> <span class="o">+</span> <span class="n">latitude</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Ecrit : "</span> <span class="o">+</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">longitude</span><span class="o">()</span> <span class="o">+</span> <span class="s">", lu : "</span> <span class="o">+</span> <span class="n">longitude</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'un StructLayout
Ecrit : 43.1242, lu : 43.1242
Ecrit : 5.9285, lu : 5.9285</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Les <code>MemoryLayout</code> passés en paramètres peuvent être nommés via la méthode <code>withName()</code>.
On pourra ensuite utiliser ces noms pour obtenir les chemins des éléments <code>MemoryLayout.PathElement</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier la méthode <code>manipulerStructLayout()</code> afin de nommer les <code>ValueLayout</code> et d&#8217;utiliser les noms choisis pour obtenir les <code>VarHandle</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerStructLayout</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">StructLayout</span> <span class="n">structLayout</span> <span class="o">=</span> <span class="nc">MemoryLayout</span><span class="o">.</span><span class="na">structLayout</span><span class="o">(</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_FLOAT</span><span class="o">.</span><span class="na">withName</span><span class="o">(</span><span class="s">"latitude"</span><span class="o">),</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_FLOAT</span><span class="o">.</span><span class="na">withName</span><span class="o">(</span><span class="s">"longitude"</span><span class="o">)</span>
      <span class="o">);</span>

      <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">structLayout</span><span class="o">);</span>

      <span class="nc">VarHandle</span> <span class="n">latitudeHandle</span> <span class="o">=</span> <span class="n">structLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="nc">PathElement</span><span class="o">.</span><span class="na">groupElement</span><span class="o">(</span><span class="s">"latitude"</span><span class="o">));</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="nc">VarHandle</span> <span class="n">longitudeHandle</span> <span class="o">=</span> <span class="n">structLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="nc">PathElement</span><span class="o">.</span><span class="na">groupElement</span><span class="o">(</span><span class="s">"longitude"</span><span class="o">));</span>

      <span class="nc">CoordonneesGps</span> <span class="n">coordonnees</span> <span class="o">=</span> <span class="no">COORDONNEES_GPS</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
      <span class="n">latitudeHandle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">latitude</span><span class="o">());</span>
      <span class="n">longitudeHandle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">longitude</span><span class="o">());</span>

      <span class="kt">float</span> <span class="n">latitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">latitudeHandle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
      <span class="kt">float</span> <span class="n">longitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">longitudeHandle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Ecrit : "</span> <span class="o">+</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">latitude</span><span class="o">()</span> <span class="o">+</span> <span class="s">", lu : "</span> <span class="o">+</span> <span class="n">latitude</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Ecrit : "</span> <span class="o">+</span> <span class="n">coordonnees</span><span class="o">.</span><span class="na">longitude</span><span class="o">()</span> <span class="o">+</span> <span class="s">", lu : "</span> <span class="o">+</span> <span class="n">longitude</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nommage des éléments de la structure</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Obtention du chemin de l&#8217;élément avec le nom choisi</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient le même résultat :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'un StructLayout
Ecrit : 43.1242, lu : 43.1242
Ecrit : 5.9285, lu : 5.9285</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_le_layout_sequencelayout"><a class="anchor" href="#_le_layout_sequencelayout"></a>4.2.2.4.2. Le layout <code>SequenceLayout</code></h6>
<div class="paragraph">
<p><code>SequenceLayout</code> permet de définir une répétition d&#8217;un champ ou structure.</p>
</div>
<div class="paragraph">
<p>Les surcharges de <code>PathElement::sequenceElement</code> permettent d&#8217;obtenir les <code>VarHandle</code> permettant de lire et écrire au sein d&#8217;une séquence.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Utiliser un <code>SequenceLayout</code> pour écrire le contenu du tableau <code>ENTIERS</code> dans un <code>MemorySegment</code>, à l&#8217;aide du <code>VarHandle</code> obtenu avec le <code>PathElement</code> renvoyé par <code>PathElement.sequenceElement()</code>.</p>
</div>
<div class="paragraph">
<p>Enfin, lire les valeurs dans le <code>MemorySegment</code> via le <code>VarHandle</code> pour vérifier que les données ont correctement été écrites, aux bons emplacements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerSequenceLayout</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>

      <span class="nc">SequenceLayout</span> <span class="n">sequenceLayout</span> <span class="o">=</span> <span class="nc">MemoryLayout</span><span class="o">.</span><span class="na">sequenceLayout</span><span class="o">(</span><span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">);</span>
      <span class="nc">VarHandle</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">sequenceLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="nc">PathElement</span><span class="o">.</span><span class="na">sequenceElement</span><span class="o">());</span>

      <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">sequenceLayout</span><span class="o">);</span>

      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">handle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="no">ENTIERS</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
      <span class="o">}</span>

      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">entier</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">handle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">entier</span> <span class="o">+</span> <span class="s">" "</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'un SequenceLayout
0 123 456 789 -1 -2 -3 -4</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_la_combinaison_dun_structlayout_et_sequencelayout"><a class="anchor" href="#_la_combinaison_dun_structlayout_et_sequencelayout"></a>4.2.2.4.3. La combinaison d&#8217;un <code>StructLayout</code> et <code>SequenceLayout</code></h6>
<div class="paragraph">
<p>Il est possible de combiner les layouts.
Si l&#8217;on souhaite répéter plusieurs fois la même structure, l&#8217;utilisation conjointe de <code>StructLayout</code> et <code>SequenceLayout</code> est adaptée.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>manipulerStructLayoutDansSequenceLayout()</code> afin d&#8217;écrire puis lire les valeurs de <code>COORDONNEES_GPS</code> en utilisant conjointement <code>StructLayout</code> et <code>SequenceLayout</code> des mises en pratique précédentes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">manipulerStructLayoutDansSequenceLayout</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span> <span class="o">=</span> <span class="nc">Arena</span><span class="o">.</span><span class="na">ofConfined</span><span class="o">())</span> <span class="o">{</span>

      <span class="c1">// Structure</span>
      <span class="nc">StructLayout</span> <span class="n">structLayout</span> <span class="o">=</span> <span class="nc">MemoryLayout</span><span class="o">.</span><span class="na">structLayout</span><span class="o">(</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_FLOAT</span><span class="o">.</span><span class="na">withName</span><span class="o">(</span><span class="s">"latitude"</span><span class="o">),</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_FLOAT</span><span class="o">.</span><span class="na">withName</span><span class="o">(</span><span class="s">"longitude"</span><span class="o">)</span>
      <span class="o">);</span>

      <span class="c1">// Sequence</span>
      <span class="nc">SequenceLayout</span> <span class="n">sequenceLayout</span> <span class="o">=</span> <span class="nc">MemoryLayout</span><span class="o">.</span><span class="na">sequenceLayout</span><span class="o">(</span><span class="no">ENTIERS</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">structLayout</span><span class="o">);</span>

      <span class="c1">// Obtention des VarHandle</span>
      <span class="nc">PathElement</span> <span class="n">element</span> <span class="o">=</span> <span class="nc">PathElement</span><span class="o">.</span><span class="na">sequenceElement</span><span class="o">();</span>
      <span class="nc">VarHandle</span> <span class="n">latitudeHandle</span> <span class="o">=</span> <span class="n">sequenceLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="nc">PathElement</span><span class="o">.</span><span class="na">groupElement</span><span class="o">(</span><span class="s">"latitude"</span><span class="o">));</span>
      <span class="nc">VarHandle</span> <span class="n">longitudeHandle</span> <span class="o">=</span> <span class="n">sequenceLayout</span><span class="o">.</span><span class="na">varHandle</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="nc">PathElement</span><span class="o">.</span><span class="na">groupElement</span><span class="o">(</span><span class="s">"longitude"</span><span class="o">));</span>

      <span class="c1">// Allocation d'un segment dont la taille correspond à la structure</span>
      <span class="nc">MemorySegment</span> <span class="n">segment</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">sequenceLayout</span><span class="o">);</span>

      <span class="c1">// Écriture</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">COORDONNEES_GPS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">CoordonneesGps</span> <span class="n">c</span> <span class="o">=</span> <span class="no">COORDONNEES_GPS</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
        <span class="n">latitudeHandle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">segment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">c</span><span class="o">.</span><span class="na">latitude</span><span class="o">());</span>
        <span class="n">longitudeHandle</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">segment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">c</span><span class="o">.</span><span class="na">longitude</span><span class="o">());</span>
      <span class="o">}</span>

      <span class="c1">// Lecture</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">COORDONNEES_GPS</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">float</span> <span class="n">latitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">latitudeHandle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">segment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="kt">float</span> <span class="n">longitude</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">longitudeHandle</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">segment</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Latitude : "</span> <span class="o">+</span> <span class="n">latitude</span> <span class="o">+</span> <span class="s">", Longitude "</span> <span class="o">+</span> <span class="n">longitude</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Manipulation d'un StructLayout dans un SequenceLayout
Latitude : 43.1242, Longitude 5.9285
Latitude : 43.1176, Longitude 5.9404
Latitude : 43.0928, Longitude 6.0756
Latitude : 43.1055, Longitude 5.8869</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lappel_de_fonctions_natives"><a class="anchor" href="#_lappel_de_fonctions_natives"></a>4.2.2.5. L&#8217;appel de fonctions natives</h5>
<div class="paragraph">
<p>L&#8217;API FFM met à dispositions les moyens permettant la recherche et le chargement de bibliothèques natives ainsi que l&#8217;invocation de fonctions native (downcall), ou l&#8217;appel de méthodes Java depuis le code natif (upcall).</p>
</div>
<div class="sect5">
<h6 id="_la_recherche_et_le_chargement_de_bibliothèques_natives"><a class="anchor" href="#_la_recherche_et_le_chargement_de_bibliothèques_natives"></a>4.2.2.5.1. La recherche et le chargement de bibliothèques natives</h6>
<div class="paragraph">
<p>Chaque bibliothèque adhère à une "Application Binary Interface" (ABI) qui est un ensemble de conventions et types de données qui dépendent du système d&#8217;exploitation, du compilateur et du processeur.
L&#8217;interface <code>Linker</code> a connaissance de ces conventions et joue le rôle de médiateur entre le code Java et le code natif.</p>
</div>
<div class="paragraph">
<p>Une instance de <code>Linker</code> s&#8217;obtient via la fabrique <code>nativeLinker()</code>.</p>
</div>
<div class="paragraph">
<p>L&#8217;interface <code>SymbolLookup</code> permet de fournir un accès aux bibliothèques et fonctions natives qui adhèrent aux spécifications de la plateforme.
Pour en obtenir une instance, on dispose de 3 fabriques :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SymbolLookup.libraryLookup(String, arena)</code> et <code>SymbolLookup.libraryLookup(Path, arena)</code> permettent de charger dynamiquement une bibliothèque par son nom ou son chemin et en liant son cycle de vie à celui de l'<code>Arena</code>,</p>
</li>
<li>
<p><code>SymbolLookup.loaderLookup()</code> crée un <code>SymbolLookup</code> qui recherchera dans les bibliothèques chargées par le <code>ClassLoader</code>, par exemple via <code>System.load()</code> ou <code>System.loadLibrary()</code> comme on le ferait avec JNI.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ainsi que de la méthode <code>Linker.defaultLookup()</code> qui permet de rechercher parmi un ensemble de bibliothèques standard, telle que la bibliothèque <code>libc</code> sous Linux.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Dans la suite de ce lab, nous allons manipuler la bibliothèque <a href="https://www.sqlite.org/">SQLite</a> qui est écrite en langage C et permet de créer et interagir avec une base de données locale.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>chargerBibliothequeNative()</code> dans le but de charger la bibliothèque sqlite3 correspondant à votre système d&#8217;exploitation présente dans le répertoire <code>sqlite/</code> via son <code>Path</code>.
Ajouter un message indiquant le succès de chargement puis renvoyer l&#8217;instance de <code>SymbolLookup</code> obtenue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">SymbolLookup</span> <span class="nf">chargerBibliothequeNativeAvecPath</span><span class="o">(</span><span class="nc">Arena</span> <span class="n">arena</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Path</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"sqlite/sqlite3.dll"</span><span class="o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="nc">SymbolLookup</span> <span class="n">lookup</span> <span class="o">=</span> <span class="nc">SymbolLookup</span><span class="o">.</span><span class="na">libraryLookup</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">arena</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Bibliothèque chargée avec succès"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">lookup</span><span class="o">;</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>.dll sous Windows, .so sous Linux et .dylib sous MacOS</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Chargement de la bibliothèque sqlite3
Bibliothèque chargée avec succès

WARNING: A restricted method in java.lang.foreign.SymbolLookup has been called
WARNING: java.lang.foreign.SymbolLookup::libraryLookup has been called by fr.sciam.workshop.javase.ffm.MainFFM in an unnamed module
WARNING: Use --enable-native-access=ALL-UNNAMED to avoid a warning for callers in this module
WARNING: Restricted methods will be blocked in a future release unless native access is enabled</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Les méthodes de l&#8217;API FFM annotées <code>@Restricted</code> ne sont pas "sûres".
Les interactions entre code Java et natif comportent des risques intrinsèques.
Une utilisation incorrecte peut amener des problèmes tels qu&#8217;une corruption de la mémoire pouvant amener à un crash de la JVM.
Il est nécessaire d&#8217;autoriser explicitement ces opérations pour ne pas obtenir le warning obtenu ci-dessus.</p>
</div>
<div class="paragraph">
<p>Pour autoriser l&#8217;appel aux méthodes restreintes, il faut ajouter l&#8217;option :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--enable-native-access=ALL-UNNAMED</code> pour des classes chargées du classpath,</p>
</li>
<li>
<p><code>--enable-native-access=M1,M2</code> pour autoriser explicitement pour les modules M1 et M2.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il est également possible de spécifier le comportement en cas d&#8217;accès illégal via l&#8217;option <code>--illegal-native-access</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--illegal-native-access=allow</code> : l&#8217;opération est autorisée (il n&#8217;est alors pas nécessaire d&#8217;ajouter l&#8217;option <code>--enable-native-access</code>)</p>
</li>
<li>
<p><code>--illegal-native-access=warn</code> (par défaut) : la JVM émet un avertissement la première fois qu&#8217;un accès natif illégal est détecté</p>
</li>
<li>
<p><code>--illegal-native-access=deny</code> : la JVM lève une <code>IllegalCallerException</code> à chaque appel natif illégal détecté</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Cela s&#8217;inscrit dans une démarche globale visant à rendre la JVM <a href="https://openjdk.org/jeps/8305968">"intègre par défaut"</a>.
S&#8217;il ne s&#8217;agit que d&#8217;un warning à l&#8217;heure actuelle, il est possible que cela laisse la place à une exception dans de futures versions du JDK, l&#8217;option <code>--illegal-native-access=deny</code> devenant alors celle par défaut.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Ajouter l&#8217;option <code>--enable-native-access=ALL-UNNAMED</code> puis exécuter à nouveau la classe <code>MainFFM</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Si besoin, se référer à la <a href="deroulement.html#options-jvm">mise en œuvre des options de la JVM</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vérifier qu&#8217;il n&#8217;y a plus d&#8217;avertissement affiché :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Chargement de la bibliothèque sqlite3
Bibliothèque chargée avec succès</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_la_localisation_dune_fonction_native"><a class="anchor" href="#_la_localisation_dune_fonction_native"></a>4.2.2.5.2. La localisation d&#8217;une fonction native</h6>
<div class="paragraph">
<p><code>SymbolLookup</code> nous permet de localiser l&#8217;adresse mémoire correspondant à la fonction, via sa méthode <code>find()</code>.
Son type de retour est <code>Optional&lt;MemorySegment&gt;</code>, ce qui permet de gérer le cas où la recherche aurait échoué.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>localiserFonctionNativeOpen</code> afin de localiser la fonction native <code>sqlite3_open()</code> et afficher puis renvoyer le <code>MemorySegment</code> correspondant.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">MemorySegment</span> <span class="nf">localiserFonctionNativeOpen</span><span class="o">(</span><span class="nc">SymbolLookup</span> <span class="n">lookup</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">MemorySegment</span> <span class="n">memorySegment</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="s">"sqlite3_open"</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Fonction sqlite3_open() : "</span> <span class="o">+</span> <span class="n">memorySegment</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">memorySegment</span><span class="o">;</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Localisation de la fonction sqlite3_open()
Fonction sqlite3_open() : MemorySegment{ address: 0x7ff89c77324c, byteSize: 0 }</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_linvocation_dune_fonction_native_downcall"><a class="anchor" href="#_linvocation_dune_fonction_native_downcall"></a>4.2.2.5.3. L&#8217;invocation d&#8217;une fonction native (downcall)</h6>
<div class="paragraph">
<p><code>Linker</code> nous permet d&#8217;obtenir une instance de <code>MethodHandle</code> sur la fonction native.
Pour l&#8217;invoquer, il faut fournir une description de la signature de la méthode.</p>
</div>
<div class="paragraph">
<p>L&#8217;interface <code>FunctionDescriptor</code> via sa fabrique <code>of()</code> permet de définir le type de retour et les paramètres acceptés par la méthode.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compte tenu de la description de la fonction native <code>sqlite3_open()</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="nf">sqlite3_open</span><span class="p">(</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>   <span class="cm">/* Database filename (UTF-8) */</span>
  <span class="n">sqlite3</span> <span class="o">**</span><span class="n">ppDb</span>          <span class="cm">/* OUT: SQLite db handle */</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Compléter la méthode <code>obtenirMethodHandleOpen()</code> pour obtenir le <code>MethodHandle</code> vers la fonction, puis l&#8217;invoquer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">MethodHandle</span> <span class="nf">obtenirMethodHandleOpen</span><span class="o">(</span><span class="nc">Linker</span> <span class="n">linker</span><span class="o">,</span> <span class="nc">MemorySegment</span> <span class="n">memorySegment</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">FunctionDescriptor</span> <span class="n">descripteur</span> <span class="o">=</span> <span class="nc">FunctionDescriptor</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
      <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">,</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="o">);</span>

    <span class="nc">MethodHandle</span> <span class="n">methodHandle</span> <span class="o">=</span> <span class="n">linker</span><span class="o">.</span><span class="na">downcallHandle</span><span class="o">(</span><span class="n">memorySegment</span><span class="o">,</span> <span class="n">descripteur</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MethodHandle obtenu : "</span> <span class="o">+</span> <span class="n">methodHandle</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">methodHandle</span><span class="o">;</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Type de retour de la méthode</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Type du premier paramètre : pointeur vers le nom du fichier <code>.db</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Type du second paramètre : pointeur vers un handle de la base de données</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Obtention d'un MethodHandle vers sqlite3_open()
MethodHandle obtenu : MethodHandle(MemorySegment,MemorySegment)int</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Le <code>MethodHandle</code> peut être invoqué en lui fournissant en paramètres les <code>MemorySegment</code> correspondant aux types attendus.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>invoquerFonctionOpen()</code> en préparant les paramètres sous forme de <code>MemorySegment</code> puis en invoquant la méthode <code>sqlite3_open()</code> via son <code>MethodHandle</code> précédemment obtenu.</p>
</div>
<div class="paragraph">
<p>Afficher le code de retour obtenu (vaut <code>0</code> si l&#8217;opération est un succès).</p>
</div>
<div class="paragraph">
<p>Enfin, renvoyer le <code>MemorySegment</code> correspondant au pointeur vers la base de données (2ème paramètre de la fonction <code>sqlite3_open()</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">MemorySegment</span> <span class="nf">invoquerFonctionOpen</span><span class="o">(</span><span class="kd">final</span> <span class="nc">MethodHandle</span> <span class="n">handle</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">Arena</span> <span class="n">arena</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">nomFichierBaseDeDonnees</span> <span class="o">=</span> <span class="s">"sqlite/ffm.db"</span><span class="o">;</span>
    <span class="nc">MemorySegment</span> <span class="n">segmentNomFichier</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocateFrom</span><span class="o">(</span><span class="n">nomFichierBaseDeDonnees</span><span class="o">);</span>
    <span class="nc">MemorySegment</span> <span class="n">pointeurBase</span> <span class="o">=</span> <span class="n">arena</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">handle</span><span class="o">.</span><span class="na">invokeExact</span><span class="o">(</span><span class="n">segmentNomFichier</span><span class="o">,</span> <span class="n">pointeurBase</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Lien avec la base "</span> <span class="o">+</span> <span class="n">nomFichierBaseDeDonnees</span> <span class="o">+</span> <span class="s">" établi avec succès"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">pointeurBase</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Erreur au chargement de la base : code = "</span> <span class="o">+</span> <span class="n">code</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Erreur lors de l'invocation de la fonction native sqlite3_open"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Invocation de la fonction sqlite3_open()
Lien avec la base sqlite/ffm.db établi avec succès</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_lappel_montant_natif_vers_java_upcall"><a class="anchor" href="#_lappel_montant_natif_vers_java_upcall"></a>4.2.2.5.4. L&#8217;appel montant : natif vers Java (upcall)</h6>
<div class="paragraph">
<p>L&#8217;interface <code>Linker</code> permet également de réaliser des upcalls, à savoir des appels montants depuis le code natif jusqu&#8217;au code Java.</p>
</div>
<div class="paragraph">
<p>Cela se réalise par le biais de la méthode <code>upcallStub()</code> qui prendre en paramètres :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un <code>MethodHandle</code> de la fonction Java à appeler depuis le code natif</p>
</li>
<li>
<p>Une description de cette fonction sous la forme de <code>FunctionDescriptor</code></p>
</li>
<li>
<p>Une instance de type <code>Arena</code></p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
La fonction native <code>sqlite3_trace_v2()</code> permet de configurer des traces avec l&#8217;appel d&#8217;une fonction callback.
Sa signature est la suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">SQLITE_API</span> <span class="kt">int</span> <span class="nf">sqlite3_trace_v2</span><span class="p">(</span>
  <span class="n">sqlite3</span><span class="o">*</span><span class="p">,</span>
  <span class="kt">unsigned</span> <span class="n">uMask</span><span class="p">,</span>
  <span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="n">xCallback</span><span class="p">)(</span><span class="kt">unsigned</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="kt">void</span><span class="o">*</span><span class="p">),</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">pCtx</span>
<span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La méthode de callback Java a déjà été définie : il s&#8217;agit de <code>tracerCallback()</code>.
Constater que sa signature correspond à la fonction de callback attendue par <code>sqlite3_trace_v2()</code>.</p>
</div>
<div class="paragraph">
<p>Dans la méthode <code>configurerUpcall()</code> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Utiliser <code>MethodHandles::lookup</code> pour obtenir un <code>MethodHandle</code> sur la méthode <code>tracerCallback()</code>,</p>
</li>
<li>
<p>créer un <code>FunctionDescriptor</code> correspondant,</p>
</li>
<li>
<p>configurer l&#8217;upcall grâce à <code>Linker::upcallStub</code>,</p>
</li>
<li>
<p>enfin, afficher puis renvoyer l&#8217;instance de <code>MethodHandle</code> correspondant à l&#8217;upcall.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">MemorySegment</span> <span class="nf">configurerUpcall</span><span class="o">(</span><span class="nc">Linker</span> <span class="n">linker</span><span class="o">,</span> <span class="nc">Arena</span> <span class="n">arena</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// Obtention du MethodHandle vers la méthode Java de callback</span>
      <span class="nc">MethodHandle</span> <span class="n">tracerCallbackHandle</span> <span class="o">=</span> <span class="nc">MethodHandles</span><span class="o">.</span><span class="na">lookup</span><span class="o">().</span><span class="na">findStatic</span><span class="o">(</span>
        <span class="nc">MainFFM</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="s">"tracerCallback"</span><span class="o">,</span>
        <span class="nc">MethodType</span><span class="o">.</span><span class="na">methodType</span><span class="o">(</span>
          <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
          <span class="nc">MemorySegment</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
          <span class="nc">MemorySegment</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
          <span class="nc">MemorySegment</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
          <span class="nc">MemorySegment</span><span class="o">.</span><span class="na">class</span>
        <span class="o">)</span>
      <span class="o">);</span>

      <span class="c1">// Descripteur de la méthode Java de callback</span>
      <span class="nc">FunctionDescriptor</span> <span class="n">tracerCallbackDesc</span> <span class="o">=</span> <span class="nc">FunctionDescriptor</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">JAVA_INT</span><span class="o">,</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">,</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">,</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">,</span>
        <span class="nc">ValueLayout</span><span class="o">.</span><span class="na">ADDRESS</span>
      <span class="o">);</span>

      <span class="c1">// Création de l'upcall</span>
      <span class="nc">MemorySegment</span> <span class="n">upcall</span> <span class="o">=</span> <span class="n">linker</span><span class="o">.</span><span class="na">upcallStub</span><span class="o">(</span><span class="n">tracerCallbackHandle</span><span class="o">,</span> <span class="n">tracerCallbackDesc</span><span class="o">,</span> <span class="n">arena</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Upcall obtenu : "</span> <span class="o">+</span> <span class="n">upcall</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">upcall</span><span class="o">;</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="o">|</span> <span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
La méthode <code>invoquerTraceAvecCallbackPuisRequeter()</code> déjà existante se charge d&#8217;appeler la fonction <code>sqlite3_trace_v2()</code> pour configurer les traces avec l&#8217;upcall, ainsi que de réaliser une requête SQL en base pour déclencher l&#8217;appel au callback.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Configuration de l'appel montant (upcall)
Upcall obtenu : MemorySegment{ address: 0x1324c8a0ca0, byteSize: 0 }

Invocation de sqlite3_trace_v2() avec callback et requête en base
Appel de tracerCallback()
MemorySegment{ address: 0x1, byteSize: 0 }
MemorySegment{ address: 0x0, byteSize: 0 }
MemorySegment{ address: 0x132a70713c0, byteSize: 0 }
MemorySegment{ address: 0x132a7073aa0, byteSize: 0 }</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_les_fonctions_natives_renvoyant_un_pointeur"><a class="anchor" href="#_les_fonctions_natives_renvoyant_un_pointeur"></a>4.2.2.5.5. Les fonctions natives renvoyant un pointeur</h6>
<div class="paragraph">
<p>Certaines fonctions natives peuvent renvoyer un pointeur vers une région mémoire.
La JVM n&#8217;a pas la possibilité de connaître la taille ni la structure de cette région, ni même sa durée de vie.
Pour cela, l&#8217;API utilise un <code>MemorySegment</code> de taille nulle pour représenter ce type de pointeur.
Ceci est utilisé pour :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Les pointeurs renvoyés par une fonction native</p>
</li>
<li>
<p>Les pointeurs passés depuis le code natif vers un upcall</p>
</li>
<li>
<p>Les pointeurs lus depuis un <code>MemorySegment</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il est impossible de manipuler directement un tel MemorySegment, sous peine de voir la JVM lever l&#8217;exception <code>IndexOutOfBoundsException</code>.
En effet, elle ne peut pas accéder ou valider en toute sécurité une opération d&#8217;accès à une région mémoire dont la taille est inconnue.</p>
</div>
<div class="paragraph">
<p>La méthode <code>MemorySegment::reinterpret</code> permet de travailler sur de tels segments en y accédant de manière sûre et en rattachant la zone mémoire associée à une <code>Arena</code>.</p>
</div>
<div class="paragraph">
<p>Il existe plusieurs surcharges de cette méthode dont les paramètres font intervenir :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La taille en octet à laquelle le segment va être redimensionné</p>
</li>
<li>
<p>L'<code>Arena</code> à associer avec le <code>MemorySegment</code></p>
</li>
<li>
<p>Une action à exécuter lorsque l'<code>Arena</code> sera fermée, sous la forme d&#8217;un <code>Consumer&lt;MemorySegment&gt;</code></p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Avec SQLite, lorsque l&#8217;on exécute une requête via <code>sqlite3_exec()</code>, on doit fournir le paramètre <code>char **errmsg</code> qui est un pointeur vers la chaîne de caractères contenant un éventuel message d&#8217;erreur.</p>
</div>
<div class="paragraph">
<p>La taille de cette chaîne étant inconnue, il est nécessaire d&#8217;utiliser la méthode <code>MemorySegment::reinterpret</code> pour en lire le contenu, en y affectant une taille arbitraire, mais suffisante.</p>
</div>
<div class="paragraph">
<p>Modifier la chaîne de caractères <code>REQUETE</code> de la classe <code>MainFFM</code> afin d&#8217;ajouter volontairement une erreur de syntaxe pour lever une erreur lors de l&#8217;exécution.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">REQUETE</span> <span class="o">=</span> <span class="s">"xxxSELECT * FROM users"</span><span class="o">;</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ajout des caractères 'xxx' pour lever une erreur de syntaxe</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ensuite, compléter la méthode <code>traiterMessageErreur()</code> afin de lire le message d&#8217;erreur et l&#8217;afficher.
On utilisera une taille de <code>500</code> octets lors de la réinterprétation du <code>MemorySegment</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">MemorySegment</span> <span class="nf">traiterMessageErreur</span><span class="o">(</span><span class="nc">MemorySegment</span> <span class="n">pointeur</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">MemorySegment</span> <span class="n">segmentReinterprete</span> <span class="o">=</span> <span class="n">pointeur</span><span class="o">.</span><span class="na">reinterpret</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">segmentReinterprete</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Erreur : "</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">segmentReinterprete</span><span class="o">;</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainFFM</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Erreur : near "xxxSELECT": syntax error</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="class-file-api"><a class="anchor" href="#class-file-api"></a>4.2.3. Lab : l&#8217;API Class-File</h4>
<div class="paragraph">
<p>L&#8217;API Class-File permet d&#8217;analyser, générer et transformer des fichiers de classe Java.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JDK</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Première preview en Java 22 <a href="https://openjdk.org/jeps/457">JEP 457</a><br>
Seconde en Java 23 <a href="https://openjdk.org/jeps/466">JEP 466</a><br>
Standard en Java 24</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JEP</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://openjdk.org/jeps/484">484: Class-File API</a></p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_les_motivations"><a class="anchor" href="#_les_motivations"></a>4.2.3.1. Les motivations</h5>
<div class="paragraph">
<p>De nombreux frameworks ou bibliothèques manipulent le bytecode afin d&#8217;enrichir les programmes de diverses fonctionnalités, de façon transparente sans avoir à modifier le code source et le recompiler.</p>
</div>
<div class="paragraph">
<p>Par exemple, Quarkus modifie et génère du bytecode à la volée pour réaliser un certain nombre d&#8217;optimisations durant le build.
Hibernate peut générer et modifier des classes dynamiquement pour optimiser l&#8217;accès aux entités en base de données, en ajoutant par exemple des proxies pour le lazy loading.</p>
</div>
<div class="paragraph">
<p>De nombreuses bibliothèques permettent ces manipulations comme <a href="https://asm.ow2.io/">ASM</a>, <a href="https://bytebuddy.net">ByteBuddy</a>, <a href="https://commons.apache.org/proper/commons-bcel/">Apache BCEL</a>, <a href="https://www.javassist.org/">Javassist</a>, <a href="https://github.com/quarkusio/gizmo">Gizmo</a>&#8230;&#8203; chacune avec leurs forces, faiblesses, paradigmes de programmation ou niveau d&#8217;abstraction qui leur sont propres.
Le JDK lui-même se repose sur ASM, notamment pour la génération dynamique de bytecode pour les expressions lambdas via <code>invokedynamic</code>.<br>
Comme une version <em>N</em> du JDK se base sur une version <em>N-1</em> d&#8217;ASM et que le format des fichiers de classe évolue constamment (particulièrement depuis le passage au rythme de release tous les six mois), on est confronté au problème de "l&#8217;œuf et la poule".</p>
</div>
<div class="paragraph">
<p>L&#8217;API Class-File a pour vocation de fournir une API évoluant avec le format officiel, afin d&#8217;assurer une compatibilité immédiate avec les dernières versions du JDK sans dépendre de bibliothèques tierces.</p>
</div>
<div class="paragraph">
<p>Cette API trouve sa place au sein du package <code>java.lang.classfile</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_linterface_java_lang_classfile_classfile"><a class="anchor" href="#_linterface_java_lang_classfile_classfile"></a>4.2.3.2. L&#8217;interface <code>java.lang.classfile.ClassFile</code></h5>
<div class="paragraph">
<p>L&#8217;interface <code>ClassFile</code> représente un contexte pour analyser, transformer et générer des fichiers de classe.
La fabrique <code>ClassFile::of</code> permet d&#8217;en obtenir une instance.</p>
</div>
<div class="paragraph">
<p>On peut lui associer un ensemble d&#8217;options qui conditionnent la manière dont l&#8217;analyse et la génération sont effectuées.
Pour cela, <code>of()</code> possède une surcharge qui accepte des <code>ClassFile.Option</code> sous forme de varargs.</p>
</div>
</div>
<div class="sect4">
<h5 id="_linterface_java_lang_classfile_classmodel"><a class="anchor" href="#_linterface_java_lang_classfile_classmodel"></a>4.2.3.3. L&#8217;interface <code>java.lang.classfile.ClassModel</code></h5>
<div class="paragraph">
<p>Une classe est modélisée par l&#8217;interface <code>ClassModel</code>, qui est une structure arborescente sous forme d&#8217;éléments héritant de <code>ClassElement</code>.</p>
</div>
<div class="paragraph">
<p>Ces éléments, interfaces filles de <code>ClassElement</code> peuvent représenter diverses propriétés de la classe, tels que :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FieldModel</code> pour un champ</p>
</li>
<li>
<p><code>MethodModel</code> pour une méthode</p>
</li>
<li>
<p><code>Superclass</code> pour la classe mère</p>
</li>
<li>
<p><code>Interfaces</code> pour les interfaces que la classe implémente</p>
</li>
<li>
<p><code>ConstantPool</code> pour le pool de constantes</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Il est possible d&#8217;en inspecter la structure grâce notamment aux méthodes <code>ClassModel::fields</code> et <code>ClassModel::methods</code> qui renvoient respectivement la liste des champs et la liste des méthodes de la classe.</p>
</div>
<div class="paragraph">
<p>Chaque "famille" de modèle (<code>ClassModel</code>, <code>MethodModel</code>, <code>FieldModel</code>&#8230;&#8203;) est composée d&#8217;éléments qui lui sont propres (respectivement <code>ClassElement</code>, <code>MethodElement</code>, <code>FieldElement</code>&#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>La <a href="https://docs.oracle.com/en/java/javase/24/docs/api/java.base/java/lang/classfile/package-summary.html#data_model">Javadoc du package <code>java.lang.classfile</code></a> fournit des informations sur le modèle de données et sa structuration.</p>
</div>
</div>
<div class="sect4">
<h5 id="_lanalyse_de_fichiers_de_classe"><a class="anchor" href="#_lanalyse_de_fichiers_de_classe"></a>4.2.3.4. L&#8217;analyse de fichiers de classe</h5>
<div class="paragraph">
<p>L&#8217;interface <code>ClassFile</code> dispose de plusieurs surcharges de la méthode <code>parse()</code> permettant d&#8217;obtenir une instance de <code>ClassModel</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>parse(byte[] bytes)</code> permet de parser un fichier de classe directement à partir de son bytecode</p>
</li>
<li>
<p><code>parse(Path path) throws IOException</code> permet de parser un fichier de classe à partir de son emplacement</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Consulter la classe <code>fr.sciam.workshop.javase.classfile.AccumulateurBasique</code>.</p>
</div>
<div class="paragraph">
<p>Dans la classe <code>fr.sciam.workshop.javase.classfile.MainClassFileAPI</code>, compléter la méthode <code>analyserFichierDeClasse()</code> afin d&#8217;obtenir une instance de <code>ClassModel</code> modélisant la classe <code>AccumulateurBasique</code>.<br>
Utiliser la méthode utilitaire <code>obtenirChemin(Class&lt;?&gt; clazz)</code> de <code>MainClassFileAPI</code> pour obtenir une instance de <code>Path</code> correspondant à la classe <code>AccumulateurBasique</code>.<br>
Enfin, utiliser l&#8217;instance de <code>ClassModel</code> obtenue pour afficher les champs et méthodes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">analyserFichierDeClasse</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Path</span> <span class="n">classFilePath</span> <span class="o">=</span> <span class="n">obtenirChemin</span><span class="o">(</span><span class="nc">AccumulateurBasique</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">ClassModel</span> <span class="n">classModel</span> <span class="o">=</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">classFilePath</span><span class="o">);</span>
    <span class="n">classModel</span><span class="o">.</span><span class="na">fields</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
    <span class="n">classModel</span><span class="o">.</span><span class="na">methods</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainClassFileAPI</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Analyse d'un fichier de classe
FieldModel[fieldName=valeur, fieldType=I, flags=2]
MethodModel[methodName=&lt;init&gt;, methodType=()V, flags=1]
MethodModel[methodName=ajouter, methodType=(I)I, flags=1]</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
On notera la présence du constructeur sans paramètre qui, bien qu&#8217;absent dans notre code source, a été ajouté par le compilateur Java.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p><code>ClassModel</code> étend <code>Iterable&lt;ClassElement&gt;</code>, il est donc possible de parcourir ses éléments en itérant directement sur l&#8217;instance et en utilisant par exemple le pattern matching pour effectuer des traitements propres aux types parcourus.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier la méthode <code>analyserAvecPatternMatching()</code> afin d&#8217;itérer directement sur les éléments du <code>ClassModel</code>.<br>
Utiliser une instruction <code>switch</code> et le pattern matching pour distinguer les éléments de type champ, méthode ou autre.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">analyserAvecPatternMatching</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Path</span> <span class="n">classFilePath</span> <span class="o">=</span> <span class="n">obtenirChemin</span><span class="o">(</span><span class="nc">AccumulateurBasique</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">ClassModel</span> <span class="n">classModel</span> <span class="o">=</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">classFilePath</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">ClassElement</span> <span class="n">element</span> <span class="o">:</span> <span class="n">classModel</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">switch</span> <span class="o">(</span><span class="n">element</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">FieldModel</span> <span class="n">fm</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Champ : %s%n"</span><span class="o">,</span> <span class="n">fm</span><span class="o">.</span><span class="na">fieldName</span><span class="o">().</span><span class="na">stringValue</span><span class="o">());</span>
        <span class="k">case</span> <span class="nc">MethodModel</span> <span class="n">mm</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Méthode : %s%n"</span><span class="o">,</span> <span class="n">mm</span><span class="o">.</span><span class="na">methodName</span><span class="o">().</span><span class="na">stringValue</span><span class="o">());</span>
        <span class="k">default</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Autre élément : %s%n"</span><span class="o">,</span> <span class="n">element</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainClassFileAPI</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Analyse d'un fichier de classe avec le Pattern Matching
Autre élément : AccessFlags[flags=33]
Autre élément : ClassFileVersion[majorVersion=68, minorVersion=0]
Autre élément : Superclass[superclassEntry=java/lang/Object]
Autre élément : Interfaces[interfaces=]
Champ : valeur
Méthode : &#60;init&#62;
Méthode : ajouter
Autre élément : Attribute[name=SourceFile]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p><code>MethodModel</code> modélise une méthode par le biais d&#8217;éléments <code>java.lang.classfile.MethodElement</code>, qui peuvent représenter des propriétés telles que :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les modificateurs d&#8217;accès (<code>public</code>, <code>private</code>, <code>static</code> &#8230;&#8203;) avec <code>AccessFlags</code></p>
</li>
<li>
<p>les exceptions déclarées par la clause <code>throws</code> avec <code>ExceptionsAttribute</code></p>
</li>
<li>
<p>le contenu du corps de la méthode avec <code>CodeModel</code>, constitué d&#8217;éléments <code>CodeElement</code> ordonnés qui représentent les instructions de bas niveau</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br></p>
</div>
<div class="paragraph">
<p>Compléter la méthode <code>analyserMethode()</code> afin d&#8217;afficher les modificateurs d&#8217;accès de la méthode <code>AccumulateurBasique::a</code> ainsi que les instructions qui la composent.
Les éléments <code>CodeElement</code> peuvent être de type <code>Instruction</code> ou <code>PseudoInstruction</code>, on se limitera à l&#8217;affiche des <code>Instruction</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">analyserMethode</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Path</span> <span class="n">classFilePath</span> <span class="o">=</span> <span class="n">obtenirChemin</span><span class="o">(</span><span class="nc">AccumulateurBasique</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">ClassModel</span> <span class="n">classModel</span> <span class="o">=</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">classFilePath</span><span class="o">);</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">MethodModel</span> <span class="n">method</span> <span class="o">:</span> <span class="n">classModel</span><span class="o">.</span><span class="na">methods</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="s">"ajouter"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">methodName</span><span class="o">().</span><span class="na">stringValue</span><span class="o">()))</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">MethodElement</span> <span class="n">methodElement</span> <span class="o">:</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">switch</span> <span class="o">(</span><span class="n">methodElement</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="nc">AccessFlags</span> <span class="n">flags</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Flags : %s%n"</span><span class="o">,</span> <span class="n">flags</span><span class="o">.</span><span class="na">flags</span><span class="o">());</span>
            <span class="k">case</span> <span class="nc">CodeModel</span> <span class="n">code</span> <span class="o">-&gt;</span> <span class="o">{</span>
              <span class="k">for</span> <span class="o">(</span><span class="nc">CodeElement</span> <span class="n">codeElement</span> <span class="o">:</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">codeElement</span> <span class="k">instanceof</span> <span class="nc">Instruction</span> <span class="n">instruction</span><span class="o">)</span> <span class="o">{</span>
                  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Instruction : %s%n"</span><span class="o">,</span> <span class="n">instruction</span><span class="o">);</span>
                <span class="o">}</span>
              <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">default</span> <span class="o">-&gt;</span> <span class="o">{}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainClassFileAPI</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Analyse d'une méthode
Flags : [PUBLIC]
Instruction : Load[OP=ALOAD_0, slot=0]
Instruction : UnboundStackInstruction[op=DUP]
Instruction : Field[OP=GETFIELD, field=fr/sciam/workshop/javase/classfile/AccumulateurBasique.valeur:I]
Instruction : Load[OP=ILOAD_1, slot=1]
Instruction : UnboundOperatorInstruction[op=IADD]
Instruction : Field[OP=PUTFIELD, field=fr/sciam/workshop/javase/classfile/AccumulateurBasique.valeur:I]
Instruction : Load[OP=ALOAD_0, slot=0]
Instruction : Field[OP=GETFIELD, field=fr/sciam/workshop/javase/classfile/AccumulateurBasique.valeur:I]
Instruction : Return[OP=IRETURN]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lécriture_de_fichiers_de_classe"><a class="anchor" href="#_lécriture_de_fichiers_de_classe"></a>4.2.3.5. L&#8217;écriture de fichiers de classe</h5>
<div class="paragraph">
<p>La génération de fichiers de classe se fait par l&#8217;intermédiaire de "builders".<br>
Plutôt que de devoir créer manuellement les instances de builders, l&#8217;API requière de fournir une expression lambda de type <code>Consumer</code> qui "consomme" le builder.<br>
Cette API est "fluent" : les méthodes du builder renvoient l&#8217;instance même du builder, permettant de chaîner les appels.</p>
</div>
<div class="paragraph">
<p>La méthode <code>build(ClassDesc, Consumer&lt;? super ClassBuilder&gt;)</code> permet de générer le bytecode (sous forme de tableau d&#8217;octets <code>byte[]</code>) à partir d&#8217;un descripteur de classe et d&#8217;invocations réalisées sur les builders.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br></p>
</div>
<div class="paragraph">
<p>Dans la méthode <code>ecrireFichierDeClasse()</code>, générer le bytecode correspond à une classe <code>fr.sciam.MaClassGeneree</code>, dont le corps est vide (pour l&#8217;instant).</p>
</div>
<div class="paragraph">
<p>Afficher le contenu du tableau d&#8217;octets <code>byte[]</code> obtenu formaté avec <code>java.util.HexFormat</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">ecrireFichierDeClasse</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ClassDesc</span> <span class="n">classDesc</span> <span class="o">=</span> <span class="nc">ClassDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"fr.sciam.MaClassGeneree"</span><span class="o">);</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="n">classDesc</span><span class="o">,</span> <span class="n">builder</span> <span class="o">-&gt;</span> <span class="o">{});</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Contenu hexadécimal"</span><span class="o">);</span>
    <span class="nc">HexFormat</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">formatHex</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">,</span> <span class="n">bytes</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainClassFileAPI</code> et vérifier que l&#8217;on obtient dans la console quelque chose de la forme :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Écriture d'un fichier de classe
Contenu hexadécimal
cafebabe00000044000501001766722f736369616d2f4d61436c61737347656e657265650700010100106a6176612f6c616e672f4f626a6563740700030001000200040000000000000000</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Le code hexadécimal nous indique que le fichier débute par la séquence <code>0xcafebabe</code> (magic number indiquant un fichier de classe) ainsi que la version <code>0x44</code> (qui correspond à 68 en décimal) identifiant la version 24 de Java.<br>
La documentation complète du format est disponible sur le site d&#8217;Oracle : <a href="https://docs.oracle.com/javase/specs/jvms/se24/html/jvms-4.html">The <code>class</code> File Format</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Le builder <code>ClassBuilder</code> nous permet de générer le contenu de la classe grâce à diverses méthodes, parmi lesquelles :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>withSuperclass()</code> permet de définir la classe mère</p>
</li>
<li>
<p><code>withInterfaceSymbols()</code> permet de définir les interfaces implémentées par notre classe</p>
</li>
<li>
<p><code>withFlags()</code> permet de définir les modificateurs d&#8217;accès à notre classe</p>
</li>
<li>
<p><code>withField()</code> permet d&#8217;ajouter un champ</p>
</li>
<li>
<p><code>withMethod()</code> et <code>withMethodBody()</code> permettent d&#8217;ajouter des méthodes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Certaines de ces méthodes requièrent également un <code>Consumer</code>, par exemple <code>Consumer&lt;MethodBuilder&gt;</code> pour <code>withMethod()</code> ou encore <code>Consumer&lt;CodeBuilder&gt;</code> pour <code>withMethodBody()</code>.<br>
Ce fonctionnement permet de définir, en cascade, le contenu de la classe à générer par l&#8217;invocation successive des builders correspondants.</p>
</div>
<div class="paragraph">
<p>Parmi les autres paramètres requis pour ces méthodes, on retrouve les types :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ClassDesc</code> pour décrire une classe (package, nom), que nous avons déjà utilisé pour définir notre classe</p>
</li>
<li>
<p><code>AccessFlag</code> pour un modificateur d&#8217;accès comme <code>public</code></p>
</li>
<li>
<p><code>int</code> pour le paramètre "methodFlags", pour lequel on peut piocher dans les constantes de <code>ClassFile</code> telles que <code>ClassFile.ACC_PUBLIC</code> ou <code>ClassFile.ACC_STATIC</code> dont les valeurs correspondent au bit de masquage du modificateur.<br>
On peut cumuler les modificateurs en appliquant un "OU" logique <code>|</code> entre les valeurs désirées.</p>
</li>
<li>
<p><code>MethodTypeDesc</code> pour définir le type de retour et le type des paramètres de la méthode :</p>
<div class="ulist">
<ul>
<li>
<p>la fabrique <code>ofDescriptor()</code> accepte une chaîne de caractères correspondant à la signature (par exemple <code>([Ljava/lang/String;)V</code> pour une méthode qui renvoie <code>void</code> et qui accepte un tableau de <code>String</code>)</p>
</li>
<li>
<p>la fabrique <code>of()</code> qui accepte des instances de <code>ClassDesc</code>, dont les plus courantes sont disponibles sous forme de constantes dans la classe <code>ConstantDescs</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br></p>
</div>
<div class="paragraph">
<p>Compléter la méthode <code>ecrireFichierDeClasseAvance()</code> afin de générer une classe <code>MaClasseGenereeAvancee</code> qui :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>étende la classe <code>java.util.Date</code></p>
</li>
<li>
<p>implémente l&#8217;interface <code>java.io.Serializable</code></p>
</li>
<li>
<p>soit <code>final</code></p>
</li>
<li>
<p>définisse une méthode <code>public static void main(String[])</code> via <code>ClassBuilder::withMethodBody</code> dont la seule instruction est <code>return</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Enfin, utiliser la méthode utilitaire <code>MainClassFileAPI::sauvegarderFichier</code> afin de sauvegarder le fichier <code>.class</code> sur le disque.<br>
Pour cela, utiliser les paramètres :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>byte[]</code> : bytes, le tableau d&#8217;octets généré par l&#8217;API ClassFile</p>
</li>
<li>
<p><code>String</code> : "fr/sciam/MaClasseGenereeAvancee.class", le chemin relatif au dossier <code>classfile</code> du project</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">ecrireFichierDeClasseAvancee</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ClassDesc</span> <span class="n">classDesc</span> <span class="o">=</span> <span class="nc">ClassDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"fr.sciam.MaClasseGenereeAvancee"</span><span class="o">);</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">build</span><span class="o">(</span>
      <span class="n">classDesc</span><span class="o">,</span>
      <span class="n">builder</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="c1">// Superclass</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">withSuperclass</span><span class="o">(</span><span class="nc">ClassDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"java.util.Date"</span><span class="o">))</span>

          <span class="c1">// Interfaces</span>
          <span class="o">.</span><span class="na">withInterfaceSymbols</span><span class="o">(</span><span class="nc">ClassDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"java.io.Serializable"</span><span class="o">))</span>

          <span class="c1">// Flags</span>
          <span class="o">.</span><span class="na">withFlags</span><span class="o">(</span><span class="nc">AccessFlag</span><span class="o">.</span><span class="na">FINAL</span><span class="o">)</span>

          <span class="c1">// Méthode main()</span>
          <span class="o">.</span><span class="na">withMethodBody</span><span class="o">(</span>
            <span class="s">"main"</span><span class="o">,</span>
            <span class="nc">MethodTypeDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
              <span class="nc">ConstantDescs</span><span class="o">.</span><span class="na">CD_void</span><span class="o">,</span>
              <span class="nc">ConstantDescs</span><span class="o">.</span><span class="na">CD_String</span><span class="o">.</span><span class="na">arrayType</span><span class="o">()</span>
            <span class="o">),</span>
            <span class="nc">ClassFile</span><span class="o">.</span><span class="na">ACC_PUBLIC</span> <span class="o">|</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">ACC_STATIC</span><span class="o">,</span>
            <span class="nl">CodeBuilder:</span><span class="o">:</span><span class="n">return_</span>
          <span class="o">);</span>
      <span class="o">}</span>
    <span class="o">);</span>

    <span class="n">sauvegarderFichier</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="s">"fr/sciam/MaClasseGenereeAvancee.class"</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainClassFileAPI</code> puis la commande <code>javap</code> du JDK avec l&#8217;option <code>-verbose</code> pour inspecter le fichier de classe généré.</p>
</div>
<div class="listingblock">
<div class="title">Depuis le dossier <code>classfile/</code> contenant la classe générée</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="plain">javap -classpath . -verbose fr.sciam.MaClasseGenereeAvancee</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>final class fr.sciam.MaClasseGenereeAvancee extends java.util.Date implements java.io.Serializable
  minor version: 0
  major version: 68
  flags: (0x0010) ACC_FINAL
  this_class: #2                          // fr/sciam/MaClasseGenereeAvancee
  super_class: #4                         // java/util/Date
  interfaces: 1, fields: 0, methods: 1, attributes: 0
Constant pool:
   #1 = Utf8               fr/sciam/MaClasseGenereeAvancee
   #2 = Class              #1             // fr/sciam/MaClasseGenereeAvancee
   #3 = Utf8               java/util/Date
   #4 = Class              #3             // java/util/Date
   #5 = Utf8               main
   #6 = Utf8               ([Ljava/lang/String;)V
   #7 = Utf8               java/io/Serializable
   #8 = Class              #7             // java/io/Serializable
   #9 = Utf8               Code
{
  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=0, locals=1, args_size=1
         0: return
}</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>L&#8217;API Class-File nous permet d&#8217;interagir avec le "Constant Pool" de classe, pour inspecter ou créer des constantes, par exemple.<br>
Un builder lui est associé : <code>ConstantPoolBuilder</code> dont une instance est obtenue par la méthode <code>ClassBuilder::constantPool</code>.<br>
Parmi les nombreuses méthodes proposées par ce builder, certaines correspondent aux types primitifs <code>int</code>, <code>float</code>, <code>long</code>, &#8230;&#8203; avec <code>intEntry()</code>, <code>floatEntry()</code>, <code>longEntry()</code>, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Le builder <code>FieldBuilder</code> propose les méthodes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>withFlags()</code>, analogue aux builders vus précédemment</p>
</li>
<li>
<p><code>with()</code>, qui accepte un <code>FieldElement</code> qui peut être de type <code>ConstantValueAttribute</code> pour désigner une constante</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br></p>
</div>
<div class="paragraph">
<p>Compléter la méthode <code>ecrireFichierDeClasseAvancee()</code> afin d&#8217;ajouter un champ avec les caractéristiques suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>nommé "YEAR"</p>
</li>
<li>
<p><code>public</code>, <code>static</code> et <code>final</code></p>
</li>
<li>
<p>de type <code>int</code></p>
</li>
<li>
<p>de valeur constante 2025</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">ecrireFichierDeClasseAvancee</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ClassDesc</span> <span class="n">classDesc</span> <span class="o">=</span> <span class="nc">ClassDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"fr.sciam.MaClasseGenereeAvancee"</span><span class="o">);</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">build</span><span class="o">(</span>
      <span class="n">classDesc</span><span class="o">,</span>
      <span class="n">builder</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="c1">// Superclass</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">withSuperclass</span><span class="o">(</span><span class="nc">ClassDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"java.util.Date"</span><span class="o">))</span>

          <span class="c1">// Interfaces</span>
          <span class="o">.</span><span class="na">withInterfaceSymbols</span><span class="o">(</span><span class="nc">ClassDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"java.io.Serializable"</span><span class="o">))</span>

          <span class="c1">// Flags</span>
          <span class="o">.</span><span class="na">withFlags</span><span class="o">(</span><span class="nc">AccessFlag</span><span class="o">.</span><span class="na">FINAL</span><span class="o">)</span>

          <span class="c1">// Field</span>
          <span class="o">.</span><span class="na">withField</span><span class="o">(</span>
            <span class="s">"YEAR"</span><span class="o">,</span>
            <span class="nc">ConstantDescs</span><span class="o">.</span><span class="na">CD_int</span><span class="o">,</span>
            <span class="n">fieldBuilder</span> <span class="o">-&gt;</span>
              <span class="n">fieldBuilder</span>
                <span class="o">.</span><span class="na">withFlags</span><span class="o">(</span><span class="nc">AccessFlag</span><span class="o">.</span><span class="na">PRIVATE</span><span class="o">,</span> <span class="nc">AccessFlag</span><span class="o">.</span><span class="na">STATIC</span><span class="o">,</span> <span class="nc">AccessFlag</span><span class="o">.</span><span class="na">FINAL</span><span class="o">)</span>
                <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="nc">ConstantValueAttribute</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">constantPool</span><span class="o">().</span><span class="na">intEntry</span><span class="o">(</span><span class="mi">2025</span><span class="o">))))</span>

          <span class="c1">// Méthode main()</span>
          <span class="o">.</span><span class="na">withMethodBody</span><span class="o">(</span>
            <span class="s">"main"</span><span class="o">,</span>
            <span class="nc">MethodTypeDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
              <span class="nc">ConstantDescs</span><span class="o">.</span><span class="na">CD_void</span><span class="o">,</span>
              <span class="nc">ConstantDescs</span><span class="o">.</span><span class="na">CD_String</span><span class="o">.</span><span class="na">arrayType</span><span class="o">()</span>
            <span class="o">),</span>
            <span class="nc">ClassFile</span><span class="o">.</span><span class="na">ACC_PUBLIC</span> <span class="o">|</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">ACC_STATIC</span><span class="o">,</span>
            <span class="nl">CodeBuilder:</span><span class="o">:</span><span class="n">return_</span>
          <span class="o">);</span>
      <span class="o">}</span>
    <span class="o">);</span>

    <span class="n">sauvegarderFichier</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="s">"fr/sciam/MaClasseGenereeAvancee.class"</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainClassFileAPI</code> puis la commande <code>javap</code> pour inspecter le fichier de classe généré, et vérifier la présence de la constante dans le "Constant Pool" :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Constant pool:
   #1 = Utf8               fr/sciam/MaClasseGenereeAvancee
   #2 = Class              #1             // fr/sciam/MaClasseGenereeAvancee
   #3 = Utf8               java/util/Date
   #4 = Class              #3             // java/util/Date
   #5 = Utf8               YEAR
   #6 = Utf8               I
   #7 = Integer            2025
   #8 = Utf8               main
   #9 = Utf8               ([Ljava/lang/String;)V
  #10 = Utf8               java/io/Serializable
  #11 = Class              #10            // java/io/Serializable
  #12 = Utf8               ConstantValue
  #13 = Utf8               Code</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Le builder <code>CodeBuilder</code> nous permet de descendre jusqu&#8217;au niveau du code et de ses instructions.
Cela nécessite une certaine connaissance de la JVM et de ses opérations de bas niveau.
La documentation est disponible sur le <a href="https://docs.oracle.com/javase/specs/jvms/se24/html/jvms-6.html">site d&#8217;Oracle</a>.</p>
</div>
<div class="paragraph">
<p>Pour que notre méthode <code>main()</code> générée affiche un traditionnel "Hello World", nous allons avoir besoin :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>d&#8217;invoquer l&#8217;opération <code>getstatic</code> pour obtenir une référence vers le champ statique <code>out</code> (de type <code>java.io.PrintStream</code>) de la classe <code>java.lang.System</code>, sur la pile</p>
</li>
<li>
<p>charger la chaîne de caractères <code>"Hello World"</code> depuis le "Constant Pool" sur la pile via l&#8217;opération <code>ldc</code></p>
</li>
<li>
<p>enfin, invoquer la méthode <code>PrintStream::println</code> sur l&#8217;instance <code>out</code> avec pour paramètre la chaîne de caractères, via l&#8217;opération <code>invokevirtual</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La génération de ces appels successifs d&#8217;opérations de la JVM se fait par l&#8217;intermédiaire des méthodes de <code>CodeBuilder</code> qui portent les noms respectifs : <code>invokevirtual()</code>, <code>loadconstant()</code> et <code>invokevirtual()</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br></p>
</div>
<div class="paragraph">
<p>Compléter la méthode <code>ecrireFichierDeClasseHelloWorld()</code> afin de générer la classe <code>fr.sciam.MonHelloWorld</code> avec une méthode <code>main()</code> qui affiche <code>Hello World</code> dans la console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">ecrireFichierDeClasseHelloWorld</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ClassDesc</span> <span class="n">classDesc</span> <span class="o">=</span> <span class="nc">ClassDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"fr.sciam.MonHelloWorld"</span><span class="o">);</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">build</span><span class="o">(</span>
      <span class="n">classDesc</span><span class="o">,</span>
      <span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span><span class="o">.</span><span class="na">withMethodBody</span><span class="o">(</span>
        <span class="s">"main"</span><span class="o">,</span>
        <span class="nc">MethodTypeDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
          <span class="nc">ConstantDescs</span><span class="o">.</span><span class="na">CD_void</span><span class="o">,</span>
          <span class="nc">ConstantDescs</span><span class="o">.</span><span class="na">CD_String</span><span class="o">.</span><span class="na">arrayType</span><span class="o">()</span>
        <span class="o">),</span>
        <span class="nc">ClassFile</span><span class="o">.</span><span class="na">ACC_PUBLIC</span> <span class="o">|</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">ACC_STATIC</span><span class="o">,</span>
        <span class="n">codeBuilder</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="nc">ClassDesc</span> <span class="n">printStreamClassDesc</span> <span class="o">=</span> <span class="nc">ClassDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"java.io.PrintStream"</span><span class="o">);</span>

          <span class="n">codeBuilder</span><span class="o">.</span><span class="na">getstatic</span><span class="o">(</span>
              <span class="nc">ClassDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"java.lang.System"</span><span class="o">),</span>
              <span class="s">"out"</span><span class="o">,</span>
              <span class="n">printStreamClassDesc</span>
            <span class="o">)</span>
            <span class="o">.</span><span class="na">loadConstant</span><span class="o">(</span><span class="s">"Hello World"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">invokevirtual</span><span class="o">(</span>
              <span class="n">printStreamClassDesc</span><span class="o">,</span>
              <span class="s">"println"</span><span class="o">,</span>
              <span class="nc">MethodTypeDesc</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
                <span class="nc">ConstantDescs</span><span class="o">.</span><span class="na">CD_void</span><span class="o">,</span>
                <span class="nc">ConstantDescs</span><span class="o">.</span><span class="na">CD_Object</span>
              <span class="o">)</span>
            <span class="o">)</span>
            <span class="o">.</span><span class="na">return_</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">)</span>
    <span class="o">);</span>

    <span class="n">sauvegarderFichier</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="s">"fr/sciam/MonHelloWorld.class"</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainClassFileAPI</code> puis la commande <code>javap</code> pour inspecter le fichier de classe généré, et vérifier la séquence d&#8217;instructions de la méthode <code>main()</code>.</p>
</div>
<div class="listingblock">
<div class="title">Depuis le dossier <code>classfile/</code> contenant la classe générée</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="plain">javap -classpath . -verbose fr.sciam.MonHelloWorld</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vérifier que l&#8217;on obtient notamment :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=1, args_size=1
         0: getstatic     #10                 // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #12                 // String Hello World
         5: invokevirtual #18                 // Method java/io/PrintStream.println:(Ljava/lang/Object;)V
         8: return</pre>
</div>
</div>
<div class="paragraph">
<p>Enfin, exécuter la classe <code>fr.sciam.MonHelloWorld</code> avec la commande <code>java</code> et vérifier que le message <code>Hello World</code> s&#8217;affiche dans la console</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ java -classpath . fr.sciam.MonHelloWorld
Hello World</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_la_transformation_de_fichiers_de_classe"><a class="anchor" href="#_la_transformation_de_fichiers_de_classe"></a>4.2.3.6. La transformation de fichiers de classe</h5>
<div class="paragraph">
<p>De très fréquents cas d&#8217;usage consistent à parser un fichier de classe puis opérer un certain nombre de transformations localisées.
On combine alors lecture et écriture dans la même phase en laissant la majorité des éléments non-altérés.</p>
</div>
<div class="paragraph">
<p>L&#8217;API Class-File fournit pour chaque type de builder une méthode <code>with()</code> acceptant le type d&#8217;élément correspondant au builder, afin de passer au builder les éléments qui doivent rester inchangés par le processus de transformation :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>with(ClassElement element)</code> pour <code>ClassBuilder</code></p>
</li>
<li>
<p><code>with(FieldElement element)</code> pour <code>FieldBuilder</code></p>
</li>
<li>
<p><code>with(MethodElement element)</code> pour <code>MethodBuilder</code></p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour faciliter les transformations, l&#8217;API fournit également pour chaque type de modèle :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un transformateur capable d&#8217;opérer sur les éléments du modèle</p>
<div class="ulist">
<ul>
<li>
<p><code>ClassTransform</code> opère sur les éléments <code>ClassElement</code></p>
</li>
<li>
<p><code>MethodTransform</code> opère sur les éléments <code>MethodElement</code></p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>des méthodes de transformation sur le builder pour traiter les éléments enfants</p>
<div class="ulist">
<ul>
<li>
<p><code>ClassBuilder</code> possède les méthodes <code>transformField()</code> et <code>transformMethod()</code></p>
</li>
<li>
<p><code>MethodBuilder</code> possède une méthode <code>transformCode()</code></p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Les transformateurs sont des interfaces fonctionnelles qui s&#8217;expriment de manière pratique sous forme d&#8217;expression lambda définie avec deux paramètres : le builder et l&#8217;élément concernés.</p>
</div>
<div class="listingblock">
<div class="title">Exemple pour <code>ClassTransform</code> où <code>builder</code> est de type <code>ClassBuilder</code> et <code>element</code> de type <code>ClassElement</code></div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">ClassTransform</span> <span class="n">ct</span> <span class="o">=</span> <span class="o">(</span><span class="n">builder</span><span class="o">,</span> <span class="n">element</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
  <span class="c1">// Transformation</span>
<span class="o">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;interface <code>ClassFile</code> fournit la méthode <code>transformClass(ClassModel model, ClassTransform transform)</code> pour appliquer la transformation à l&#8217;instance.
Elle retourne le tableau d&#8217;octets <code>byte[]</code> correspondant au bytecode transformé.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br></p>
</div>
<div class="paragraph">
<p>Consulter la classe <code>fr.sciam.workshop.javase.classfile.AccumulateurAvance</code>.</p>
</div>
<div class="paragraph">
<p>Compléter la méthode <code>transformerFichierDeClasse()</code> afin d&#8217;obtenir une instance de <code>ClassModel</code> correspondante, puis définir le transformateur qui permet de transformer la classe en ajoutant le modificateur <code>synchronized</code> à toutes ses méthodes <code>public</code>.</p>
</div>
<div class="paragraph">
<p>Enfin, appliquer la transformation et sauvegarder le fichier <code>.class</code> dans le répertoire <code>classfile</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Le constructeur étant modélisé par un <code>MethodModel</code>, pour ne pas le transformer on filtrera sur son nom <code>&lt;init&gt;</code> renvoyé par <code>methodName()</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">transformerFichierDeClasse</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="c1">// Obtention du ClassModel correspondant à AccumulateurAvance</span>
    <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">obtenirChemin</span><span class="o">(</span><span class="nc">AccumulateurAvance</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">ClassModel</span> <span class="n">classModel</span> <span class="o">=</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>

    <span class="nc">ClassTransform</span> <span class="n">ct</span> <span class="o">=</span> <span class="o">(</span><span class="n">builder</span><span class="o">,</span> <span class="n">element</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>

      <span class="c1">// Filtrage sur les méthodes publiques (hors constructeur)</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">element</span> <span class="k">instanceof</span> <span class="nc">MethodModel</span> <span class="n">mm</span>
        <span class="o">&amp;&amp;</span> <span class="n">mm</span><span class="o">.</span><span class="na">flags</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="nc">AccessFlag</span><span class="o">.</span><span class="na">PUBLIC</span><span class="o">)</span>
        <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">"&lt;init&gt;"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">mm</span><span class="o">.</span><span class="na">methodName</span><span class="o">().</span><span class="na">stringValue</span><span class="o">()))</span> <span class="o">{</span>

        <span class="c1">// Ajout de la méthode à l'identique avec modificateur synchronized</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">withMethod</span><span class="o">(</span>
          <span class="n">mm</span><span class="o">.</span><span class="na">methodName</span><span class="o">().</span><span class="na">stringValue</span><span class="o">(),</span>
          <span class="n">mm</span><span class="o">.</span><span class="na">methodTypeSymbol</span><span class="o">(),</span>
          <span class="n">mm</span><span class="o">.</span><span class="na">flags</span><span class="o">().</span><span class="na">flagsMask</span><span class="o">(),</span>
          <span class="n">methodBuilder</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">mm</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nl">methodBuilder:</span><span class="o">:</span><span class="n">with</span><span class="o">);</span>
            <span class="n">methodBuilder</span><span class="o">.</span><span class="na">withFlags</span><span class="o">(</span><span class="nc">AccessFlag</span><span class="o">.</span><span class="na">PUBLIC</span><span class="o">,</span> <span class="nc">AccessFlag</span><span class="o">.</span><span class="na">SYNCHRONIZED</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">);</span>

      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// Conservation de l'élément à l'identique</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">};</span>

    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytecode</span> <span class="o">=</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">transformClass</span><span class="o">(</span><span class="n">classModel</span><span class="o">,</span> <span class="n">ct</span><span class="o">);</span>
    <span class="n">sauvegarderFichier</span><span class="o">(</span><span class="n">bytecode</span><span class="o">,</span> <span class="s">"fr/sciam/AccumulateurAvance.class"</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainClassFileAPI</code> puis la commande <code>javap</code> du JDK pour inspecter le fichier de classe généré</p>
</div>
<div class="listingblock">
<div class="title">Depuis le dossier <code>classfile/</code> contenant la classe générée</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="plain">javap -classpath . -verbose fr.sciam.AccumulateurAvance</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vérifier que l&#8217;on obtient notamment :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>  public fr.sciam.workshop.javase.classfile.AccumulateurAvance();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC

[...]

  public synchronized int ajouter(int);
    descriptor: (I)I
    flags: (0x0021) ACC_PUBLIC, ACC_SYNCHRONIZED

[...]

  public synchronized int soustraire(int);
    descriptor: (I)I
    flags: (0x0021) ACC_PUBLIC, ACC_SYNCHRONIZED</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Ce code reste relativement verbeux et force à recréer les éléments que l&#8217;on souhaite transformer à partir de ceux lus, avant de pouvoir les modifier.<br>
Heureusement, l&#8217;API fournit un certain nombre de méthodes statiques pour faciliter un grand nombre de cas d&#8217;usages.</p>
</div>
<div class="paragraph">
<p>Par exemple, pour appliquer des transformations sur des éléments précis du modèle de données :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ClassTransform</code> fournit les méthodes <code>transformingFields()</code>, <code>transformingMethodBodies()</code>, <code>transformingMethods()</code></p>
</li>
<li>
<p><code>MethodTransform</code> fournit la méthode <code>transformingCode()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>ClassTransform</code>, <code>FieldTransform</code>, <code>MethodTransform</code>, <code>CodeTransform</code> fournissent les méthodes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>atStart()</code> pour opérer une transformation avant que tout élément ne soit parcouru</p>
</li>
<li>
<p><code>atEnd()</code> pour opérer une transformation après que tous les éléments ont été parcourus</p>
</li>
<li>
<p><code>andThen()</code> pour chaîner les transformations</p>
</li>
<li>
<p><code>ofStateful()</code> pour fournir un transformateur qui sera appelé à chaque transformation, afin de maintenir un état tout au long du processus de transformation</p>
</li>
<li>
<p><code>endHandler()</code> crée un transformateur qui passe au builder tous les éléments traversés (en invoquant <code>with()</code>), puis invoque à la fin le <code>Consumer</code> passé en paramètres pour effectuer une transformation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>ClassTransform</code>, <code>FieldTransform</code>, <code>MethodTransform</code> fournissent une méthode <code>dropping()</code> qui permet d&#8217;omettre de la transformation les éléments qui répondent au prédicat passé en paramètre, pour le type d&#8217;élément concerné (respectivement <code>ClassElement</code>, <code>FieldElement</code> et <code>MethodElement</code>).</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br></p>
</div>
<div class="paragraph">
<p>Simplifier la méthode <code>transformerFichierDeClasse()</code> en utilisant <code>ClassTransform::transformingMethods</code> et <code>MethodTransform::endHandler</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">transformerFichierDeClasse</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">obtenirChemin</span><span class="o">(</span><span class="nc">AccumulateurAvance</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">ClassModel</span> <span class="n">classModel</span> <span class="o">=</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>

    <span class="c1">// Filtrage sur les méthodes publiques (hors constructeur)</span>
    <span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">MethodModel</span><span class="o">&gt;</span> <span class="n">predicate</span> <span class="o">=</span> <span class="n">methodModel</span> <span class="o">-&gt;</span>
      <span class="n">methodModel</span><span class="o">.</span><span class="na">flags</span><span class="o">().</span><span class="na">has</span><span class="o">(</span><span class="nc">AccessFlag</span><span class="o">.</span><span class="na">PUBLIC</span><span class="o">)</span>
        <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">"&lt;init&gt;"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">methodModel</span><span class="o">.</span><span class="na">methodName</span><span class="o">().</span><span class="na">stringValue</span><span class="o">());</span>

    <span class="c1">// Transformation de la méthode avec ajout du modificateur synchronized</span>
    <span class="nc">MethodTransform</span> <span class="n">mt</span> <span class="o">=</span> <span class="nc">MethodTransform</span><span class="o">.</span><span class="na">endHandler</span><span class="o">(</span><span class="n">builder</span> <span class="o">-&gt;</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">withFlags</span><span class="o">(</span><span class="nc">AccessFlag</span><span class="o">.</span><span class="na">PUBLIC</span><span class="o">,</span> <span class="nc">AccessFlag</span><span class="o">.</span><span class="na">SYNCHRONIZED</span><span class="o">)</span>
    <span class="o">);</span>
    <span class="nc">ClassTransform</span> <span class="n">ct</span> <span class="o">=</span> <span class="nc">ClassTransform</span><span class="o">.</span><span class="na">transformingMethods</span><span class="o">(</span><span class="n">predicate</span><span class="o">,</span> <span class="n">mt</span><span class="o">);</span>

    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytecode</span> <span class="o">=</span> <span class="nc">ClassFile</span><span class="o">.</span><span class="na">of</span><span class="o">().</span><span class="na">transformClass</span><span class="o">(</span><span class="n">classModel</span><span class="o">,</span> <span class="n">ct</span><span class="o">);</span>
    <span class="n">sauvegarderFichier</span><span class="o">(</span><span class="n">bytecode</span><span class="o">,</span> <span class="s">"fr/sciam/AccumulateurAvance.class"</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainClassFileAPI</code> puis la commande <code>javap</code> du JDK pour inspecter le fichier de classe généré, et vérifier que l&#8217;on obtient le même résultat que précédemment.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_le_formatage_et_le_parsing_de_données"><a class="anchor" href="#_le_formatage_et_le_parsing_de_données"></a>4.3. Le formatage et le parsing de données</h3>
<div class="paragraph">
<p>Plusieurs évolutions dans les API concernent le formatage et le parsing de certaines données.</p>
</div>
<div class="sect3">
<h4 id="_lab_le_formatage_des_nombres_compacts"><a class="anchor" href="#_lab_le_formatage_des_nombres_compacts"></a>4.3.1. Lab : le formatage des nombres compacts</h4>
<div class="paragraph">
<p>Le formatage compact des nombres fait référence à la représentation d&#8217;un nombre sous une forme plus courte. Il consiste à appliquer un ensemble de règles sur une valeur numérique pour en obtenir une représentation compacte. Ces règles sont basées sur une Locale, qui détermine les symboles et les règles de formatage utilisés pour les différentes plages de nombres. Elles sont définies par la spécification LDML pour <a href="https://unicode.org/reports/tr35/tr35-numbers.html#Compact_Number_Formats">les formats de nombres compacts</a>.</p>
</div>
<div class="paragraph">
<p>La forme compacte permet un affichage dans un environnement restreint mais aussi facilite la lecture de grand nombre. Par exemple avec la Locale <code>FR</code>,  des nombres comme 1000 peuvent être formatés comme "1 k" (style court) ou "1 millier" (style long). De même, "M" sera utilisé pour million et "Md" pour milliard.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JDK</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard en Java 12</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>OpenJDK Issue</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://bugs.openjdk.org/browse/JDK-8188147">JDK-8188147</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>La classe <code>java.text.CompactNumberFormat</code>, qui hérite de la classe <code>java.text.NumberFormat</code>, permet de formater et analyser un nombre décimal sous sa forme compacte/courte en tenant compte de la Locale avec une gestion de l&#8217;arrondi.</p>
</div>
<div class="paragraph">
<p>Les nombres sont exprimés dans les formats de nombres compacts "court" et "long" grâce à la nouvelle énumération <code>NumberFormat.Style</code> qui propose deux valeurs : <code>LONG</code> et <code>SHORT</code>.</p>
</div>
<div class="sect4">
<h5 id="_le_formatage_compact_par_défaut"><a class="anchor" href="#_le_formatage_compact_par_défaut"></a>4.3.1.1. Le formatage compact par défaut</h5>
<div class="paragraph">
<p>La fabrique <code>getCompactNumberInstance()</code> de <code>NumberFormat</code> sans paramètre renvoie une instance de type <code>CompactNumberFormat</code> pour la Locale par défaut et le style <code>SHORT</code>.</p>
</div>
<div class="paragraph">
<p>Les surcharges de la méthode <code>format()</code> permettent d&#8217;obtenir la représentation compacte de la valeur passée en paramètre.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>formaterSimple()</code> de la classe <code>fr.sciam.workshop.javase.compactformat.MainCompactNumberFormat</code> pour obtenir une instance de type <code>NumberFormat</code> configurée par défaut pour formater la liste <code>nombreRonds</code> et l&#8217;afficher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">formaterSimple</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">NumberFormat</span> <span class="n">fmt</span> <span class="o">=</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">getCompactNumberInstance</span><span class="o">();</span>
    <span class="nc">LongStream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">nombreRonds</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%-12s -&gt; %s\n"</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">fmt</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">n</span><span class="o">)));</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainCompactNumberFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Formatage par défaut
100          -&gt; 100
1000         -&gt; 1 k
10000        -&gt; 10 k
100000       -&gt; 100 k
1000000      -&gt; 1 M
1000001      -&gt; 1 M
10000000     -&gt; 10 M
10000001     -&gt; 10 M
10000000000  -&gt; 10 Md
10000000001  -&gt; 10 Md</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Le caractère d&#8217;espacement utilisé dans le format <code>SHORT</code> pour la Locale <code>FR</code> est NO-BREAK SPACE (<code>U+00A0</code> ou le caractère 160), et non SPACE (<code>U+0020</code> ou le caractère 32).
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_le_formatage_compact_en_précisant_la_locale_et_le_style"><a class="anchor" href="#_le_formatage_compact_en_précisant_la_locale_et_le_style"></a>4.3.1.2. Le formatage compact en précisant la Locale et le style</h5>
<div class="paragraph">
<p>La fabrique <code>getCompactNumberInstance(Locale locale, NumberFormat.Style formatStyle)</code> renvoie une instance de type <code>NumberFormat</code> pour le formatage compact configurée avec la Locale et le style fournis en paramètres.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>formaterAvecLocaleLong()</code> de la classe <code>MainCompactNumberFormat</code> pour obtenir une instance de type <code>CompactNumberFormat</code> configurée par défaut pour formater la liste <code>nombreronds</code> et l&#8217;afficher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">formaterAvecLocaleLong</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">NumberFormat</span> <span class="n">fmt</span> <span class="o">=</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">getCompactNumberInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">FRANCE</span><span class="o">,</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">Style</span><span class="o">.</span><span class="na">LONG</span><span class="o">);</span>
    <span class="nc">LongStream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">nombreRonds</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%-12s -&gt; %s\n"</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">fmt</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">n</span><span class="o">)));</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainCompactNumberFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Formatage avec Locale long
100          -&gt; 100
1000         -&gt; 1 millier
10000        -&gt; 10 mille
100000       -&gt; 100 mille
1000000      -&gt; 1 million
1000001      -&gt; 1 million
10000000     -&gt; 10 million
10000001     -&gt; 10 millions
10000000000  -&gt; 10 milliard</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_la_gestion_de_larrondi"><a class="anchor" href="#_la_gestion_de_larrondi"></a>4.3.1.3. La gestion de l&#8217;arrondi</h5>
<div class="paragraph">
<p>Par défaut le formatage utilise l&#8217;arrondi <code>RoundingMode.HALF_EVEN</code> mais il est possible d&#8217;utiliser d&#8217;autres arrondis en utilisant la méthode <code>setRoundingMode(RoundingMode)</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>formaterAvecArrondi()</code> de la classe <code>MainCompactNumberFormat</code> pour obtenir une instance de type <code>CompactNumberFormat</code> configurée par défaut pour formater la liste <code>nombreArrondis</code>. L&#8217;utiliser pour afficher chaque valeur avec les arrondis <code>HALF_DOWN</code>, <code>HALF_EVEN</code> et <code>HALF_UP</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">formaterAvecArrondi</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">NumberFormat</span> <span class="n">fmt</span> <span class="o">=</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">getCompactNumberInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">FRANCE</span><span class="o">,</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">Style</span><span class="o">.</span><span class="na">SHORT</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%-12s %-12s %-12s %-12s\n"</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="s">"HALF_DOWN"</span><span class="o">,</span> <span class="s">"HALF_EVEN"</span><span class="o">,</span> <span class="s">"HALF_UP"</span><span class="o">);</span>
    <span class="nc">LongStream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">nombresArrondis</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="n">fmt</span><span class="o">.</span><span class="na">setRoundingMode</span><span class="o">(</span><span class="nc">RoundingMode</span><span class="o">.</span><span class="na">HALF_DOWN</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">down</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
      <span class="n">fmt</span><span class="o">.</span><span class="na">setRoundingMode</span><span class="o">(</span><span class="nc">RoundingMode</span><span class="o">.</span><span class="na">HALF_EVEN</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">even</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
      <span class="n">fmt</span><span class="o">.</span><span class="na">setRoundingMode</span><span class="o">(</span><span class="nc">RoundingMode</span><span class="o">.</span><span class="na">HALF_UP</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">up</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%-12s %-12s %-12s %-12s\n"</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">down</span><span class="o">,</span> <span class="n">even</span><span class="o">,</span> <span class="n">up</span><span class="o">);</span>
    <span class="o">});</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainCompactNumberFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Formatage avec arrondi
             HALF_DOWN    HALF_EVEN    HALF_UP
1200         1 k          1 k          1 k
1500         1 k          2 k          2 k
1700         2 k          2 k          2 k
2500         2 k          2 k          3 k
999          999          999          999
9999         10 k         10 k         10 k
999999       1 M          1 M          1 M</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_la_gestion_de_la_partie_décimale"><a class="anchor" href="#_la_gestion_de_la_partie_décimale"></a>4.3.1.4. la gestion de la partie décimale</h5>
<div class="paragraph">
<p>Par défaut, le nombre de chiffres de la partie décimale est 0 mais il est possible de le modifier en utilisant la méthode setMinimumFractionDigits().</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>formaterDecimaux()</code> de la classe <code>MainCompactNumberFormat</code> pour obtenir une instance de type <code>CompactNumberFormat</code> configurée par défaut.
Modifier le nombre de chiffre décimaux entre 0 et 2 pour formater la liste <code>nombreDecimaux</code> et l&#8217;afficher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">formaterDecimaux</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">NumberFormat</span> <span class="n">fmt</span> <span class="o">=</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">getCompactNumberInstance</span><span class="o">();</span>
    <span class="n">fmt</span><span class="o">.</span><span class="na">setMinimumFractionDigits</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">fmt</span><span class="o">.</span><span class="na">setMaximumFractionDigits</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
    <span class="nc">LongStream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">nombresDecimaux</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%-12s -&gt; %s\n"</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">fmt</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">n</span><span class="o">)));</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainCompactNumberFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Formatage des décimaux
101          -&gt; 101
1023         -&gt; 1,02 k
1234         -&gt; 1,23 k
10345        -&gt; 10,35 k
10678        -&gt; 10,68 k
999999       -&gt; 1 M</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_la_personnalisation_des_patterns"><a class="anchor" href="#_la_personnalisation_des_patterns"></a>4.3.1.5. La personnalisation des patterns</h5>
<div class="paragraph">
<p>Il est également possible d&#8217;obtenir une instance personnalisée et définir la manière dont les nombres seront représentés sous une forme plus courte à l&#8217;aide du constructeur <code>CompactNumberFormat(String, DecimalFormatSymbols, String[])</code>.</p>
</div>
<div class="paragraph">
<p>Le format du <code>compactPattern</code> est fourni sous forme d&#8217;un tableau de chaînes de caractères qui peut contenir un à plusieurs motifs dont l&#8217;index dans le tableau correspond au début de  la plage de valeurs 10<sup>index</sup>. Il est décrit dans la section <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/text/CompactNumberFormat.html#compact_number_patterns">Compact Number Patterns</a> de la Javadoc.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>formaterAvecPatterns()</code> de la classe <code>MainCompactNumberFormat</code> pour obtenir une instance de type <code>CompactNumberFormat</code> configurée avec un pattern dédié pour formater la liste <code>nombreRonds</code> et l&#8217;afficher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">formaterAvecPatterns</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">compactPatterns</span> <span class="o">=</span> <span class="o">{</span> <span class="s">""</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="s">"0k"</span><span class="o">,</span> <span class="s">"00k"</span><span class="o">,</span> <span class="s">"000k"</span><span class="o">,</span> <span class="s">"0m"</span><span class="o">,</span> <span class="s">"00m"</span><span class="o">,</span> <span class="s">"000m"</span><span class="o">,</span>
                                 <span class="s">"0md"</span><span class="o">,</span> <span class="s">"00md"</span><span class="o">,</span> <span class="s">"000md"</span><span class="o">,</span> <span class="s">"0t"</span><span class="o">,</span> <span class="s">"00t"</span><span class="o">,</span> <span class="s">"000t"</span> <span class="o">};</span>

    <span class="nc">DecimalFormat</span> <span class="n">decimalFormat</span> <span class="o">=</span> <span class="o">(</span><span class="nc">DecimalFormat</span><span class="o">)</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">getNumberInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">FRANCE</span><span class="o">);</span>

    <span class="nc">CompactNumberFormat</span> <span class="n">fmt</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CompactNumberFormat</span><span class="o">(</span><span class="n">decimalFormat</span><span class="o">.</span><span class="na">toPattern</span><span class="o">(),</span>
        <span class="n">decimalFormat</span><span class="o">.</span><span class="na">getDecimalFormatSymbols</span><span class="o">(),</span> <span class="n">compactPatterns</span><span class="o">);</span>

    <span class="nc">LongStream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">nombreRonds</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%-12s -&gt; %s\n"</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">fmt</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">n</span><span class="o">)));</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainCompactNumberFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Formatage avec patterns
100          -&gt; 100
1000         -&gt; 1k
10000        -&gt; 10k
100000       -&gt; 100k
1000000      -&gt; 1m
1000001      -&gt; 1m
10000000     -&gt; 10m
10000001     -&gt; 10m
10000000000  -&gt; 10md
10000000001  -&gt; 10md</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lextraction_de_la_valeur_dun_nombre_compact"><a class="anchor" href="#_lextraction_de_la_valeur_dun_nombre_compact"></a>4.3.1.6. L&#8217;extraction de la valeur d&#8217;un nombre compact</h5>
<div class="paragraph">
<p>Une instance de type <code>CompactNumberFormat</code> permet aussi d&#8217;analyse une chaîne de caractères contenant un nombre compact en utilisant la méthode <code>parse(String)</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>parser()</code> de la classe <code>MainCompactNumberFormat</code> pour obtenir une instance de type <code>CompactNumberFormat</code> configurée pour la Locale <code>FRANCE</code> et le style <code>LONG</code>, utilisée pour analyser plusieurs chaînes contenant des valeurs compactes en français et les afficher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">parser</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">var</span> <span class="n">nombresTextes</span> <span class="o">=</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"100"</span><span class="o">,</span> <span class="s">"1 millier"</span><span class="o">,</span> <span class="s">"10 mille"</span><span class="o">,</span> <span class="s">"10 millions"</span><span class="o">,</span> <span class="s">"1 milliard"</span><span class="o">);</span>

    <span class="nc">NumberFormat</span> <span class="n">fmt</span> <span class="o">=</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">getCompactNumberInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">FRANCE</span><span class="o">,</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">Style</span><span class="o">.</span><span class="na">LONG</span><span class="o">);</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">n</span> <span class="o">:</span> <span class="n">nombresTextes</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%-12s -&gt; %s\n"</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">fmt</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">n</span><span class="o">));</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ParseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainCompactNumberFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Parser
100          -&gt; 100
1 millier    -&gt; 1000
10 mille     -&gt; 10000
10 millions  -&gt; 10000000
1 milliard   -&gt; 1000000000</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Par défaut, l&#8217;analyse ne prend pas en compte d&#8217;éventuels séparateurs de groupe. La méthode <code>setGroupingUsed(boolean)</code> en lui passant en paramètre la valeur <code>true</code> permet de modifier ce comportement.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>parserAvecGroupe()</code> de la classe <code>MainCompactNumberFormat</code> pour obtenir une instance de type <code>CompactNumberFormat</code> configurée pour la Locale <code>US</code> et le style <code>SHORT</code>, utilisée pour analyser la chaîne <code>"1,000K"</code> avec et la gestion du groupement et les afficher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">parserAvecGroupe</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">texte</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="nc">NumberFormat</span> <span class="n">fmt</span> <span class="o">=</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">getCompactNumberInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">US</span><span class="o">,</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">Style</span><span class="o">.</span><span class="na">SHORT</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">texte</span> <span class="o">=</span> <span class="s">"1,000K"</span><span class="o">;</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%-12s -&gt; %s\n"</span><span class="o">,</span> <span class="n">texte</span><span class="o">,</span> <span class="n">fmt</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">texte</span><span class="o">));</span>
      <span class="n">fmt</span><span class="o">.</span><span class="na">setGroupingUsed</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%-12s -&gt; %s\n"</span><span class="o">,</span> <span class="n">texte</span><span class="o">,</span> <span class="n">fmt</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">texte</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ParseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainCompactNumberFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Parser avec groupe
1,000K       -&gt; 1
1,000K       -&gt; 1000000</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Par défaut, l&#8217;analyse se fait sur la partie entière et la partie décimale. Pour que l&#8217;analyse ne tienne compte que de la partie entière, il faut utiliser la méthode
<code>setParseIntegerOnly()</code> en lui passant en paramètre la valeur <code>true</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>parserEntier()</code> de la classe <code>MainCompactNumberFormat</code> pour obtenir une instance de type <code>CompactNumberFormat</code> configurée pour la Locale <code>FRANCE</code> et le style <code>LONG</code>, utilisée pour analyser la chaîne <code>"1,5 milliers"</code> avec la partie décimale et avec la partie entière uniquement et les afficher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">parserEntier</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">NumberFormat</span> <span class="n">fmt</span> <span class="o">=</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">getCompactNumberInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">FRANCE</span><span class="o">,</span> <span class="nc">NumberFormat</span><span class="o">.</span><span class="na">Style</span><span class="o">.</span><span class="na">LONG</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">texte</span> <span class="o">=</span> <span class="s">"1,5 milliers"</span><span class="o">;</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%-12s -&gt; %s\n"</span><span class="o">,</span> <span class="n">texte</span><span class="o">,</span> <span class="n">fmt</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">texte</span><span class="o">));</span>
      <span class="n">fmt</span><span class="o">.</span><span class="na">setParseIntegerOnly</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%-12s -&gt; %s\n"</span><span class="o">,</span> <span class="n">texte</span><span class="o">,</span> <span class="n">fmt</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">texte</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ParseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainCompactNumberFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Parser entier
1,5 milliers -&gt; 1.5
1,5 milliers -&gt; 1</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&nbsp;</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lab_le_formatage_des_listes_de_chaînes"><a class="anchor" href="#_lab_le_formatage_des_listes_de_chaînes"></a>4.3.2. Lab : le formatage des listes de chaînes</h4>
<div class="paragraph">
<p>La classe <code>java.text.ListFormat</code>, qui hérite de <code>java.text.Format</code>, formate ou analyse une liste de chaînes de caractères en tenant compte des spécificités locales, d&#8217;un type et d&#8217;un style.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JDK</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard en Java 22</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>OpenJDK Issue</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://bugs.openjdk.org/browse/JDK-8041488">JDK-8041488</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Le type détermine la ponctuation entre les chaînes et les mots de liaison, le cas échéant. Trois types de formatages sont proposés via l&#8217;énumération <code>java.text.ListFormat.Type</code> qui contient trois valeurs :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>STANDARD</code> : pour une liste avec "et" (par défaut)</p>
</li>
<li>
<p><code>OR</code> : pour une liste avec  "ou"</p>
</li>
<li>
<p><code>UNIT</code> : pour une liste unitaire soit avec "et" soit avec seulement des virgules selon la <code>Locale</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Le style détermine la façon dont les chaînes sont abrégées ou non. Trois styles de formatages sont également proposés pour chaque type via l&#8217;énumération <code>java.text.ListFormat.Style</code> qui contient trois valeurs :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>FULL</code> : les mots de liaison tels que "et" et "ou" sont écrits en toutes lettres (par défaut)</p>
</li>
<li>
<p><code>SHORT</code> : les mots de liaison sont écrits en entier ou en abrégé, selon la <code>Locale</code></p>
</li>
<li>
<p><code>NARROW</code> : selon la langue, les mots de liaison sont écrits ou omis et les virgules peuvent également être omises</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La surcharge de la méthode <code>getInstance()</code> sans paramètre permet d&#8217;obtenir une instance pour la <code>Locale</code>, le type et le style par défaut.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>formaterParDefaut()</code> de la classe <code>fr.sciam.workshop.javase.listformat.MainListFormat</code> pour obtenir une instance de type <code>ListFormat</code> configurée par défaut pour formatter la liste <code>couleurs</code> et l&#8217;afficher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">formaterParDefaut</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ListFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="n">couleurs</span><span class="o">));</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainListFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Formatage par défaut
vert, orange et rouge</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>La surcharge <code>getInstance(Locale locale, ListFormat.Type type, ListFormat.Style style)</code> permet de préciser la <code>Locale</code>, le type et le style à utiliser.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>formaterAvecLocaleFr()</code> de la classe <code>MainListFormat</code> pour obtenir des instances de type <code>ListFormat</code> configurées avec la <code>Locale.FRANCE</code> et différents types et styles pour formatter la liste <code>couleurs</code> et l&#8217;afficher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">formaterAvecLocaleFr</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ListFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">FRANCE</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">STANDARD</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Style</span><span class="o">.</span><span class="na">FULL</span><span class="o">)</span>
        <span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">couleurs</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ListFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">FRANCE</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">STANDARD</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Style</span><span class="o">.</span><span class="na">NARROW</span><span class="o">)</span>
        <span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">couleurs</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ListFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">FRANCE</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">OR</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Style</span><span class="o">.</span><span class="na">FULL</span><span class="o">)</span>
        <span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">couleurs</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ListFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">FRANCE</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">UNIT</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Style</span><span class="o">.</span><span class="na">NARROW</span><span class="o">)</span>
        <span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">couleurs</span><span class="o">));</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainListFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Formatage avec Locale FR
vert, orange et rouge
vert, orange, rouge
vert, orange ou rouge
vert orange rouge</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Le formatage dépend de la <code>Locale</code> utilisée et s&#8217;y adapte.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>formaterAvecLocaleUs()</code> de la classe <code>MainListFormat</code> pour obtenir une instance de type <code>ListFormat</code> configurée avec <code>Locale.US</code> pour formatter la liste <code>couleurs</code> aux formats <code>STANDARD/FULL</code>, <code>STANDARD/SHORT</code> et <code>OR/FULL</code> et les afficher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">formaterAvecLocaleUs</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ListFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">US</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">STANDARD</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Style</span><span class="o">.</span><span class="na">FULL</span><span class="o">)</span>
        <span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">couleurs</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ListFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">US</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">STANDARD</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Style</span><span class="o">.</span><span class="na">SHORT</span><span class="o">)</span>
        <span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">couleurs</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ListFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">US</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">OR</span><span class="o">,</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">Style</span><span class="o">.</span><span class="na">FULL</span><span class="o">)</span>
        <span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">couleurs</span><span class="o">));</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainListFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Formatage avec Locale US
vert, orange, and rouge
vert, orange, &amp; rouge
vert, orange, or rouge</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Il est également possible d&#8217;obtenir une instance indépendante de la <code>Locale</code>, du type et du style à l&#8217;aide de la surcharge <code>getInstance(String[])</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>formaterAvecPatterns()</code> de la classe <code>MainListFormat</code> pour obtenir une instance de type <code>ListFormat</code> configurée pour formater la liste <code>couleurs</code> avec des patterns dédiés et l&#8217;afficher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">formaterAvecPatterns</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ListFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"{0} et {1}"</span><span class="o">,</span> <span class="s">"{0} puis {1}"</span><span class="o">,</span> <span class="s">"{0} et finalement {1}"</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="s">"{0} puis {1} et finalement {2}"</span><span class="o">})</span>
        <span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">couleurs</span><span class="o">));</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainListFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Formatage avec patterns
vert puis orange et finalement rouge</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Pour le détail du contenu des patterns dans le tableau de chaîne de caractères, il faut consulter la <a href="https://docs.oracle.com/en/java/javase/24/docs/api//java.base/java/text/ListFormat.Style.html">Javadoc de la classe <code>java.text.ListFormat</code></a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La classe <code>ListFormat</code> peut aussi analyser une chaîne formatée selon la <code>Locale</code>, le type et le style fournis pour extraire une <code>List&lt;String&gt;</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>parser()</code> de la classe <code>MainListFormat</code> pour obtenir une instance de type <code>ListFormat</code> configurée par défaut pour analyser une chaîne et en extraire les différentes chaînes  et les afficher.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">parser</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">elements</span> <span class="o">=</span> <span class="nc">ListFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">()</span>
          <span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"Ni, Cu, Zn et Fe"</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">elements</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ParseException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainListFormat</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Parser
[Ni, Cu, Zn, Fe]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&nbsp;</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_la_programmation_parallèle_et_concurrente"><a class="anchor" href="#_la_programmation_parallèle_et_concurrente"></a>4.4. La programmation parallèle et concurrente</h3>
<div class="paragraph">
<p>Plusieurs API concernent des évolutions relatives à la programmation parallèle et concurrente.</p>
</div>
<div class="sect3">
<h4 id="threads-virtuels"><a class="anchor" href="#threads-virtuels"></a>4.4.1. Lab : les threads virtuels</h4>
<div class="paragraph">
<p>Un thread virtuel est un nouveau type de thread "léger" géré dans la JVM.
Contrairement aux threads conventionnels pour lesquels il existe un mapping un-pour-un avec les threads de l&#8217;OS, un thread virtuel n&#8217;est pas spécifiquement lié à un thread de l&#8217;OS.</p>
</div>
<div class="paragraph">
<p>La JVM possède un <code>ForkJoinPool</code> de threads "porteurs" (carrier threads) dont le rôle est d&#8217;exécuter les traitements non bloquants des threads virtuels. Les threads virtuels dont les opérations sont bloquantes peuvent être détachés de leur thread porteur, rendant ce dernier disponible pour exécuter des traitements d&#8217;autres threads virtuels.</p>
</div>
<div class="paragraph">
<p>Ils présentent donc un avantage lorsqu&#8217;ils réalisent majoritairement des opérations non intensives en CPU puisque l&#8217;on mutualise des threads de l&#8217;OS, évitant ainsi d&#8217;en créer de nouveaux.</p>
</div>
<div class="paragraph">
<p>D&#8217;un point de vue utilisateur, les threads virtuels héritent de <code>java.lang.Thread</code> pour des raisons de compatibilité.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JDK</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Première preview en Java 19 <a href="https://openjdk.org/jeps/425">JEP 425</a><br>
Standard en Java 21</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JEP</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://openjdk.org/jeps/444">444: Virtual Threads</a></p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_la_création_et_le_démarrage_dun_thread_virtuel"><a class="anchor" href="#_la_création_et_le_démarrage_dun_thread_virtuel"></a>4.4.1.1. La création et le démarrage d&#8217;un thread virtuel</h5>
<div class="paragraph">
<p>La classe <code>java.lang.Thread</code> est enrichie de nouvelles méthodes, notamment <code>startVirtualThread()</code> qui permet de créer et démarrer un thread virtuel qui exécute le <code>Runnable</code> passé en paramètre.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>creerEtDemarrerThreadVirtuel</code> de la classe <code>fr.sciam.workshop.javase.virtualthreads.MainThreadsVirtuels</code> afin de créer et démarrer un thread virtuel qui affiche son nom et un message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">creerEtDemarrerThreadVirtuel</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">" Bonjour depuis un thread virtuel"</span><span class="o">);</span>
    <span class="nc">Thread</span> <span class="n">monThreadVirtuel</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">startVirtualThread</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
    <span class="n">monThreadVirtuel</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainThreadsVirtuels</code> et vérifier qu&#8217;elle affiche dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>VirtualThread[#30]/runnable@ForkJoinPool-1-worker-1 Bonjour depuis un thread virtuel</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>L&#8217;interface scellée <code>Thread.Builder</code> permet de configurer et obtenir une instance de thread virtuel. Elle possède deux interfaces filles <code>Thread.Builder.OfVirtual</code> et <code>Thread.Builder.OfPlatform</code> respectivement pour configurer et obtenir une instance d&#8217;un thread virtuel ou d&#8217;un thread de la plateforme.</p>
</div>
<div class="paragraph">
<p>La classe <code>Thread</code> propose les fabriques :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Thread.ofVirtual()</code> pour obtenir une instance de <code>Thread.Builder.OfVirtual</code></p>
</li>
<li>
<p><code>Thread.ofPlatform()</code> pour obtenir une instance de <code>Thread.Builder.OfPlatform</code>.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>creerThreadsVirtuelsAvecFabrique()</code> afin d&#8217;utiliser la fabrique <code>ofVirtual()</code> pour obtenir un <code>Thread.Builder</code> et invoquer ses méthodes <code>start()</code> et <code>unstarted()</code> pour créer deux threads virtuels dont le premier est démarré.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">creerThreadsVirtuelsAvecFabrique</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Runnable</span> <span class="n">r1</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">" Thread t1 créé et démarré avec ofVirtual()"</span><span class="o">);</span>
    <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">ofVirtual</span><span class="o">().</span><span class="na">start</span><span class="o">(</span><span class="n">r1</span><span class="o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="nc">Runnable</span> <span class="n">r2</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">" Thread t2 créé avec ofVirtual()"</span><span class="o">);</span>
    <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">ofVirtual</span><span class="o">().</span><span class="na">unstarted</span><span class="o">(</span><span class="n">r2</span><span class="o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
    <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Crée et démarre un thread virtuel qui exécute le <code>Runnable</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Crée, mais ne démarre pas un thread virtuel avec le <code>Runnable</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainThreadsVirtuels</code> et vérifier que seul le premier thread a été démarré. La console doit afficher dans la console un message de la forme :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>VirtualThread[#33]/runnable@ForkJoinPool-1-worker-1 Thread t1 créé et démarré avec ofVirtual()</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>L&#8217;interface <code>Thread.Builder</code> permet de paramétrer le nommage des threads créés.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Dans la méthode <code>creerThreadsNommesAvecFabrique()</code>, configurer le builder via la méthode <code>name()</code> afin de nommer les threads créés avec celle-ci <code>MonThreadNommé</code>. Démarrer deux threads avec le builder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">creerThreadsNommesAvecFabrique</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">ofVirtual</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"MonThreadNommé"</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">start</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Thread 1 "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">())).</span><span class="na">join</span><span class="o">();</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">start</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Thread 2 "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">())).</span><span class="na">join</span><span class="o">();</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainThreadsVirtuels</code> pour vérifier que les threads créés avec cette fabrique sont nommés :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Thread 1 VirtualThread[#35,MonThreadNommé]/runnable@ForkJoinPool-1-worker-1
Thread 2 VirtualThread[#36,MonThreadNommé]/runnable@ForkJoinPool-1-worker-1</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>La méthode <code>name(String)</code> nomme tous les threads créés de la même manière. La surcharge <code>name(String, int)</code> permet de nommer en ajoutant un suffixe avec un numéro qui s&#8217;incrémente afin de différencier les threads. La valeur entière passée en paramètre indique le numéro de départ.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier la méthode <code>creerThreadsNumerotesAvecFabrique()</code> pour :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>définir l&#8217;implémentation d&#8217;un <code>Runnable</code> qui affiche le thread courant</p>
</li>
<li>
<p>configurer le builder avec le nommage incrémental.</p>
</li>
<li>
<p>démarrer 5 threads qui exécutent le <code>Runnable</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">creerThreadsNumerotesAvecFabrique</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">ofVirtual</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"BaseNom-"</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">runnable</span><span class="o">).</span><span class="na">join</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainThreadsVirtuels</code> pour vérifier que les threads créés avec cette fabrique sont nommés :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>VirtualThread[#36,BaseNom-0]/runnable@ForkJoinPool-1-worker-2
VirtualThread[#37,BaseNom-1]/runnable@ForkJoinPool-1-worker-2
VirtualThread[#38,BaseNom-2]/runnable@ForkJoinPool-1-worker-1
VirtualThread[#39,BaseNom-3]/runnable@ForkJoinPool-1-worker-1
VirtualThread[#40,BaseNom-4]/runnable@ForkJoinPool-1-worker-1</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>La classe utilitaire <code>java.util.concurrent.Executors</code> fournit par l&#8217;intermédiaire de sa fabrique <code>newVirtualThreadPerTaskExecutor()</code> une instance d'<code>ExecutorService</code> permettant de soumettre des tâches qui seront exécutées par des threads virtuels.
Comme son nom l&#8217;indique, chaque tâche soumise est exécutée dans un nouveau thread virtuel compte tenu de leur faible coût de création.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Depuis le JDK 19, la classe <code>ExecutorService</code> implémente l&#8217;interface <code>AutoCloseable</code> : une instance est gérable par un try-with-resources.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Dans la méthode <code>creerThreadsVirtuelsAvecExecuteur()</code>, utiliser la fabrique <code>newVirtualThreadPerTaskExecutor()</code> pour soumettre des tâches à exécuter par des threads virtuels.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">creerThreadsVirtuelsAvecExecuteur</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newVirtualThreadPerTaskExecutor</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Tache 1 "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()));</span>
      <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Tache 2 "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()));</span>
      <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Tache 3 "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()));</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainThreadsVirtuels</code> et vérifier qu&#8217;un thread virtuel dédié a été employé pour chaque tâche.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Tache 1 - VirtualThread[#42]/runnable@ForkJoinPool-1-worker-1
Tache 2 - VirtualThread[#43]/runnable@ForkJoinPool-1-worker-2
Tache 3 - VirtualThread[#45]/runnable@ForkJoinPool-1-worker-3</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_les_propriétés_et_restrictions_des_threads_virtuels"><a class="anchor" href="#_les_propriétés_et_restrictions_des_threads_virtuels"></a>4.4.1.2. Les propriétés et restrictions des threads virtuels</h5>
<div class="paragraph">
<p>Un thread virtuel est soumis à certaines restrictions :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>il est obligatoirement un thread démon,</p>
</li>
<li>
<p>sa priorité est obligatoirement <code>Thread.NORM_PRIORITY</code>,</p>
</li>
<li>
<p>les méthodes <code>stop()</code>, <code>resume()</code> et <code>suspend()</code> lèvent une <code>UnsupportedOperationException</code>,</p>
</li>
<li>
<p>il ne peut pas être associé à un <code>ThreadGroup</code>,</p>
</li>
<li>
<p>la méthode <code>getThreadGroup()</code> renvoie un groupe fictif vide nommé "VirtualThreads",</p>
</li>
<li>
<p>la méthode <code>getAllStackTraces()</code> renvoie désormais une <code>Map</code> qui ne contient que les threads de la plateforme plutôt que tous les threads.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>testerProprietesDuThreadVirtuel()</code> afin de vérifier un certain nombre des propriétés énoncées.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testerProprietesDuThreadVirtuel</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">ofVirtual</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"ThreadVirtuel-"</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">start</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1_000</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">});</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"isVirtual   : "</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="na">isVirtual</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"priority    : "</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="na">getPriority</span><span class="o">()</span> <span class="o">+</span> <span class="s">" (Thread.NORM_PRIORITY = "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">NORM_PRIORITY</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"isDeamon    : "</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="na">isDaemon</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"threadgroup : "</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="na">getThreadGroup</span><span class="o">());</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="n">thread</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">UnsupportedOperationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">thread</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainThreadsVirtuels</code> et vérifier les informations affichées :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>isVirtual   : true
priority    : 5 (Thread.NORM_PRIORITY = 5)
isDeamon    : true
threadgroup : java.lang.ThreadGroup[name=VirtualThreads,maxpri=10]
java.lang.UnsupportedOperationException
	at java.base/java.lang.Thread.stop(Thread.java:1654)
	at fr.sciam.workshop.javase.virtualthreads.MainThreadsVirtuels.testerProprietesDuThreadVirtuel(MainThreadsVirtuels.java:83)
	at fr.sciam.workshop.javase.virtualthreads.MainThreadsVirtuels.main(MainThreadsVirtuels.java:26)</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Les traitements d&#8217;un thread virtuels sont exécutés par un thread du <code>ForkJoinPool</code> dédié de la JVM. Lorsqu&#8217;un thread virtuel réalise une opération bloquante, il est détaché de son thread porteur. Lorsque le traitement bloquant se termine, son exécution pourra être réalisée par un autre thread porteur du pool.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Dans la méthode <code>creerThreadsVirtuelsEtAfficherPorteurs()</code>, créer plusieurs threads virtuels qui effectuent des opérations bloquantes à plusieurs reprises et afficher à chaque fois le thread porteur.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">creerThreadsVirtuelsEtAfficherPorteurs</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">resultat</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="c1">// Démarrage des threads et attente</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Thread</span><span class="o">&gt;</span> <span class="n">threads</span> <span class="o">=</span> <span class="nc">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
      <span class="o">.</span><span class="na">mapToObj</span><span class="o">(</span><span class="n">index</span> <span class="o">-&gt;</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">ofVirtual</span><span class="o">().</span><span class="na">start</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">executerTraitement</span><span class="o">(</span><span class="n">resultat</span><span class="o">)))</span>
      <span class="o">.</span><span class="na">toList</span><span class="o">();</span>

    <span class="k">for</span> <span class="o">(</span><span class="nc">Thread</span> <span class="n">thread</span> <span class="o">:</span> <span class="n">threads</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">thread</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// Affichage du résultat de l'exécution</span>
    <span class="n">resultat</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">threadId</span><span class="o">,</span> <span class="n">list</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\nThread virtuel #"</span> <span class="o">+</span> <span class="n">threadId</span><span class="o">);</span>
      <span class="n">list</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"    "</span> <span class="o">+</span> <span class="n">s</span><span class="o">));</span>
    <span class="o">});</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">executerTraitement</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">resultat</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="kt">long</span> <span class="n">threadId</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">threadId</span><span class="o">();</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">resultat</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">threadId</span><span class="o">,</span> <span class="n">key</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;());</span>
      <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>

      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Utilisation d&#8217;une map pour stocker l&#8217;historique des threads porteurs</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainThreadsVirtuels</code> et vérifier que lorsque le même thread virtuel est exécuté, cela peut être par des threads porteurs différents.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Thread virtuel #32
    VirtualThread[#32]/runnable@ForkJoinPool-1-worker-2
    VirtualThread[#32]/runnable@ForkJoinPool-1-worker-3
    VirtualThread[#32]/runnable@ForkJoinPool-1-worker-2
    VirtualThread[#32]/runnable@ForkJoinPool-1-worker-3
    VirtualThread[#32]/runnable@ForkJoinPool-1-worker-1
    VirtualThread[#32]/runnable@ForkJoinPool-1-worker-2

Thread virtuel #33
    VirtualThread[#33]/runnable@ForkJoinPool-1-worker-3
    VirtualThread[#33]/runnable@ForkJoinPool-1-worker-1
    VirtualThread[#33]/runnable@ForkJoinPool-1-worker-1
    VirtualThread[#33]/runnable@ForkJoinPool-1-worker-2
    VirtualThread[#33]/runnable@ForkJoinPool-1-worker-3
    VirtualThread[#33]/runnable@ForkJoinPool-1-worker-3

Thread virtuel #30
    VirtualThread[#30]/runnable@ForkJoinPool-1-worker-1
    VirtualThread[#30]/runnable@ForkJoinPool-1-worker-2
    VirtualThread[#30]/runnable@ForkJoinPool-1-worker-1
    VirtualThread[#30]/runnable@ForkJoinPool-1-worker-1
    VirtualThread[#30]/runnable@ForkJoinPool-1-worker-2
    VirtualThread[#30]/runnable@ForkJoinPool-1-worker-1</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Il existe cependant quelques situations dans lesquelles le thread virtuel reste "épinglé" (pinned) au même thread porteur :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>jusqu&#8217;au JDK 24, l&#8217;exécution de code au sein d&#8217;un bloc <code>synchronized</code>. Mais cela a été résolu grâce à la <a href="https://openjdk.org/jeps/491">JEP 491 : Synchronize Virtual Threads without Pinning</a>. À partir du JDK 24, ce n&#8217;est donc plus un cas de figure qui provoque un cas de "pinning"</p>
</li>
<li>
<p>l&#8217;exécution d&#8217;une méthode <code>native</code>, lors d&#8217;un "upcall" (appel natif vers Java) dans lequel le code exécuté côté Java est bloquant</p>
</li>
<li>
<p>certains rares cas d&#8217;initialisation de classe explicités dans la JEP 491</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ces cas d&#8217;usages font perdre l&#8217;intérêt de l&#8217;utilisation des threads virtuels : ils restent associés à leurs threads porteurs et les bloquent.</p>
</div>
<div class="paragraph">
<p>L&#8217;événement JFR <code>jdk.VirtualThreadPinned</code> permet de tracer ces cas de "pinning".
Par défaut, il est déclenché pour les blocages au-delà d&#8217;un seuil de 20ms et la stackTrace associée est activée.</p>
</div>
<div class="paragraph">
<p>Voici un exemple d&#8217;un tel événement :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>jdk.VirtualThreadPinned {
  startTime = 17:04:34.528 (2025-03-19)
  duration = 99,0 ms
  blockingOperation = "LockSupport.park"
  pinnedReason = "Native or VM frame on stack"
  carrierThread = "ForkJoinPool-1-worker-1" (javaThreadId = 52)
  eventThread = "" (javaThreadId = 51, virtual)
  stackTrace = [
    java.lang.VirtualThread.parkOnCarrierThread(boolean, long) line: 834
    java.lang.VirtualThread.parkNanos(long) line: 802
    java.lang.VirtualThread.sleepNanos(long) line: 967
    java.lang.Thread.sleepNanos(long) line: 480
    java.lang.Thread.sleep(long) line: 513
    QsortPin$Qsort.qsortCompare(MemorySegment, MemorySegment) line: 77
    QsortPin.qsortTest(int[], Arena) line: 101
    QsortPin.lambda$main$1(Arena) line: 120
    java.lang.VirtualThread.run(Runnable) line: 466
    jdk.internal.vm.Continuation.enterSpecial(Continuation, boolean, boolean)
  ]
}</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="structured-concurrency"><a class="anchor" href="#structured-concurrency"></a>4.4.2. Lab : la Structured Concurrency</h4>
<div class="paragraph">
<p>Écrire du code multi-threadé est souvent une tâche délicate.
La JEP 462 : Structured Concurrency propose un modèle de programmation visant à en simplifier l&#8217;écriture en traitant comme une seule unité de travail un certain nombre de sous-tâches, améliorant ainsi la gestion des erreurs, l&#8217;annulation ainsi que la fiabilité et l&#8217;observabilité.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JDK</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Première incubation en Java 19 <a href="https://openjdk.org/jeps/428">JEP 428</a><br>
Seconde incubation en Java 20 <a href="https://openjdk.org/jeps/437">JEP 437</a><br>
Première preview en Java 21 <a href="https://openjdk.org/jeps/453">JEP 453</a><br>
Seconde preview en Java 22 <a href="https://openjdk.org/jeps/462">JEP 462</a><br>
Troisième preview en Java 23 <a href="https://openjdk.org/jeps/480">JEP 480</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JEP</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://openjdk.org/jeps/499">499: Structured Concurrency (Fourth Preview)</a></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
En Java 24, cette fonctionnalité est <a href="deroulement.html#preview">en preview</a>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_le_fonctionnement_général"><a class="anchor" href="#_le_fonctionnement_général"></a>4.4.2.1. Le fonctionnement général</h5>
<div class="paragraph">
<p>La classe principale de l&#8217;API Structured Concurrency est la classe <code>java.util.concurrent.StructuredTaskScope</code>.</p>
</div>
<div class="paragraph">
<p>Sa mise en œuvre implique les étapes suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Création d&#8217;une instance dans un <code>try</code>-with-resources (<code>StructuredTaskScope</code> implémente <code>AutoCloseable</code>)</p>
</li>
<li>
<p>Définition des sous-tâches sous forme d&#8217;instances de <code>Callable&lt;T&gt;</code></p>
</li>
<li>
<p>Invocation de la méthode <code>fork()</code> pour chaque sous-tâche à exécuter</p>
</li>
<li>
<p>Appel à la méthode <code>joinUntil()</code> ou <code>join()</code> de <code>StructuredTaskScope</code> pour attendre la fin de l&#8217;exécution (respectivement avec ou sans timeout)</p>
</li>
<li>
<p>Exploitation des résultats sous forme d&#8217;instances de type <code>StructuredTaskScope.Subtask&lt;T&gt;</code></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Les sous-tâches sont exécutées dans des threads virtuels, fonctionnalité détaillée dans le lab <a href="_les_évolutions_dans_les_api.html#threads-virtuels">les threads virtuels</a>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Dans le package <code>fr.sciam.workshop.javase.structuredconcurrency</code>, consulter l&#8217;interface <code>ServiceMeteo</code>.</p>
</div>
<div class="paragraph">
<p>Dans la classe <code>MainStructuredConcurrency</code>, compléter la méthode <code>creerBulletinMeteo()</code> afin de réaliser les actions suivantes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Utiliser une instance de <code>StructuredTaskScope</code> pour créer des sous-tâches pour récupérer les températures de plusieurs <code>Ville</code> via l&#8217;instance <code>serviceMeteoPrincipal</code> de type <code>ServiceMeteo</code></p>
</li>
<li>
<p>Exploiter les résultats des sous-tâches pour construire un appel à <code>ServiceMeteo::afficherBulletin</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">creerBulletinMeteo</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

    <span class="k">try</span> <span class="o">(</span><span class="nc">StructuredTaskScope</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">scope</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StructuredTaskScope</span><span class="o">&lt;&gt;())</span> <span class="o">{</span>

      <span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">nice</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoPrincipal</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">NICE</span><span class="o">));</span>
      <span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">paris</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoPrincipal</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">PARIS</span><span class="o">));</span>
      <span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">pontAMousson</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoPrincipal</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">PONT_A_MOUSSON</span><span class="o">));</span>
      <span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">toulon</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoPrincipal</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">TOULON</span><span class="o">));</span>

      <span class="n">scope</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>

      <span class="n">serviceMeteoPrincipal</span><span class="o">.</span><span class="na">afficherBulletin</span><span class="o">(</span>
        <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
          <span class="nc">Villes</span><span class="o">.</span><span class="na">NICE</span><span class="o">,</span> <span class="n">nice</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span>
          <span class="nc">Villes</span><span class="o">.</span><span class="na">PARIS</span><span class="o">,</span> <span class="n">paris</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span>
          <span class="nc">Villes</span><span class="o">.</span><span class="na">PONT_A_MOUSSON</span><span class="o">,</span> <span class="n">pontAMousson</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span>
          <span class="nc">Villes</span><span class="o">.</span><span class="na">TOULON</span><span class="o">,</span> <span class="n">toulon</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>
        <span class="o">)</span>
      <span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainStructuredConcurrency</code> et vérifier que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Création du bulletin météo
Paris : 16.0
Nice : 18.0
Pont-à-Mousson : 13.0
Toulon : 17.0</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Il est préférable de faire appel à la méthode <code>joinUntil()</code> afin d&#8217;avoir un timeout lors de l&#8217;attente de l&#8217;aboutissement de toutes les sous-tâches.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier à nouveau la méthode <code>creerBulletinMeteo()</code> pour utiliser un timeout de 20 secondes et afficher la stacktrace en cas de <code>TimeoutException</code>.</p>
</div>
<div class="listingblock">
<div class="title">Ajout d&#8217;un timeout</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">scope</span><span class="o">.</span><span class="na">joinUntil</span><span class="o">(</span><span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusSeconds</span><span class="o">(</span><span class="mi">20</span><span class="o">));</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Gestion de l&#8217;exception</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TimeoutException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainStructuredConcurrency</code> et constater que l&#8217;on obtient le même résultat que précédemment.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Si le temps d&#8217;attente dépasse le délai accordé par le timeout passé en paramètre de <code>joinUntil()</code>, alors les sous-tâches en cours seront terminées et une exception de type <code>TimeoutException</code> est levée.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier à nouveau la méthode <code>creerBulletinMeteo()</code> pour réduire le timeout à 1 seconde.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">scope</span><span class="o">.</span><span class="na">joinUntil</span><span class="o">(</span><span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusSeconds</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainStructuredConcurrency</code> et constater que l&#8217;on obtient dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Création du bulletin météo
ServiceMeteoPrincipal : interruption lors de l'obtention de la température de Paris
ServiceMeteoPrincipal : interruption lors de l'obtention de la température de Toulon
ServiceMeteoPrincipal : interruption lors de l'obtention de la température de Nice
ServiceMeteoPrincipal : interruption lors de l'obtention de la température de Pont-à-Mousson
java.util.concurrent.TimeoutException
	at java.base/jdk.internal.misc.ThreadFlock.awaitAll(ThreadFlock.java:362)
	at java.base/java.util.concurrent.StructuredTaskScope.implJoin(StructuredTaskScope.java:616)
	at java.base/java.util.concurrent.StructuredTaskScope.joinUntil(StructuredTaskScope.java:682)
	at fr.sciam.workshop.javase.structuredconcurrency.MainStructuredConcurrency.creerBulletinMeteo(MainStructuredConcurrency.java:53)
	at fr.sciam.workshop.javase.structuredconcurrency.MainStructuredConcurrency.main(MainStructuredConcurrency.java:29)</pre>
</div>
</div>
<div class="paragraph">
<p>Rétablir le timeout à 20 secondes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">scope</span><span class="o">.</span><span class="na">joinUntil</span><span class="o">(</span><span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusSeconds</span><span class="o">(</span><span class="mi">20</span><span class="o">));</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_la_classe_structuredtaskscope_shutdownonfailure"><a class="anchor" href="#_la_classe_structuredtaskscope_shutdownonfailure"></a>4.4.2.2. La classe <code>StructuredTaskScope.ShutdownOnFailure</code></h5>
<div class="paragraph">
<p>La classe <code>StructuredTaskScope.ShutdownOnFailure</code> qui hérite de <code>StructuredTaskScope</code> propose un modèle de type "invoke all" qui exécute toutes les sous-tâches et termine toutes les sous-tâches en cours si une sous-tâche lève une exception.</p>
</div>
<div class="paragraph">
<p>La méthode <code>throwIfFailed()</code> lève une exception de type <code>ExecutionException</code> si une sous-tâche ne se termine pas normalement.</p>
</div>
<div class="paragraph">
<p>Son invocation doit être précédée par l&#8217;invocation de la méthode <code>join()</code> ou <code>joinUntil()</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>throwIfFailed()</code> peut également lever deux types de <code>RuntimeException</code> : <code>WrongThreadException</code> et <code>IllegalStateException</code>, se référer à la javadoc pour plus de détails.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>creerBulletinMeteoShutdownOnFailure()</code> pour :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>utiliser le scope <code>ShutdownOnFailure</code> au lieu du <code>StructuredTaskScope</code> précédemment utilisé</p>
</li>
<li>
<p>réaliser l&#8217;attente via la méthode <code>joinUntil()</code> avec un timeout de 20 secondes</p>
</li>
<li>
<p>effectuer un appel à <code>throwIfFailed()</code> et afficher l&#8217;exception dans le bloc <code>catch</code> en cas d&#8217;erreur</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">creerBulletinMeteoShutdownOnFailure</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

    <span class="k">try</span> <span class="o">(</span><span class="nc">ShutdownOnFailure</span> <span class="n">scope</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ShutdownOnFailure</span><span class="o">())</span> <span class="o">{</span>

      <span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">nice</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoPrincipal</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">NICE</span><span class="o">));</span>
      <span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">paris</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoPrincipal</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">PARIS</span><span class="o">));</span>
      <span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">pontAMousson</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoPrincipal</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">PONT_A_MOUSSON</span><span class="o">));</span>
      <span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">toulon</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoPrincipal</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">TOULON</span><span class="o">));</span>

      <span class="n">scope</span><span class="o">.</span><span class="na">joinUntil</span><span class="o">(</span><span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusSeconds</span><span class="o">(</span><span class="mi">20</span><span class="o">));</span>
      <span class="n">scope</span><span class="o">.</span><span class="na">throwIfFailed</span><span class="o">();</span>

      <span class="n">serviceMeteoPrincipal</span><span class="o">.</span><span class="na">afficherBulletin</span><span class="o">(</span>
        <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
          <span class="nc">Villes</span><span class="o">.</span><span class="na">NICE</span><span class="o">,</span> <span class="n">nice</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span>
          <span class="nc">Villes</span><span class="o">.</span><span class="na">PARIS</span><span class="o">,</span> <span class="n">paris</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span>
          <span class="nc">Villes</span><span class="o">.</span><span class="na">PONT_A_MOUSSON</span><span class="o">,</span> <span class="n">pontAMousson</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span>
          <span class="nc">Villes</span><span class="o">.</span><span class="na">TOULON</span><span class="o">,</span> <span class="n">toulon</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>
        <span class="o">)</span>
      <span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TimeoutException</span> <span class="o">|</span> <span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainStructuredConcurrency</code> et vérifier que toutes les sous-tâches ont abouti et que l&#8217;on a pu exploiter les résultats.</p>
</div>
<div class="paragraph">
<p>Vérifier l&#8217;affichage dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Création du bulletin météo avec ShutdownOnFailure
Toulon : 17.0
Pont-à-Mousson : 13.0
Nice : 18.0
Paris : 16.0</pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Toujours dans la méthode <code>creerBulletinMeteoShutdownOnFailure()</code>, utiliser l&#8217;instance <code>serviceMeteoRestreint</code> en lieu et place de <code>serviceMeteoPrincipal</code>.
Cette implémentation lève une erreur lorsqu&#8217;une ville contient le caractère "-".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">nice</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoRestreint</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">NICE</span><span class="o">));</span>
<span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">paris</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoRestreint</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">PARIS</span><span class="o">));</span>
<span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">pontAMousson</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoRestreint</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">PONT_A_MOUSSON</span><span class="o">));</span>
<span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">toulon</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoRestreint</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">TOULON</span><span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainStructuredConcurrency</code> et constater que l&#8217;on obtient :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Création du bulletin météo avec ShutdownOnFailure
java.util.concurrent.ExecutionException: java.lang.IllegalArgumentException: ServiceMeteoRestreint : le service ne sait pas traiter les villes contenant un trait d'union : Pont-à-Mousson
[...]</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
La méthode <code>throwIfFailed()</code> possède une surcharge qui lève l&#8217;exception retournée par l&#8217;implémentation de la fonction <code>Function&lt;Throwable, ? extends X&gt;</code> passée en paramètre.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Toujours dans la méthode <code>creerBulletinMeteoShutdownOnFailure()</code>, faire appel à la méthode <code>throwIfFailed()</code> qui accepte une <code>Function</code> afin de lever une exception de type <code>ExceptionCustom</code>.</p>
</div>
<div class="listingblock">
<div class="title">Configuration de l&#8217;exception à lever</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">scope</span><span class="o">.</span><span class="na">throwIfFailed</span><span class="o">(</span><span class="nl">ExceptionCustom:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Gestion de l&#8217;exception</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TimeoutException</span> <span class="o">|</span> <span class="nc">ExceptionCustom</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainStructuredConcurrency</code> et constater que l&#8217;exception personnalisée est levée :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Création du bulletin météo avec ShutdownOnFailure
fr.sciam.workshop.javase.structuredconcurrency.ExceptionCustom: java.lang.IllegalArgumentException: ServiceMeteoRestreint : le service ne sait pas traiter les villes contenant un trait d'union : Pont-à-Mousson
[...]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_la_classe_structuredtaskscope_shutdownonsuccess"><a class="anchor" href="#_la_classe_structuredtaskscope_shutdownonsuccess"></a>4.4.2.3. La classe <code>StructuredTaskScope.ShutdownOnSuccess</code></h5>
<div class="paragraph">
<p>La classe <code>StructuredTaskScope.ShutdownOnSuccess</code> qui hérite de <code>StructuredTaskScope</code> propose un modèle de type "invoke any" qui renvoie le résultat de la première sous-tâche terminée et termine les autres sous-tâches restantes.</p>
</div>
<div class="paragraph">
<p>En cas de succès, la méthode <code>result()</code> permet d&#8217;obtenir le résultat de la première sous-tâche terminée. En cas d&#8217;échec, une exception est levée.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>obtenirTemperatureShutdownOnSuccess()</code> afin d&#8217;obtenir la température de la ville de Nice via <code>serviceMeteoPrincipal</code> et <code>serviceMeteoRestreint</code> en simultané, en renvoyant le premier des deux résultats ayant abouti.</p>
</div>
<div class="paragraph">
<p>Enfin, afficher les états des sous-tâches et le résultat obtenu.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">obtenirTemperatureShutdownOnSuccess</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

    <span class="k">try</span> <span class="o">(</span><span class="nc">ShutdownOnSuccess</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">scope</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ShutdownOnSuccess</span><span class="o">&lt;&gt;())</span> <span class="o">{</span>
      <span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoPrincipal</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">NICE</span><span class="o">));</span>
      <span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">restreint</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoRestreint</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">NICE</span><span class="o">));</span>

      <span class="n">scope</span><span class="o">.</span><span class="na">joinUntil</span><span class="o">(</span><span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusSeconds</span><span class="o">(</span><span class="mi">20</span><span class="o">));</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Principal "</span> <span class="o">+</span> <span class="n">principal</span><span class="o">.</span><span class="na">state</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Restreint "</span> <span class="o">+</span> <span class="n">restreint</span><span class="o">.</span><span class="na">state</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Temperature : "</span> <span class="o">+</span> <span class="n">scope</span><span class="o">.</span><span class="na">result</span><span class="o">());</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TimeoutException</span> <span class="o">|</span> <span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainStructuredConcurrency</code> et constater que l&#8217;appel via l&#8217;instance <code>serviceMeteoRestreint</code> a abouti en premier (elle n&#8217;a pas de délai contrairement à <code>serviceMeteoPrincipal</code>, dont l&#8217;appel a été interrompu).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Obtenir température avec ShutdownOnSuccess
Principal UNAVAILABLE
Restreint SUCCESS
Temperature : 18.0
ServiceMeteoPrincipal : interruption lors de l'obtention de la température de Nice</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Si une exception est levée dans une sous-tâche, mais qu&#8217;une autre sous-tâche parvient à obtenir le résultat, aucune exception n&#8217;est levée et le scope renvoie le résultat.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier à nouveau la méthode <code>obtenirTemperatureShutdownOnSuccess()</code> afin d&#8217;obtenir cette fois-ci la température de la ville de Pont-à-Mousson.</p>
</div>
<div class="paragraph">
<p>Enfin, afficher les états des sous-tâches et le résultat obtenu.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoPrincipal</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">PONT_A_MOUSSON</span><span class="o">));</span>
<span class="nc">Subtask</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">restreint</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoRestreint</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">PONT_A_MOUSSON</span><span class="o">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Constater que l&#8217;appel via l&#8217;instance <code>serviceMeteoRestreint</code> est en échec, mais que le résultat a pu être obtenu via l&#8217;instance <code>serviceMeteoPrincipal</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Obtenir température avec ShutdownOnSuccess
Principal SUCCESS
Restreint FAILED
Temperature : 13.0</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_les_scopes_personnalisés"><a class="anchor" href="#_les_scopes_personnalisés"></a>4.4.2.4. Les scopes personnalisés</h5>
<div class="paragraph">
<p>Il est possible de créer son propre scope en héritant de la classe <code>StructuredTaskScope</code> et en y implémentant ses propres règles métiers.</p>
</div>
<div class="paragraph">
<p>Basiquement, il faut :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Redéfinir la méthode <code>handleComplete()</code> qui est invoquée à la terminaison de chaque sous-tâche : en cas de succès, son implémentation stocke de manière thread-safe les informations obtenues de la <code>Subtask</code> passée en paramètre.</p>
</li>
<li>
<p>Définir une méthode pour fournir le résultat en appliquant les règles métiers adéquates et pour obtenir les éventuelles exceptions.</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier la classe <code>ScopePlusHauteTemperature</code> de manière à ce qu&#8217;elle renvoie la température la plus haute parmi les tâches qui lui ont été soumises.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dans la redéfinition de la méthode <code>handleComplete()</code>, se baser sur l&#8217;état renvoyé par la méthode <code>Subtask::state</code> pour gérer le résultat ou l&#8217;erreur</p>
</li>
<li>
<p><code>exceptions()</code> doit renvoyer une <code>Collection</code> contenant les exceptions rencontrées</p>
</li>
<li>
<p><code>max()</code> doit renvoyer la température la plus haute parmi celles obtenues</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">ScopePlusHauteTemperature</span> <span class="kd">extends</span> <span class="nc">StructuredTaskScope</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Double</span><span class="o">&gt;</span> <span class="n">temperatures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentLinkedQueue</span><span class="o">&lt;&gt;();</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Throwable</span><span class="o">&gt;</span> <span class="n">exceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentLinkedQueue</span><span class="o">&lt;&gt;();</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">handleComplete</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Subtask</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Double</span><span class="o">&gt;</span> <span class="n">subtask</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">subtask</span><span class="o">.</span><span class="na">state</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">case</span> <span class="no">SUCCESS</span> <span class="o">-&gt;</span> <span class="n">temperatures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">subtask</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
      <span class="k">case</span> <span class="no">FAILED</span> <span class="o">-&gt;</span> <span class="n">exceptions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">subtask</span><span class="o">.</span><span class="na">exception</span><span class="o">());</span>
      <span class="k">case</span> <span class="no">UNAVAILABLE</span> <span class="o">-&gt;</span> <span class="o">{}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Throwable</span><span class="o">&gt;</span> <span class="nf">exceptions</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">exceptions</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">double</span> <span class="nf">max</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">temperatures</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
      <span class="o">.</span><span class="na">mapToDouble</span><span class="o">(</span><span class="nl">Double:</span><span class="o">:</span><span class="n">doubleValue</span><span class="o">)</span>
      <span class="o">.</span><span class="na">max</span><span class="o">()</span>
      <span class="o">.</span><span class="na">orElseThrow</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Compléter la méthode <code>obtenirPlusHauteTemperature()</code> dans la classe <code>MainStructuredConcurrency</code> en utilisant <code>ScopePlusHauteTemperature</code> pour obtenir la température obtenue la plus élevée parmi les 4 villes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">obtenirPlusHauteTemperature</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

    <span class="k">try</span> <span class="o">(</span><span class="nc">ScopePlusHauteTemperature</span> <span class="n">scope</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ScopePlusHauteTemperature</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoRestreint</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">NICE</span><span class="o">));</span>
      <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoRestreint</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">PARIS</span><span class="o">));</span>
      <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoRestreint</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">PONT_A_MOUSSON</span><span class="o">));</span>
      <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">serviceMeteoRestreint</span><span class="o">.</span><span class="na">obtenirTemperature</span><span class="o">(</span><span class="nc">Villes</span><span class="o">.</span><span class="na">TOULON</span><span class="o">));</span>

      <span class="n">scope</span><span class="o">.</span><span class="na">joinUntil</span><span class="o">(</span><span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusSeconds</span><span class="o">(</span><span class="mi">20</span><span class="o">));</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Température la plus haute : "</span> <span class="o">+</span> <span class="n">scope</span><span class="o">.</span><span class="na">max</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Exceptions rencontrées : "</span> <span class="o">+</span> <span class="n">scope</span><span class="o">.</span><span class="na">exceptions</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">TimeoutException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainStructuredConcurrency</code> et vérifier le résultat affiché dans la console :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Obtenir plus haute température
Température la plus haute : 18.0
Exceptions rencontrées : [java.lang.IllegalArgumentException: ServiceMeteoRestreint : le service ne sait pas traiter les villes contenant un trait d'union : Pont-à-Mousson]</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lab_les_scoped_values"><a class="anchor" href="#_lab_les_scoped_values"></a>4.4.3. Lab : les Scoped Values</h4>
<div class="paragraph">
<p>Historiquement depuis Java 1.2, on utilise une variable de type <code>java.lang.ThreadLocal</code> pour partager des objets dans le code exécuté par un thread, évitant ainsi de les passer en paramètres des différentes méthodes invoquées.</p>
</div>
<div class="paragraph">
<p>Son utilisation est notoirement connue pour présenter plusieurs risques : les objets sont mutables, fuite de mémoire, consommation de ressources, …</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JDK</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Première preview en Java 21 <a href="https://openjdk.org/jeps/446">JEP 446</a><br>
Seconde preview en Java 22 <a href="https://openjdk.org/jeps/464">JEP 464</a><br>
Troisième preview en Java 23 <a href="https://openjdk.org/jeps/481">JEP 481</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>JEP</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://openjdk.org/jeps/487">487: Scoped Values (Fourth Preview)</a></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
En Java 24, cette fonctionnalité est <a href="deroulement.html#preview">en preview</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;API <code>java.lang.ScopedValue</code> tente de remédier à ces inconvénients.</p>
</div>
<div class="paragraph">
<p>Une <code>ScopedValue</code> est une valeur qui est définie une fois et qui est ensuite accessible en lecture uniquement pendant une période limitée d&#8217;exécution par des traitements dans un thread.</p>
</div>
<div class="paragraph">
<p>Une <code>ScopedValue</code> permet ainsi de partager des données de manière sûre et efficace pendant une période d&#8217;exécution limitée sans passer les données en paramètres des méthodes invoquées.</p>
</div>
<div class="sect4">
<h5 id="_la_création_dune_instance"><a class="anchor" href="#_la_création_dune_instance"></a>4.4.3.1. La création d&#8217;une instance</h5>
<div class="paragraph">
<p>La création d&#8217;une instance de type <code>java.lang.ScopedValue</code> est similaire à celle d&#8217;une instance de type <code>java.lang.ThreadLocal</code> : il faut définir une variable <code>public static final</code> pour faciliter son accès et l&#8217;initialiser avec l&#8217;invocation de la fabrique <code>ScopedValue::newinstance</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la classe <code>fr.sciam.workshop.javase.scopedvalues.Contexte</code> pour ajouter un champ <code>public static final NOM_UTILISATEUR</code> de type <code>ScopedValue&lt;String&gt;</code> initialisé avec l&#8217;invocation de <code>ScopedValue::newinstance</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">class</span> <span class="nc">Contexte</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ScopedValue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="no">NOM_UTILISATEUR</span> <span class="o">=</span> <span class="nc">ScopedValue</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lassociation_dune_valeur"><a class="anchor" href="#_lassociation_dune_valeur"></a>4.4.3.2. L&#8217;association d&#8217;une valeur</h5>
<div class="paragraph">
<p>La méthode <code>ScopedValue::where</code> permet d&#8217;obtenir une instance de type <code>java.lang.ScopedValue.Carrier</code> qui associe une <code>ScopedValue</code> à une valeur pour le thread actuel.</p>
</div>
<div class="paragraph">
<p>La classe <code>ScopedValue.Carrier</code> propose plusieurs méthodes pour associer une valeur à une autre <code>ScopedValue</code> et pour exécuter des traitements qui pourront accéder aux <code>ScopedValue</code> dans le thread actuel sans avoir à les passer en paramètres des différentes méthodes utilisées :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;T&gt; ScopedValue.Carrier where(ScopedValue&lt;T&gt; key, T value)</code> : renvoyer une nouvelle instance qui associe en plus la <code>ScopedValue</code> à la valeur</p>
</li>
<li>
<p><code>&lt;R, X extends Throwable&gt; R call(ScopedValue.CallableOp&lt;? extends R, X&gt; op)</code> : exécuter le <code>CallableOp</code> qui aura accès aux <code>ScopedValue</code> définies pour le thread courant</p>
</li>
<li>
<p><code>void run(Runnable op)</code> : exécuter le <code>Runnable</code> qui aura accès aux <code>ScopedValue</code> définies pour le thread courant</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>associerValeur()</code> de la classe <code>MainScopedValues</code> pour :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>exécuter la méthode <code>MonService::executer</code> via la <code>ScopedValue</code> <code>NOM_UTILISATEUR</code>  qui associe la valeur <code>admin-main</code> au thread courant</p>
</li>
<li>
<p>démarrer un thread virtuel qui associe la valeur <code>admin-virtuel</code> à la <code>ScopedValue</code> <code>NOM_UTILISATEUR</code> pour exécuter la méthode <code>MonService::executer</code></p>
</li>
<li>
<p>attendre la fin de l&#8217;exécution du thread</p>
</li>
<li>
<p>démarrer un thread de la plateforme nommé <code>Tache1</code> qui associe la valeur <code>admin-plateforme</code> à la <code>ScopedValue</code> <code>NOM_UTILISATEUR</code> pour exécuter la méthode <code>MonService::executer</code></p>
</li>
<li>
<p>attendre la fin de l&#8217;exécution du thread</p>
</li>
<li>
<p>exécuter la méthode <code>MonService::executer</code></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Une tâche est exécutée dans un thread virtuel, cette fonctionnalité est détaillée dans le lab <a href="_les_évolutions_dans_les_api.html#threads-virtuels">les threads virtuels</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">associerValeur</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

    <span class="nc">ScopedValue</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="nc">Contexte</span><span class="o">.</span><span class="na">NOM_UTILISATEUR</span><span class="o">,</span> <span class="s">"admin-main"</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="nl">MonService:</span><span class="o">:</span><span class="n">executer</span><span class="o">);</span>

    <span class="kt">var</span> <span class="n">tache1</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">ofVirtual</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"Tache1"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">start</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">ScopedValue</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="nc">Contexte</span><span class="o">.</span><span class="na">NOM_UTILISATEUR</span><span class="o">,</span> <span class="s">"admin-virtuel"</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="nl">MonService:</span><span class="o">:</span><span class="n">executer</span><span class="o">));</span>
    <span class="n">tache1</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">1L</span><span class="o">));</span>

    <span class="kt">var</span> <span class="n">tache2</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">ofPlatform</span><span class="o">().</span><span class="na">name</span><span class="o">(</span><span class="s">"Tache2"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">start</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">ScopedValue</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="nc">Contexte</span><span class="o">.</span><span class="na">NOM_UTILISATEUR</span><span class="o">,</span> <span class="s">"admin-plateforme"</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="nl">MonService:</span><span class="o">:</span><span class="n">executer</span><span class="o">));</span>
    <span class="n">tache2</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">1L</span><span class="o">));</span>
  <span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Pour obtenir une valeur associée au thread courant, il faut utiliser la méthode <code>ScopedValue::get</code>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>executer()</code> de la classe <code>MonService</code> pour obtenir la valeur de <code>NOM_UTILISATEUR</code> en invoquant sa méthode <code>get()</code> et afficher le thread courant et la valeur obtenue.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">static</span> <span class="kt">int</span> <span class="nf">executer</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">nomUtilisateur</span> <span class="o">=</span> <span class="nc">Contexte</span><span class="o">.</span><span class="na">NOM_UTILISATEUR</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">" Monservice utilisateur : "</span> <span class="o">+</span> <span class="n">nomUtilisateur</span><span class="o">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainScopedValues</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Associer une valeur à un traitement
Thread[#3,main,5,main] Monservice utilisateur : admin-main
VirtualThread[#36,Tache1]/runnable@ForkJoinPool-1-worker-1 Monservice utilisateur : admin-virtuel
Thread[#39,Tache2,5,main] Monservice utilisateur : admin-plateforme</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>La valeur est associée pendant la durée d&#8217;exécution des traitements associés. Une fois l&#8217;exécution terminée, la valeur n&#8217;est plus accessible.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>associerValeur()</code> de la classe <code>MainScopedValues</code> pour ajouter à la fin l&#8217;invocation de la méthode <code>MonService::executer</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="nc">MonService</span><span class="o">.</span><span class="na">executer</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainScopedValues</code> pour vérifier la levée d&#8217;une exception car la valeur n&#8217;est pas associée dans le thread courant.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Associer une valeur à un traitement
Thread[#3,main,5,main] Monservice utilisateur : admin-main
VirtualThread[#36,Tache1]/runnable@ForkJoinPool-1-worker-1 Monservice utilisateur : admin-virtuel
Thread[#39,Tache2,5,main] Monservice utilisateur : admin-plateforme
Exception in thread "main" java.util.NoSuchElementException: ScopedValue not bound
        at java.base/java.lang.ScopedValue.slowGet(ScopedValue.java:575)
        at java.base/java.lang.ScopedValue.get(ScopedValue.java:568)
        at fr.sciam.workshop.javase.scopedvalues.MonService.executer(MainScopedValues.java:117)
        at fr.sciam.workshop.javase.scopedvalues.MainScopedValues.associerValeur(MainScopedValues.java:48)
        at fr.sciam.workshop.javase.scopedvalues.MainScopedValues.main(MainScopedValues.java:13)</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Il est possible d&#8217;utiliser la méthode <code>ScopedValue::isBound</code> qui renvoie un booléen indiquant si une valeur est associée au thread courant.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Modifier la méthode <code>executer()</code> de la classe <code>MonService</code> pour obtenir la valeur de <code>NOM_UTILISATEUR</code> en invoquant sa méthode <code>get()</code> si elle est associée ou <code>"Inconnu"</code> dans le cas contraire.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">static</span> <span class="kt">int</span> <span class="nf">executer</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">nomUtilisateur</span> <span class="o">=</span> <span class="nc">Contexte</span><span class="o">.</span><span class="na">NOM_UTILISATEUR</span><span class="o">.</span><span class="na">isBound</span><span class="o">()</span> <span class="o">?</span> <span class="nc">Contexte</span><span class="o">.</span><span class="na">NOM_UTILISATEUR</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">:</span> <span class="s">"Inconnu"</span><span class="o">;</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">" Monservice utilisateur : "</span> <span class="o">+</span> <span class="n">nomUtilisateur</span><span class="o">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainScopedValues</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Associer une valeur à un traitement
Thread[#1,main,5,main] Monservice utilisateur : admin-main
VirtualThread[#29,Tache1]/runnable@ForkJoinPool-1-worker-1 Monservice utilisateur : admin-virtuel
Thread[#32,Tache2,5,main] Monservice utilisateur : admin-plateforme
Thread[#1,main,5,main] Monservice utilisateur : Inconnu</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_la_réassociation_dune_valeur"><a class="anchor" href="#_la_réassociation_dune_valeur"></a>4.4.3.3. La réassociation d&#8217;une valeur</h5>
<div class="paragraph">
<p>Les valeurs associées sont immutables mais il est possible de réassocier une autre valeur pour un traitement sous-jacent exécuté avec la <code>ScopedValue</code> où une valeur différente est associée.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>reassocierValeur()</code> de la classe <code>MainScopedValues</code> pour lancer un thread nommé <code>Tache3</code> qui associe la valeur <code>admin</code> à la <code>ScopedValue</code> <code>NOM_UTILISATEUR</code> pour exécuter les traitements suivants :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>invoquer la méthode <code>MonService::executer</code></p>
</li>
<li>
<p>lancer un thread nommé <code>Tache4</code> qui associe la valeur <code>admin-rebind</code> à la <code>ScopedValue</code> <code>NOM_UTILISATEUR</code> pour exécuter la méthode <code>MonService::executer</code></p>
</li>
<li>
<p>attendre la fin du thread <code>Tache4</code></p>
</li>
<li>
<p>invoquer la méthode <code>MonService::executer</code></p>
</li>
<li>
<p>attendre la fin du thread <code>Tache3</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">reassocierValeur</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

    <span class="kt">var</span> <span class="n">tache3</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">ofPlatform</span><span class="o">()</span>
        <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"Tache3"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">start</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">ScopedValue</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="nc">Contexte</span><span class="o">.</span><span class="na">NOM_UTILISATEUR</span><span class="o">,</span> <span class="s">"admin"</span><span class="o">).</span><span class="na">run</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="nc">MonService</span><span class="o">.</span><span class="na">executer</span><span class="o">();</span>

          <span class="kt">var</span> <span class="n">tache4</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">ofPlatform</span><span class="o">()</span>
              <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"Tache4"</span><span class="o">)</span>
              <span class="o">.</span><span class="na">start</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">ScopedValue</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="nc">Contexte</span><span class="o">.</span><span class="na">NOM_UTILISATEUR</span><span class="o">,</span> <span class="s">"admin-rebind"</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nl">MonService:</span><span class="o">:</span><span class="n">executer</span><span class="o">));</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="n">tache4</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">);</span>
          <span class="o">}</span>

          <span class="nc">MonService</span><span class="o">.</span><span class="na">executer</span><span class="o">();</span>
        <span class="o">}));</span>
    <span class="n">tache3</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainScopedValues</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Reassocier une valeur à un traitement
Thread[#33,Tache3,5,main] Monservice utilisateur : admin
Thread[#34,Tache4,5,main] Monservice utilisateur : admin-rebind
Thread[#33,Tache3,5,main] Monservice utilisateur : admin</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_lassociation_de_plusieurs_valeurs"><a class="anchor" href="#_lassociation_de_plusieurs_valeurs"></a>4.4.3.4. L&#8217;association de plusieurs valeurs</h5>
<div class="paragraph">
<p>La méthode <code>ScopedValue::where</code> retourne une instance de type <code>ScopedValue.Carrier</code> qui permet au travers de sa méthode <code>where()</code> d&#8217;associer une valeur à une autre <code>ScopedValue</code> et ses méthodes <code>run()</code> ou <code>call()</code> de préciser le traitement à exécuter.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br></p>
</div>
<div class="paragraph">
<p>Compléter la classe <code>Contexte</code> pour ajout un champ <code>public static final ID_UTILISATEUR</code> de type <code>ScopedValue&lt;Long&gt;</code> initialisé avec l&#8217;invocation de <code>ScopedValue::newInstance</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ScopedValue</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="no">ID_UTILISATEUR</span> <span class="o">=</span> <span class="nc">ScopedValue</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Compléter la méthode <code>associerPlusieursValeurs()</code> de la classe <code>MainScopedValues</code> pour exécuter la méthode <code>MonService::executer</code> dans le thread courant via la <code>ScopedValue</code> <code>NOM_UTILISATEUR</code> qui associe la valeur <code>admin-main</code> et la <code>ScopedValue</code> <code>ID_UTILISATEUR</code> qui associe la valeur <code>12345</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">associerPlusieursValeurs</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

    <span class="nc">ScopedValue</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="nc">Contexte</span><span class="o">.</span><span class="na">NOM_UTILISATEUR</span><span class="o">,</span> <span class="s">"admin-main"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="nc">Contexte</span><span class="o">.</span><span class="na">ID_UTILISATEUR</span><span class="o">,</span> <span class="mi">12345L</span><span class="o">)</span>
        <span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="nl">MonService:</span><span class="o">:</span><span class="n">traiter</span><span class="o">);</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Compléter la méthode <code>traiter()</code> de la classe <code>MonService</code> pour obtenir les valeurs de <code>NOM_UTILISATEUR</code> et de <code>ID_UTILISATEUR</code> en invoquant leur méthode <code>get()</code> et afficher le thread courant et les valeurs obtenues.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">static</span> <span class="kt">int</span> <span class="nf">traiter</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">nomUtilisateur</span> <span class="o">=</span> <span class="nc">Contexte</span><span class="o">.</span><span class="na">NOM_UTILISATEUR</span><span class="o">.</span><span class="na">isBound</span><span class="o">()</span> <span class="o">?</span> <span class="nc">Contexte</span><span class="o">.</span><span class="na">NOM_UTILISATEUR</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">:</span> <span class="s">"Inconnu"</span><span class="o">;</span>
    <span class="nc">Long</span> <span class="n">idUtilisateur</span> <span class="o">=</span> <span class="nc">Contexte</span><span class="o">.</span><span class="na">ID_UTILISATEUR</span><span class="o">.</span><span class="na">isBound</span><span class="o">()</span> <span class="o">?</span> <span class="nc">Contexte</span><span class="o">.</span><span class="na">ID_UTILISATEUR</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1L</span><span class="o">;</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">+</span> <span class="s">" Monservice utilisateur : "</span> <span class="o">+</span> <span class="n">nomUtilisateur</span> <span class="o">+</span> <span class="s">" (id="</span> <span class="o">+</span> <span class="n">idUtilisateur</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainScopedValues</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Associer plusieurs valeurs à un traitement
Thread[#1,main,5,main] Monservice utilisateur : admin-main (id=12345)</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_le_partage_de_valeurs_dans_les_threads_virtuels_dune_stucturedtaskscope"><a class="anchor" href="#_le_partage_de_valeurs_dans_les_threads_virtuels_dune_stucturedtaskscope"></a>4.4.3.5. Le partage de valeurs dans les threads virtuels d&#8217;une StucturedTaskScope</h5>
<div class="paragraph">
<p>Une valeur d&#8217;une <code>ScopedValue</code> n&#8217;est associée qu&#8217;au thread dans lequel elle est définie.</p>
</div>
<div class="paragraph">
<p>Il y a une exception concernant le partage d&#8217;une valeur d&#8217;une <code>ScopedValue</code> avec les threads virtuels d&#8217;une <code>StucturedTaskScope</code>. Pour cela, il faut définir les traitements d&#8217;une <code>StructuredTaskScope</code> dans ceux exécutés par une <code>ScopedValue</code>. Tous les threads virtuels auront alors accès à la valeur associée dans la <code>ScopedValue</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Cette fonctionnalité est détaillée dans le lab <a href="_les_évolutions_dans_les_api.html#structured-concurrency">la Structured Concurrency</a>
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><span class="icon blue"><i class="fa fa-keyboard-o fa-2x"></i></span><br>
Compléter la méthode <code>associerValeurConcurrenceStructuree()</code> de la classe <code>MainScopedValues</code> pour :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>itérer sur une collection de utilisateurs et pour chacun :</p>
<div class="ulist">
<ul>
<li>
<p>associer l&#8217;utilisateur à la <code>ScopedValue</code> <code>NOM_UTILISATEUR</code> pour exécuter l&#8217;invocation trois fois de la méthode <code>MonService::executer</code> dans une <code>StucturedTaskScope.ShutdownOnFailure</code>.</p>
</li>
<li>
<p>attendre la fin de l&#8217;exécution des threads</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">associerValeurConcurrenceStructuree</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">utilisateurs</span> <span class="o">=</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"utilisateur1"</span><span class="o">,</span> <span class="s">"utilisateur2"</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">utilisateur</span> <span class="o">:</span> <span class="n">utilisateurs</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ScopedValue</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="nc">Contexte</span><span class="o">.</span><span class="na">NOM_UTILISATEUR</span><span class="o">,</span> <span class="n">utilisateur</span><span class="o">)</span>
          <span class="o">.</span><span class="na">run</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">(</span><span class="kt">var</span> <span class="n">scope</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StructuredTaskScope</span><span class="o">.</span><span class="na">ShutdownOnFailure</span><span class="o">())</span> <span class="o">{</span>
              <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(</span><span class="nl">MonService:</span><span class="o">:</span><span class="n">executer</span><span class="o">);</span>
              <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(</span><span class="nl">MonService:</span><span class="o">:</span><span class="n">executer</span><span class="o">);</span>
              <span class="n">scope</span><span class="o">.</span><span class="na">fork</span><span class="o">(</span><span class="nl">MonService:</span><span class="o">:</span><span class="n">executer</span><span class="o">);</span>
              <span class="k">try</span> <span class="o">{</span>
                <span class="n">scope</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
              <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
              <span class="o">}</span>
            <span class="o">}</span>
          <span class="o">});</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exécuter la classe <code>MainScopedValues</code> pour vérifier l&#8217;affichage.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Associer une valeur à un StructuredTaskScope
VirtualThread[#35]/runnable@ForkJoinPool-1-worker-1 Monservice utilisateur : utilisateur1
VirtualThread[#36]/runnable@ForkJoinPool-1-worker-2 Monservice utilisateur : utilisateur1
VirtualThread[#37]/runnable@ForkJoinPool-1-worker-2 Monservice utilisateur : utilisateur1
VirtualThread[#38]/runnable@ForkJoinPool-1-worker-2 Monservice utilisateur : utilisateur2
VirtualThread[#40]/runnable@ForkJoinPool-1-worker-3 Monservice utilisateur : utilisateur2
VirtualThread[#39]/runnable@ForkJoinPool-1-worker-1 Monservice utilisateur : utilisateur2</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>&nbsp;</p>
</div>
<div class="paragraph">
<p>&nbsp;</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>← : <a href="deroulement.html">Le déroulement du workshop</a> | ↑ : <a href="index.html">Workshop Java SE en 2025 : les nouvelles API</a> | : <a href="conclusion.html">Conclusion</a> →</p>
</div>
</div>
<div id="footer">
    <p class="footer-text" >
        © 2025 Clément de Tastes et J.M. Doudoux | Licence Creative Commons BY-NC-ND 4.0 DEED
        <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.fr" target="_blank">
            <img src="images/by-nc-nd.png" width="100" alt="CC BY NC ND">
        </a>
    </p>
</div>
</body>
</html>